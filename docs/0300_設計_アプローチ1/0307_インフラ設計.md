# ImageFlowCanvas ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆæ›¸

## **æ–‡æ›¸ç®¡ç†æƒ…å ±**

| é …ç›®       | å†…å®¹                           |
| ---------- | ------------------------------ |
| æ–‡æ›¸å     | ImageFlowCanvas ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆæ›¸ |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 1.0                            |
| ä½œæˆæ—¥     | 2025å¹´7æœˆ12æ—¥                  |
| æ›´æ–°æ—¥     | 2025å¹´7æœˆ12æ—¥                  |


---

## **8. ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆ**

### **8.0. ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°å ´æ‰€ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥**

#### **8.0.1. VM0: ã‚¨ãƒƒã‚¸ãƒ»ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚µãƒ¼ãƒãƒ¼ (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å±¤)**

| ğŸ”§ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ  | ğŸ“ æ¨å¥¨ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°å ´æ‰€                                                   | âš™ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•                        | ğŸ¯ ç”¨é€”ãƒ»ç‰¹å¾´                                                  |
| :---------------- | :----------------------------------------------------------------------- | :------------------------------------ | :------------------------------------------------------------ |
| **ğŸšª API Gateway** | AWS ALB/CloudFlare<br/>ã¾ãŸã¯<br/>ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ nginx                     | Docker Compose<br/>Kubernetes Ingress | â€¢ SSLçµ‚ç«¯ãƒ»èªè¨¼<br/>â€¢ è² è·åˆ†æ•£<br/>â€¢ ãƒ¬ãƒ¼ãƒˆåˆ¶é™               |
| **ğŸ”§ Backend API** | AWS ECS/GKE<br/>ã¾ãŸã¯<br/>ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ Docker                           | FastAPI Container                     | â€¢ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯<br/>â€¢ Kafka Producer<br/>â€¢ WebSocketç®¡ç†   |
| **ğŸŒ Web UI**      | AWS S3+CloudFront<br/>Azure Static Web Apps<br/>ã¾ãŸã¯<br/>nginxé™çš„é…ä¿¡ | React Build<br/>CDNé…ä¿¡               | â€¢ SPA (Single Page App)<br/>â€¢ é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡<br/>â€¢ ç®¡ç†ç”»é¢ |

#### **8.0.2. VM1: å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°å±¤)**

| ğŸ”§ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ    | ğŸ“ æ¨å¥¨ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°å ´æ‰€                           | âš™ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•                      | ğŸ¯ ç”¨é€”ãƒ»ç‰¹å¾´                                                         |
| :------------------ | :----------------------------------------------- | :---------------------------------- | :------------------------------------------------------------------- |
| **ğŸ“¨ Apache Kafka**  | å°‚ç”¨ç‰©ç†ã‚µãƒ¼ãƒãƒ¼<br/>AWS MSK<br/>Confluent Cloud | Kafka Cluster<br/>(3ãƒãƒ¼ãƒ‰æ§‹æˆæ¨å¥¨) | â€¢ é«˜ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ<br/>â€¢ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ°¸ç¶šåŒ–<br/>â€¢ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ä¸¦åˆ—å‡¦ç† |
| **ğŸ”— Kafka Connect** | KafkaåŒå±…ã‚µãƒ¼ãƒãƒ¼                                | Docker Container                    | â€¢ MinIOé€£æº<br/>â€¢ ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†<br/>â€¢ ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³            |

#### **8.0.3. VM2: é«˜æ€§èƒ½ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ (å‡¦ç†å®Ÿè¡Œå±¤)**

| ğŸ”§ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ         | ğŸ“ æ¨å¥¨ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°å ´æ‰€                                       | âš™ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•        | ğŸ¯ ç”¨é€”ãƒ»ç‰¹å¾´                                                     |
| :----------------------- | :----------------------------------------------------------- | :-------------------- | :--------------------------------------------------------------- |
| **â˜¸ï¸ K3s Cluster**        | GPUæ­è¼‰ç‰©ç†ã‚µãƒ¼ãƒãƒ¼<br/>AWS EC2 G4/P3<br/>GCP Compute Engine | K3s Multi-node        | â€¢ GPU/CPUæ··åœ¨ç’°å¢ƒ<br/>â€¢ è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°<br/>â€¢ ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡åŒ–    |
| **âš¡ gRPCå¸¸é§ã‚µãƒ¼ãƒ“ã‚¹ç¾¤** | K3så†…éƒ¨                                                      | Kubernetes Deployment | â€¢ ç›´æ¥gRPCå‘¼ã³å‡ºã—<br/>â€¢ è¶…é«˜é€Ÿå‡¦ç†<br/>â€¢ å‹•çš„ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åˆ¶å¾¡   |
| **ğŸ’¾ MinIO**              | é«˜é€ŸSSD/NVMeã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸                                       | K3s StatefulSet       | â€¢ ç”»åƒãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–<br/>â€¢ S3äº’æ›API<br/>â€¢ é«˜IOPSã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸        |
| **ğŸ³ å‡¦ç†Podç¾¤**          | GPU/CPUãƒãƒ¼ãƒ‰                                                | Kubernetes Deployment | â€¢ ç”»åƒå‡¦ç†å®Ÿè¡Œ<br/>â€¢ å‹•çš„ãƒªã‚½ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦<br/>â€¢ æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° |

#### **8.0.4. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**

```mermaid
graph TD
    Internet["ğŸŒ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ"]
    
    subgraph CloudEdge["â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰/ã‚¨ãƒƒã‚¸ (VM0)"]
        LB["âš–ï¸ ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼<br/>â€¢ SSLçµ‚ç«¯<br/>â€¢ DDoSä¿è­·"]
        WAF["ğŸ›¡ï¸ WAF<br/>â€¢ Web Application Firewall"]
        APIGWHost["ğŸšª API Gateway<br/>â€¢ èªè¨¼ãƒ»èªå¯<br/>â€¢ ãƒ¬ãƒ¼ãƒˆåˆ¶é™"]
        BackendHost["ğŸ”§ Backend API<br/>â€¢ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†"]
        WebUIHost["ğŸŒ Web UI<br/>â€¢ é™çš„é…ä¿¡ãƒ»CDN"]
    end
    
    subgraph PrivateNetwork["ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"]
        subgraph MessageLayer["VM1: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°å±¤"]
            KafkaHost["ğŸ“¨ Kafka Cluster<br/>â€¢ 3ãƒãƒ¼ãƒ‰æ§‹æˆ<br/>â€¢ ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"]
        end
        
        subgraph ProcessingLayer["VM2: å‡¦ç†å®Ÿè¡Œå±¤"]
            K3sHost["â˜¸ï¸ K3s Cluster<br/>â€¢ ãƒã‚¹ã‚¿ãƒ¼ + ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ‰<br/>â€¢ GPU/CPUæ··åœ¨"]
        end
    end
    
    Internet --> LB
    LB --> WAF
    WAF --> APIGWHost
    APIGWHost --> BackendHost
    APIGWHost --> WebUIHost
    
    BackendHost -.->|"VPN/å°‚ç”¨ç·š"| KafkaHost
    KafkaHost -.->|"å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯"| K3sHost
```

#### **8.0.5. ãƒªã‚½ãƒ¼ã‚¹è¦ä»¶ã¨æ¨å¥¨ã‚¹ãƒšãƒƒã‚¯**

| ğŸ–¥ï¸ ã‚µãƒ¼ãƒãƒ¼       | ğŸ’» æ¨å¥¨ã‚¹ãƒšãƒƒã‚¯        | ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | ğŸ’° æ¨å®šã‚³ã‚¹ãƒˆ/æœˆ |
| :--------------- | :-------------------- | :----------- | :------------- | :-------------- |
| **VM0 (ã‚¨ãƒƒã‚¸)** | 4vCPU, 8GB RAM        | 100GB SSD    | 1Gbps          | $100-200        |
| **VM1 (Kafka)**  | 8vCPU, 16GB RAM       | 500GB SSD    | 10Gbps         | $200-400        |
| **VM2 (K3s)**    | 16vCPU, 64GB RAM, GPU | 1TB NVMe SSD | 10Gbps         | $800-1500       |

#### **8.0.6. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥**

1. **æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤**: VM0 â†’ VM1 â†’ VM2ã®é †åºã§ãƒ‡ãƒ—ãƒ­ã‚¤
2. **Blue-Green ãƒ‡ãƒ—ãƒ­ã‚¤**: æœ¬ç•ªç’°å¢ƒã§ã®ã‚¼ãƒ­ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ æ›´æ–°
3. **ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹**: æ–°æ©Ÿèƒ½ã®æ®µéšçš„å±•é–‹
4. **GitOps**: Git ãƒªãƒã‚¸ãƒˆãƒªã‚’çœŸå®Ÿã®æºã¨ã—ãŸè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

### **8.1. Kubernetesã‚¯ãƒ©ã‚¹ã‚¿è¨­è¨ˆ**

#### **8.1.1. ã‚¯ãƒ©ã‚¹ã‚¿æ§‹æˆ**

```yaml
# K3s ã‚¯ãƒ©ã‚¹ã‚¿æ§‹æˆ
cluster:
  name: imageflow-k3s
  version: v1.28.9+k3s1
  
  master_nodes:
    - name: k3s-master-01
      ip: 10.0.1.10
      resources:
        cpu: 4
        memory: 8Gi
        storage: 100Gi
  
  worker_nodes:
    - name: k3s-worker-01
      ip: 10.0.1.11
      resources:
        cpu: 8
        memory: 16Gi
        storage: 500Gi
      labels:
        node-type: cpu-intensive
        
    - name: k3s-worker-02
      ip: 10.0.1.12
      resources:
        cpu: 8
        memory: 32Gi
        gpu: 1
        storage: 1Ti
      labels:
        node-type: gpu-enabled
        
    - name: k3s-worker-03
      ip: 10.0.1.13
      resources:
        cpu: 4
        memory: 8Gi
        storage: 2Ti
      labels:
        node-type: storage-optimized
```

#### **8.1.2. Namespaceè¨­è¨ˆ**

```yaml
# Namespaceæ§‹æˆ
namespaces:
  - name: imageflow-web
    purpose: Web UI, API Gateway
    
  - name: imageflow-backend
    purpose: Backend API Services
    
  - name: imageflow-processing
    purpose: gRPC Processing Services
    
  - name: imageflow-storage
    purpose: MinIO, Database
    
  - name: imageflow-monitoring
    purpose: Prometheus, Grafana
```

#### **8.1.3. OpenTelemetryã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆ**

##### **8.1.3.1. OpenTelemetry Collector DaemonSet**

```yaml
# OpenTelemetry Collector DaemonSet
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: otel-agent
  namespace: imageflow-observability
spec:
  selector:
    matchLabels:
      app: otel-agent
  template:
    metadata:
      labels:
        app: otel-agent
    spec:
      serviceAccount: otel-agent
      containers:
      - name: otel-agent
        image: otel/opentelemetry-collector-contrib:0.97.0
        args:
          - --config=/etc/otelcol-contrib/config.yaml
        volumeMounts:
        - name: config
          mountPath: /etc/otelcol-contrib
        - name: varlog
          mountPath: /var/log
          readOnly: true
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        env:
        - name: KUBE_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: KUBE_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: KUBE_POD_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        - name: KUBE_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        resources:
          requests:
            memory: 100Mi
            cpu: 100m
          limits:
            memory: 200Mi
            cpu: 200m
        ports:
        - containerPort: 4317  # OTLP gRPC
        - containerPort: 4318  # OTLP HTTP
        - containerPort: 8888  # Prometheus metrics
      volumes:
      - name: config
        configMap:
          name: otel-agent-config
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
```

##### **8.1.3.2. Grafana Tempoè¨­å®š**

```yaml
# Grafana Tempo for distributed tracing
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: tempo
  namespace: imageflow-observability
spec:
  serviceName: tempo
  replicas: 1
  selector:
    matchLabels:
      app: tempo
  template:
    metadata:
      labels:
        app: tempo
    spec:
      containers:
      - name: tempo
        image: grafana/tempo:2.4.0
        args:
          - -config.file=/etc/tempo/tempo.yaml
          - -mem-ballast-size-mbs=1024
        volumeMounts:
        - name: config
          mountPath: /etc/tempo
        - name: data
          mountPath: /var/tempo
        env:
        - name: TEMPO_STORAGE_TRACE_BACKEND
          value: "local"
        - name: TEMPO_STORAGE_TRACE_LOCAL_PATH
          value: "/var/tempo"
        resources:
          requests:
            memory: 1Gi
            cpu: 500m
          limits:
            memory: 2Gi
            cpu: 1000m
        ports:
        - containerPort: 3200  # HTTP
        - containerPort: 4317  # OTLP gRPC
        - containerPort: 14250 # Jaeger gRPC
      volumes:
      - name: config
        configMap:
          name: tempo-config
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
```

### **8.2. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­è¨ˆ**

#### **8.2.1. MinIOè¨­å®š**

```yaml
# MinIOåˆ†æ•£æ§‹æˆ
apiVersion: v1
kind: ConfigMap
metadata:
  name: minio-config
  namespace: imageflow-storage
data:
  # åˆ†æ•£æ§‹æˆï¼ˆ4ãƒãƒ¼ãƒ‰ï¼‰
  MINIO_DISTRIBUTED_MODE: "true"
  MINIO_DISTRIBUTED_NODES: "4"
  
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  MINIO_REGION: "us-east-1"
  MINIO_BROWSER: "on"
  MINIO_DOMAIN: "minio.imageflow.local"
  
  # ãƒã‚±ãƒƒãƒˆè¨­å®š
  MINIO_DEFAULT_BUCKETS: |
    raw-images:rw
    processed-images:rw
    system-logs:r
```

#### **8.2.2. æ°¸ç¶šãƒœãƒªãƒ¥ãƒ¼ãƒ è¨­è¨ˆ**

```yaml
# StorageClasså®šç¾©
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
parameters:
  type: ssd
  iops: "3000"

---
# é«˜æ€§èƒ½ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç”¨PV
apiVersion: v1
kind: PersistentVolume
metadata:
  name: minio-data-01
spec:
  capacity:
    storage: 1Ti
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: fast-ssd
  hostPath:
    path: /data/minio/01
```

### **8.3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­è¨ˆ**

#### **8.3.1. Service Meshï¼ˆIstioï¼‰**

```yaml
# Istio VirtualService
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: imageflow-api
  namespace: imageflow-backend
spec:
  hosts:
  - api.imageflow.com
  gateways:
  - imageflow-gateway
  http:
  - match:
    - uri:
        prefix: /v1/
    route:
    - destination:
        host: backend-api
        port:
          number: 8000
    fault:
      delay:
        percentage:
          value: 0.1
        fixedDelay: 5s
    retries:
      attempts: 3
      perTryTimeout: 10s
```

#### **8.3.2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒªã‚·ãƒ¼**

```yaml
# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†é›¢
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: processing-isolation
  namespace: imageflow-processing
spec:
  podSelector:
    matchLabels:
      tier: processing
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: imageflow-backend
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: imageflow-storage
    ports:
    - protocol: TCP
      port: 9000  # MinIO
```

---

## **é–¢é€£æ–‡æ›¸**

- [æ¦‚è¦è¨­è¨ˆ](./0300_æ¦‚è¦è¨­è¨ˆ.md)
- [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](./0302_ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ.md)
- [é‹ç”¨ãƒ»ç›£è¦–è¨­è¨ˆ](./0308_é‹ç”¨ç›£è¦–è¨­è¨ˆ.md)
