# ImageFlowCanvas セキュリティ設計書

## **文書管理情報**

| 項目       | 内容                               |
| ---------- | ---------------------------------- |
| 文書名     | ImageFlowCanvas セキュリティ設計書 |
| バージョン | 1.1                                |
| 作成日     | 2025年7月12日                      |
| 更新日     | 2025年8月13日                      |


---

## **7. セキュリティ設計**

### **7.1. 認証・認可**

#### **7.1.1. 認証方式**

```mermaid
sequenceDiagram
    participant User
    participant WebUI
    participant AuthService
    participant Backend
    
    User->>WebUI: ログイン要求
    WebUI->>AuthService: 認証情報送信
    AuthService->>AuthService: 認証処理
    AuthService->>WebUI: JWT Token返却
    WebUI->>WebUI: Token保存
    WebUI->>Backend: API要求 + Token
    Backend->>Backend: Token検証
    Backend->>WebUI: API応答
```

#### **7.1.2. 認可制御（RBAC）**

```sql
-- ロール定義
CREATE TABLE roles (
    id UUID PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT
);

-- ユーザーロール関連
CREATE TABLE user_roles (
    user_id UUID REFERENCES users(id),
    role_id UUID REFERENCES roles(id),
    granted_at TIMESTAMP DEFAULT NOW(),
    granted_by UUID REFERENCES users(id),
    PRIMARY KEY (user_id, role_id)
);

-- 権限定義
CREATE TABLE permissions (
    id UUID PRIMARY KEY,
    resource VARCHAR(100) NOT NULL,  -- pipeline, component, execution
    action VARCHAR(50) NOT NULL,     -- create, read, update, delete, execute
    condition JSONB                  -- 条件（自分が作成したもののみ等）
);

-- ロール権限関連
CREATE TABLE role_permissions (
    role_id UUID REFERENCES roles(id),
    permission_id UUID REFERENCES permissions(id),
    PRIMARY KEY (role_id, permission_id)
);
```

**標準ロール定義：**

| ロール            | 権限                   | 用途           |
| ----------------- | ---------------------- | -------------- |
| admin             | 全操作                 | システム管理者 |
| pipeline_creator  | パイプライン作成・実行 | 開発者         |
| pipeline_operator | パイプライン実行のみ   | オペレーター   |
| viewer            | 読み取りのみ           | 閲覧者         |

#### 7.1.3. デバイス認証（THINKLET/端末アプリ）
- **デバイス登録**: `devices(id, device_type, owner_user_id, registered_at)` に登録、発行トークン（JWT/短期）を利用。
- **セッション開始**: Ingest/gRPC開始時にデバイストークンを提示、API Gatewayで検証・スコープ確認。
- **ローテーション**: トークン期限短期化・自動更新、紛失時の即無効化。

### **7.2. データ保護**

#### **7.2.1. 暗号化**

| 対象       | 方式           | 用途                |
| ---------- | -------------- | ------------------- |
| 通信       | TLS 1.3        | HTTPS/gRPC          |
| 保存データ | AES-256        | MinIO暗号化         |
| 機密情報   | Secret Manager | パスワード・APIキー |
| Token      | RS256          | JWT署名             |

#### 7.2.1.1. メディア/ストリーミング保護
- **WebRTC(WHEP)**: DTLS-SRTP によるメディア保護、認証済みSDP交換、TURN資格情報の短期化。
- **gRPC**: TLS 1.3、ALPN、オプションでmTLS（AI Worker間）。
- **WebSocket**: WSS必須、JWT検証（接続時）とスコープ検査（購読チャネル単位）。

#### **7.2.2. データアクセス制御**

```yaml
# MinIO Bucket Policy例
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::ACCOUNT:user/pipeline-service"},
      "Action": ["s3:GetObject", "s3:PutObject"],
      "Resource": "arn:aws:s3:::imageflow-data/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-meta-owner": "${aws:username}"
        }
      }
    }
  ]
}
```

#### 7.2.3. アップロード再開（ETag）セキュリティ
- **ETag整合性検証**: 受領パートのETagを`recording_upload_parts`で突合。改変時はパート破棄。
- **署名付URL/認可**: presign有効期限短期/単用途。`upload_jobs.priority`はRBAC/Rate Limitで濫用防止。
- **バックオフ強制**: 連続失敗時に指数バックオフ、しきい値超過で一時的にジョブ停止。

### **7.3. セキュリティ監視**

#### **7.3.1. ログ監視**

```yaml
# セキュリティログ例
security_events:
  - event_type: "authentication_failure"
    timestamp: "2025-07-12T10:30:00Z"
    source_ip: "192.168.1.100"
    user_agent: "Mozilla/5.0..."
    attempted_username: "admin"
    
  - event_type: "unauthorized_access"
    timestamp: "2025-07-12T10:31:00Z"
    user_id: "user-123"
    resource: "/api/v1/admin/users"
    action: "GET"
    result: "DENIED"
```

#### **7.3.2. 脅威検知**

| 脅威                 | 検知方法                 | 対応             |
| -------------------- | ------------------------ | ---------------- |
| ブルートフォース攻撃 | ログイン失敗回数監視     | アカウントロック |
| SQLインジェクション  | WAF + パラメータ化クエリ | 接続遮断         |
| DDoS攻撃             | レート制限               | Traffic Shaping  |
| 異常アクセス         | 行動分析                 | アラート通知     |

#### 7.3.3. Ingest/録画/配信 監視
- **メトリクス**: 接続数、E2E遅延、ドロップ率、復旧時間、ギャップ率、バックプレッシャー発生率。
- **アラート**: E2E遅延P95>30ms、ドロップ率>1%、復旧時間P95>10s、継続時に通知エスカレーション。

### 7.4. オフライン・ローカルデータ保護
- **DB暗号化**: SQLite暗号化（SQLCipher相当）、KMS連携/端末固有鍵。
- **鍵管理**: OSセキュアストレージ（Keychain/Keystore）で鍵保護、PIN/生体で解錠。
- **リングバッファ**: 削除順序（最古SYNCED→LOCAL）、`protected`タグ除外、セキュア削除（ゼロ化）。

### 7.5. WebUI保護
- **CSRF**: SameSite=Lax/Strict + CSRFトークン。
- **XSS/Clickjacking**: CSP/Trusted Types、`X-Frame-Options: DENY`、入力サニタイズ。
- **CORS**: オリジン厳格許可、認証付きはCookieではなくBearer/JWTを推奨。

### 7.6. Secrets/供給鎖セキュリティ
- **Secret管理**: Vault/Secrets Manager、アクセス審査、ローテーション方針。
- **SBOM/SCA**: 依存関係の脆弱性スキャン、署名付きコンテナ（cosign）。

### 7.7. 監査・証跡
- **監査ログ**: デバイス登録、Ingest開始/終了、優先度変更、再開アップロード、ETag不一致。
- **改ざん検知**: 重要イベントのハッシュチェーン/外部保存、時刻同期（NTP）。
