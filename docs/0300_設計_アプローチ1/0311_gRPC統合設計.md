# ImageFlowCanvas gRPC統合設計書

## **文書管理情報**

| 項目       | 内容                                       |
| ---------- | ------------------------------------------ |
| 文書名     | ImageFlowCanvas gRPC統合設計書             |
| バージョン | 1.0                                        |
| 作成日     | 2025年7月20日                              |
| 更新日     | 2025年7月20日                              |
| 関連文書   | Argo Workflows設計書、アーキテクチャ設計書 |

---

## **1. 概要**

### **1.1. 文書の目的**

本文書では、ImageFlowCanvasシステムにおけるgRPC常駐サービス統合の詳細設計について記述します。従来のPod起動方式からgRPC常駐サービス方式への移行により、動的パイプライン構築と超高速処理性能を両立する革新的なアーキテクチャを定義します。

### **1.2. gRPC統合の利点**

gRPC常駐サービス統合により以下の革新的な改善を実現：

- **超高速処理**: 1-3秒
- **型安全性**: Protocol Buffersによる厳密な型定義とコンパイル時検証
- **ストリーミング対応**: 大容量画像の効率的な並列処理
- **高可用性**: gRPCヘルスチェックによる自動障害検出・復旧

---

## **2. gRPCサービス設計**

### **2.1. Protocol Buffers スキーマ定義**

#### **2.1.1. 共通メッセージ定義**

```protobuf
syntax = "proto3";

package imageflow.v1;

import "google/protobuf/timestamp.proto";

// 共通画像データ構造
message ImageData {
  string bucket = 1;
  string object_key = 2;
  string content_type = 3;
  int64 size_bytes = 4;
  int32 width = 5;
  int32 height = 6;
  google.protobuf.Timestamp created_at = 7;
}

// 処理ステータス
enum ProcessingStatus {
  PROCESSING_STATUS_UNSPECIFIED = 0;
  PROCESSING_STATUS_PENDING = 1;
  PROCESSING_STATUS_RUNNING = 2;
  PROCESSING_STATUS_COMPLETED = 3;
  PROCESSING_STATUS_FAILED = 4;
}

// 処理結果共通構造
message ProcessingResult {
  ProcessingStatus status = 1;
  string message = 2;
  ImageData output_image = 3;
  map<string, string> metadata = 4;
  google.protobuf.Timestamp processed_at = 5;
  double processing_time_seconds = 6;
}
```

#### **2.1.2. リサイズサービス定義**

```protobuf
// リサイズサービス
service ResizeService {
  rpc ResizeImage(ResizeRequest) returns (ResizeResponse);
  rpc ResizeImageStream(stream ResizeRequest) returns (stream ResizeResponse);
  rpc Health(HealthCheckRequest) returns (HealthCheckResponse);
}

message ResizeRequest {
  ImageData input_image = 1;
  int32 target_width = 2;
  int32 target_height = 3;
  bool maintain_aspect_ratio = 4;
  ResizeQuality quality = 5;
  string execution_id = 6;
}

enum ResizeQuality {
  RESIZE_QUALITY_UNSPECIFIED = 0;
  RESIZE_QUALITY_FAST = 1;
  RESIZE_QUALITY_GOOD = 2;
  RESIZE_QUALITY_BEST = 3;
}

message ResizeResponse {
  ProcessingResult result = 1;
  ResizeMetadata metadata = 2;
}

message ResizeMetadata {
  int32 original_width = 1;
  int32 original_height = 2;
  int32 output_width = 3;
  int32 output_height = 4;
  double scale_factor_x = 5;
  double scale_factor_y = 6;
  ResizeQuality quality_used = 7;
}
```

#### **2.1.3. AI検知サービス定義**

```protobuf
// AI検知サービス
service AIDetectionService {
  rpc DetectObjects(DetectionRequest) returns (DetectionResponse);
  rpc DetectObjectsStream(stream DetectionRequest) returns (stream DetectionResponse);
  rpc Health(HealthCheckRequest) returns (HealthCheckResponse);
}

message DetectionRequest {
  ImageData input_image = 1;
  string model_name = 2;
  float confidence_threshold = 3;
  float nms_threshold = 4;
  bool draw_boxes = 5;
  string execution_id = 6;
  ImageData resize_metadata_ref = 7; // リサイズメタデータ参照
}

message DetectionResponse {
  ProcessingResult result = 1;
  repeated Detection detections = 2;
  DetectionMetadata metadata = 3;
}

message Detection {
  string class_name = 1;
  float confidence = 2;
  BoundingBox bbox = 3;
  int32 class_id = 4;
}

message BoundingBox {
  float x1 = 1;
  float y1 = 2;
  float x2 = 3;
  float y2 = 4;
}

message DetectionMetadata {
  string model_name = 1;
  string model_version = 2;
  float confidence_threshold = 3;
  float nms_threshold = 4;
  int32 total_detections = 5;
  double inference_time_ms = 6;
  double nms_time_ms = 7;
}
```

#### **2.1.4. フィルタサービス定義**

```protobuf
// フィルタサービス
service FilterService {
  rpc ApplyFilter(FilterRequest) returns (FilterResponse);
  rpc ApplyFilterStream(stream FilterRequest) returns (stream FilterResponse);
  rpc Health(HealthCheckRequest) returns (HealthCheckResponse);
}

message FilterRequest {
  ImageData input_image = 1;
  FilterType filter_type = 2;
  float intensity = 3;
  map<string, string> parameters = 4;
  string execution_id = 5;
}

enum FilterType {
  FILTER_TYPE_UNSPECIFIED = 0;
  FILTER_TYPE_BLUR = 1;
  FILTER_TYPE_SHARPEN = 2;
  FILTER_TYPE_BRIGHTNESS = 3;
  FILTER_TYPE_CONTRAST = 4;
  FILTER_TYPE_SATURATION = 5;
  FILTER_TYPE_GAUSSIAN = 6;
}

message FilterResponse {
  ProcessingResult result = 1;
  FilterMetadata metadata = 2;
}

message FilterMetadata {
  FilterType filter_type = 1;
  float intensity = 2;
  map<string, string> applied_parameters = 3;
}
```

#### **2.1.5. ヘルスチェック定義**

```protobuf
// ヘルスチェック（gRPC標準）
message HealthCheckRequest {
  string service = 1;
}

message HealthCheckResponse {
  enum ServingStatus {
    UNKNOWN = 0;
    SERVING = 1;
    NOT_SERVING = 2;
    SERVICE_UNKNOWN = 3;
  }
  ServingStatus status = 1;
}
```

### **2.2. gRPCサービス実装設計**

#### **2.2.1. 常駐サービスDeployment設計**

```yaml
# リサイズgRPCサービス
apiVersion: apps/v1
kind: Deployment
metadata:
  name: resize-grpc-service
  namespace: image-processing
spec:
  replicas: 2
  selector:
    matchLabels:
      app: resize-grpc-service
  template:
    metadata:
      labels:
        app: resize-grpc-service
    spec:
      containers:
      - name: resize-grpc
        image: imageflow/resize-grpc:latest
        ports:
        - containerPort: 9090
          name: grpc
        - containerPort: 8080
          name: http-metrics
        env:
        - name: MINIO_ENDPOINT
          value: "minio-service.default.svc.cluster.local:9000"
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access-key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret-key
        - name: GRPC_PORT
          value: "9090"
        - name: METRICS_PORT
          value: "8080"
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 1
            memory: 1Gi
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:9090"]
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:9090"]
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: resize-grpc-service
  namespace: image-processing
spec:
  selector:
    app: resize-grpc-service
  ports:
  - port: 9090
    targetPort: 9090
    name: grpc
  - port: 8080
    targetPort: 8080
    name: http-metrics
  type: ClusterIP
```

#### **2.2.2. AI検知gRPCサービス**

```yaml
# AI検知gRPCサービス
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-detection-grpc-service
  namespace: image-processing
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ai-detection-grpc-service
  template:
    metadata:
      labels:
        app: ai-detection-grpc-service
    spec:
      containers:
      - name: ai-detection-grpc
        image: imageflow/ai-detection-grpc:latest
        ports:
        - containerPort: 9090
          name: grpc
        - containerPort: 8080
          name: http-metrics
        env:
        - name: MINIO_ENDPOINT
          value: "minio-service.default.svc.cluster.local:9000"
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access-key
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret-key
        - name: TRITON_GRPC_URL
          value: "triton-service.default.svc.cluster.local:8001"
        - name: GRPC_PORT
          value: "9090"
        - name: METRICS_PORT
          value: "8080"
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2
            memory: 4Gi
            nvidia.com/gpu: 1
        livenessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:9090"]
          initialDelaySeconds: 60
          periodSeconds: 15
        readinessProbe:
          exec:
            command: ["/bin/grpc_health_probe", "-addr=:9090"]
          initialDelaySeconds: 10
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: ai-detection-grpc-service
  namespace: image-processing
spec:
  selector:
    app: ai-detection-grpc-service
  ports:
  - port: 9090
    targetPort: 9090
    name: grpc
  - port: 8080
    targetPort: 8080
    name: http-metrics
  type: ClusterIP
```

---

## **3. Argo Workflows との統合**

### **3.1. gRPC Gateway設計**

gRPC GatewayによりArgo WorkflowsからgRPCサービスへの橋渡しを実現：

```yaml
# gRPC Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grpc-gateway
  namespace: image-processing
spec:
  replicas: 2
  selector:
    matchLabels:
      app: grpc-gateway
  template:
    metadata:
      labels:
        app: grpc-gateway
    spec:
      containers:
      - name: grpc-gateway
        image: imageflow/grpc-gateway:latest
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 8081
          name: metrics
        env:
        - name: RESIZE_GRPC_ENDPOINT
          value: "resize-grpc-service.image-processing.svc.cluster.local:9090"
        - name: AI_DETECTION_GRPC_ENDPOINT
          value: "ai-detection-grpc-service.image-processing.svc.cluster.local:9090"
        - name: FILTER_GRPC_ENDPOINT
          value: "filter-grpc-service.image-processing.svc.cluster.local:9090"
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
```

### **3.2. ワークフローテンプレート更新**

```yaml
# gRPCベースのワークフローテンプレート
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: grpc-image-processing
  namespace: image-processing
spec:
  entrypoint: main
  templates:
  - name: main
    dag:
      tasks:
      - name: resize-step
        template: grpc-resize-call
        arguments:
          parameters:
          - name: input-file
            value: "{{workflow.parameters.execution-id}}.png"
          - name: output-file
            value: "{{workflow.parameters.execution-id}}_resize.png"
      
      - name: ai-detection-step
        template: grpc-ai-detection-call
        dependencies: [resize-step]
        arguments:
          parameters:
          - name: input-file
            value: "{{workflow.parameters.execution-id}}_resize.png"
          - name: output-file
            value: "{{workflow.parameters.execution-id}}_ai-detection.png"
      
      - name: filter-step
        template: grpc-filter-call
        dependencies: [ai-detection-step]
        arguments:
          parameters:
          - name: input-file
            value: "{{workflow.parameters.execution-id}}_ai-detection.png"
          - name: output-file
            value: "{{workflow.parameters.execution-id}}_filter.png"

  - name: grpc-resize-call
    http:
      url: "http://grpc-gateway.image-processing.svc.cluster.local:8080/v1/resize"
      method: POST
      headers:
        - name: Content-Type
          value: application/json
      body: |
        {
          "input_image": {
            "bucket": "imageflow-files",
            "object_key": "{{inputs.parameters.input-file}}"
          },
          "target_width": 800,
          "target_height": 600,
          "maintain_aspect_ratio": true,
          "quality": "RESIZE_QUALITY_GOOD",
          "execution_id": "{{workflow.parameters.execution-id}}"
        }

  - name: grpc-ai-detection-call
    http:
      url: "http://grpc-gateway.image-processing.svc.cluster.local:8080/v1/detect"
      method: POST
      headers:
        - name: Content-Type
          value: application/json
      body: |
        {
          "input_image": {
            "bucket": "imageflow-files",
            "object_key": "{{inputs.parameters.input-file}}"
          },
          "model_name": "yolo",
          "confidence_threshold": 0.5,
          "nms_threshold": 0.4,
          "draw_boxes": true,
          "execution_id": "{{workflow.parameters.execution-id}}"
        }

  - name: grpc-filter-call
    http:
      url: "http://grpc-gateway.image-processing.svc.cluster.local:8080/v1/filter"
      method: POST
      headers:
        - name: Content-Type
          value: application/json
      body: |
        {
          "input_image": {
            "bucket": "imageflow-files",
            "object_key": "{{inputs.parameters.input-file}}"
          },
          "filter_type": "FILTER_TYPE_BLUR",
          "intensity": 1.0,
          "execution_id": "{{workflow.parameters.execution-id}}"
        }
```

---

## **4. 性能最適化**

### **4.1. 処理時間比較**

| 処理段階               | 従来Pod方式         | gRPC常駐方式    | 改善効果        |
| ---------------------- | ------------------- | --------------- | --------------- |
| **Pod起動時間**        | 30-50秒             | 0秒（常駐済み） | **-50秒**       |
| **通信オーバーヘッド** | HTTP/1.1: 100-200ms | gRPC: 20-50ms   | **-150ms**      |
| **実際の処理時間**     | 15-20秒             | 1-2秒           | **-18秒**       |
| **ステップ間待機**     | 16-24秒             | ほぼ0秒         | **-20秒**       |
| **総処理時間**         | **60-94秒**         | **1-3秒**       | **95%以上短縮** |

### **4.2. gRPCストリーミング活用**

大容量画像の効率的な処理のため、gRPCストリーミングを活用：

```go
// リサイズサービスでのストリーミング実装例
func (s *ResizeService) ResizeImageStream(stream pb.ResizeService_ResizeImageStreamServer) error {
    for {
        req, err := stream.Recv()
        if err == io.EOF {
            return nil
        }
        if err != nil {
            return err
        }
        
        // 並列処理での高速リサイズ
        result, err := s.processResizeRequest(req)
        if err != nil {
            return err
        }
        
        if err := stream.Send(result); err != nil {
            return err
        }
    }
}
```

---

## **5. 運用・監視**

### **5.1. gRPCメトリクス監視**

```yaml
# Prometheus ServiceMonitor for gRPC services
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: grpc-services-monitor
  namespace: image-processing
spec:
  selector:
    matchLabels:
      monitoring: grpc-services
  endpoints:
  - port: http-metrics
    interval: 30s
    path: /metrics
```

### **5.2. 分散トレーシング**

gRPCサービス間の分散トレーシングにより、処理フローの完全な可視化を実現：

```go
// OpenTelemetry統合例
import (
    "go.opentelemetry.io/otel/trace"
    "go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc"
)

func NewGRPCServer() *grpc.Server {
    return grpc.NewServer(
        grpc.UnaryInterceptor(otelgrpc.UnaryServerInterceptor()),
        grpc.StreamInterceptor(otelgrpc.StreamServerInterceptor()),
    )
}
```

---

## **6. 実装ロードマップ**

### **6.1. フェーズ別実装計画**

| フェーズ    | 実装項目                      | 期間  | 詳細                               |
| ----------- | ----------------------------- | ----- | ---------------------------------- |
| **Phase 1** | Protocol Buffers スキーマ設計 | 1日   | .protoファイル作成、コード生成設定 |
| **Phase 2** | gRPCサービス実装              | 3-4日 | 各処理サービスのgRPC化             |
| **Phase 3** | gRPC Gateway実装              | 2日   | HTTP-gRPC変換レイヤー              |
| **Phase 4** | Argo Workflows統合            | 1日   | ワークフローテンプレート更新       |
| **Phase 5** | 監視・運用基盤                | 1-2日 | メトリクス、ログ、トレーシング     |

**総実装期間: 8-10日**

### **6.2. 成功指標**

- **処理時間**: 50秒 → 1-3秒（90%以上短縮）
- **可用性**: 99.9%以上
- **レスポンス時間**: gRPC呼び出し50ms以下
- **スループット**: 毎秒10リクエスト以上
- **エラー率**: 0.1%以下

---

**文書履歴**

| バージョン | 日付       | 変更内容 | 作成者             |
| ---------- | ---------- | -------- | ------------------ |
| 1.0        | 2025-07-20 | 初版作成 | システム設計チーム |