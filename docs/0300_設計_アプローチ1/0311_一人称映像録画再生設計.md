# ImageFlowCanvas 一人称映像 録画・再生 設計書

| 項目       | 内容                                                     |
| ---------- | -------------------------------------------------------- |
| 文書名     | 0311_一人称映像録画再生設計                              |
| バージョン | 0.9（アプローチ1草案）                                   |
| 作成日     | 2025-08-31                                              |
| 更新日     | 2025-08-31                                              |
| 参照       | 0100_要件定義書, 0300_システム基本設計, 0301_WebUI設計, 0302_サーバーBackend設計, 0303_データベース設計, 0304_API設計, 0307_KotlinMultiplatformアプリ設計, 0308_THINKLETアプリ設計, 9000_調査/0010_THINKLET |

---

## 1. 概要
### 1.1 目的
現場のウェアラブル（例: THINKLET）による一人称映像を、安全かつ高品質に「録画・保存・検索・再生」できる統合基盤を設計する。リアルタイム AI 解析および製品トレーサビリティと密に連携し、品質改善と業務効率向上に資する映像資産管理（VMS）を提供する。

### 1.2 適用範囲
- デバイス側: 単一路インジェスト（WHIP/WebRTC優先、代替: RTSP）、オンデバイス録画・同期、QoS 切替。
- サーバ側: Ingest Gateway → Recorder（remux/segment）→ MinIO 保存、検索/再生 API、署名 URL/Viewer トークン発行、監査。
- クライアント: Web UI（HLS/WebRTC 再生、検索、ブックマーク）、KMP（Android/THINKLET/デスクトップ）再生 UI。

### 1.3 非範囲（Out of Scope）
- 汎用 CCTV、DVR 移行は別設計。超低遅延配信の多地点ミキシングは将来対応。

---

## 2. 要求の整理（要件定義との対応）
- F-030: ウェアラブル一人称映像の録画・保存（8MP/広角、連続録画、バッテリー効率）。
- F-030-1: 録画と製品情報の紐づけ（指図番号・指示番号・型式・機番・月連番）。
- F-036/F-037: 録画映像の検索・高機能再生（4K/60fps、速度、フレーム送り、部分クリップ、同期再生、ブックマーク）。
- NF-011: 録画データの保存期間 1 年（メタ含む）。
- NF-018: 超低遅延処理（デバイス→サーバは WHIP/WebRTC、E2E 映像遅延 < 20ms 目標）。
- 運用: RBAC、署名 URL/Viewer トークン、監査ログ、ライフサイクル/アーカイブ、メトリクス監視。

保存方針の整合: 0302/0303 でのオンプレ 90 日＋クラウドアーカイブと、NF-011（一年保存）を統合し、「多層保持（Hot:90日 on-prem / Warm–Cold:91–365日 cloud アーカイブ、透過的再生）」を採用する。

---

## 3. 全体アーキテクチャ
```
THINKLET/端末（WHIP/RTSP 単一路）
   → Ingest Gateway（WHIP/RTSP）
      → Recorder（再エンコード無し remux → fMP4 セグメント）
         → MinIO（Hot 90日）→ アーカイブ（91–365日）
      → Frame Extractor（AI ワーカーへ gRPC）
      → Distributor（WebRTC/HLS/DASH 配信）

Backend API（VMS/Control/Search/Playback）
   ↔ PostgreSQL（メタ/インデックス/ブックマーク等）
   ↔ WebSocket（進捗・監視）

Web UI/KMP（検索・再生・分析、ライブ視聴）
```

原則: 「単一路インジェスト＋サーバ分岐＋単一デコード」。

---

## 4. 録画設計
### 4.1 デバイス側（THINKLET/KMP）
- 送出: WebRTC（WHIP）優先。断絶時は再 Offer（ICE 再収集）。フォールバックに RTSP を許容。
- 主録画: オンデバイスで連続録画（セグメント化）。状態機械: LOCAL → UPLOADING → SYNCED → FAILED。
- 同期: S3 互換プレサインド・マルチパートアップロード、ETag ベース再開、LTE: 1–2 本 / Wi‑Fi: 4–6 本。
- メタ送出: device_id、execution_id、開始/終了 ts、fps/解像度/ビットレート、view_angle、battery、pose、製品情報。
- 制御: Backend 経由で録画開始/停止、QoS プリセット切替。

### 4.2 サーバ側（Recorder/オブジェクトストレージ）
- Ingest: WHIP/SDP 受領→RTP 受信。セッションは Backend が発行した WHIP URL/ICE 情報で確立。
- 録画: 再エンコード無し remux（fMP4）・ロールリング。ギャップ最小化（PTS 連続性、境界スナップ、再結合オプション）。
- 保存: MinIO（EC 構成）に `vms/{source}/{id}/{YYYY}/{MM}/{DD}/{hh}/{segment_id}.mp4`。Sidecar JSON を併置。
- アーカイブ: 91 日以降はクラウド（例: ADLS）へ ILM 転送。透過アクセス（署名 URL で自動フェッチ/ステージング）。
- 監査: `traceability_records` に録画/再生/ダウンロード操作を記録。

### 4.3 録画メタデータ（Sidecar JSON 1.0）
0304 12.5 を準拠（抜粋）:
```
schema_version, recording_id(uuid), device_id, execution_id?,
start_ts, end_ts, duration_ms, fps, resolution, video_codec(h264), audio_codec(aac),
bitrate_kbps, location{lat,lon}, pose{roll,pitch,yaw}, battery_pct, temperature_c,
storage_url(s3://...), checksum, labels[], tags{...}, notes
```
検索キー: device_id / execution_id / start_ts / labels / tags。

---

## 5. 再生設計
### 5.1 配信方式
- オンデマンド: HLS/DASH（`/api/v1/videos/{video_id}/stream.(m3u8|mpd)`）。初回開始 < 3s（キャッシュ済み < 1s）。
- ライブ: WHEP/WebRTC（`/api/v1/vms/live/{source}/{id}/whep`）で Viewer トークン発行。
- サムネイル/プレビュー: 取り込み時にキーフレーム抽出・静止画化。タイムラインのチャプタ生成をオプション提供。

### 5.2 プレイヤー機能（Web/KMP 共通方針）
- 基本: 4K/60fps、速度 0.25x–4.0x、フレーム送り、区間リピート、全画面、音量。
- AI 重畳: 検出結果（バウンディング・マスク）をオーバーレイ（可視/非表示切替）。
- ブックマーク: タイムスタンプ、タイトル、説明、種別（DEFECT/NOTE/IMPORTANT）。
- クリップ: 区間切り出し（再エンコード無しの clean cut を優先、必要時のみ再エンコード）。
- 同期再生: 複数映像の時刻同期（差分補正±数百 ms、先頭合わせ/イベント合わせ）。

---

## 6. データモデル/インデックス
- `video_recordings`/`video_metadata`/`video_bookmarks`/`video_search_history`（0303 参照）。
- THINKLET 統合: `thinklet_inspection_segments`（録画区間と検査/AI 結果の集約）、`thinklet_stream_metrics`（QoS/接続の時系列）。
- 主要インデックス: 製品情報（product_code, machine_number, month_sequence 等）、device_id、operator、recording_start_time、fulltext(tags/comments)。

---

## 7. API 仕様（要点のみ、詳細は 0304 参照）
- 録画制御（REST）: `POST /devices/{device_id}/recordings/{start|stop|pause|resume}`、`GET /devices/{device_id}/recordings`。
- 録画制御（gRPC）: `RecordingControlService`（Start/Stop/Pause/Resume/List/Get）。
- シグナリング: `POST /rtc/whep`、ICE 情報: `GET /api/v1/rtc/config`。
- オブジェクト同期: `POST /api/v1/recordings/uploads/{presign|complete}`（マルチパート）。
- 検索: `POST /api/v1/videos/search`、製品別: `GET /api/v1/videos/by-product/{product_id}`。
- 再生: `GET /api/v1/videos/{video_id}/stream(.m3u8|.mpd)`、`/thumbnail`、`/metadata`、ブックマーク CRUD。
- ライブ視聴: `GET /api/v1/vms/live/{source}/{id}/whep`（Viewer トークン/URL）。

RBAC/保護: 署名 URL（短命）または Viewer トークン必須。装着者本人・品質管理者・管理者ロールで制御。

---

## 8. クライアント UI 設計（要点）
### 8.1 Web UI
- 検索: 製品情報/期間/結果/タグ/テキスト。保存済み検索・お気に入り。
- 再生: 4K プレイヤー、AI 重畳、タイムライン、フレーム制御、コメント/注釈、詳細情報（製品/作業者/録画/ファイル）。
- 監視: Ingest/録画/配信の接続数・遅延・ドロップ率などリアルタイム表示。

### 8.2 KMP（Desktop/Android/THINKLET）
- ライブ: WHEP 受信、結果オーバーレイ。
- 録画一覧・再生: 進捗/同期状態表示、断続ネットワーク下の閲覧を考慮（プレビュー優先）。

---

## 9. 性能・容量・SLO
- E2E ライブ遅延: < 20ms（WHEP/WHIP 経由での配信系合計）。
- 再生開始時間: P95 < 2.5s（初回）、P95 < 1.0s（キャッシュ済み）。
- 同時再生: 100 ストリーム（1080p）目標。GPU/ABR チューニングで 4K は限定提供。
- 保存: 1 年（Hot: 90 日 on‑prem / Warm–Cold: 91–365 日 cloud）。重要タグ `protected` は削除対象外。
- 可用性: API 99.9%。

---

## 10. 異常系・リカバリ
- デバイス断: ICE 失敗/RTCP ロス → 再 Offer。リングバッファにより録画継続・再結合。QoS ダウングレード（fps/解像度）。
- 同期失敗: ETag 検証で再開、指数バックオフ、ネットワーク別同時本数制御。FAILED → 自動再試行/ユーザー通知。
- 再生: HLS/DASH フォールバック（低ビットレート優先）、トランスコード待ち時はプレースホルダ。
- ストレージ: ILM 転送失敗は再試行・検証ジョブ。整合性はチェックサム/サイズ一致で担保。

---

## 11. セキュリティ/権限/監査
- 認証: デバイス JWT/証明書、ユーザー OIDC。
- 認可: RBAC（装着者自身、品質管理者、管理者）。
- 保護: 期限付き署名 URL、Viewer トークン、経路暗号化（TLS）。
- 監査: 再生/ダウンロード/検索を `traceability_records` に保存。

---

## 12. 監視・運用
- メトリクス: 接続数、E2E 遅延、ドロップ率、再接続回数、録画/保存レイテンシ、同期キュー滞留、アーカイブ転送状況。
- ダッシュボード: Ingest/Recorder/Distributor/VMS/MinIO/DB の総合ビュー。フェイルオーバー演習の可視化。
- アラート: 配信断、録画失敗、ILM 失敗、視聴エラー率、P95 劣化。

---

## 13. テスト計画
- 単体: 録画制御 API、メタスキーマ検証、署名 URL 期限/権限。
- 結合: WHIP→Recorder→MinIO→再生の E2E、断続ネットワーク/再接続、マルチパート再開、ギャップ最小化。
- 負荷: 100 同時視聴、長時間録画（>8h）、アーカイブ復元の再生レイテンシ。
- 回帰: ブックマーク/検索/クリップ/同期再生の互換性。

---

## 14. ロールアウト計画
段階導入（PoC→Pilot→本番）:
1) PoC: MediaMTX を Ingest/配信に用いた最小構成（9000_調査参照）。HLS 再生と録画一覧、基本 API 検証。
2) Pilot: 自前 Ingest Gateway＋Recorder を導入。RBAC/監査/ILM/検索 UI を統合。SLO 計測。
3) 本番: 多層保持と Viewer トークン、同期再生/AI 重畳、分析ダッシュボードを有効化。

---

## 15. 付録
### 15.1 オブジェクトキー/パス命名
- `vms/thinklet/{device_id}/{YYYY}/{MM}/{DD}/{HH}/{segment_id}.mp4`
- Sidecar: 同パスに `.json`。サムネイル: `.thumb.jpg`。プレビュー: `.preview.mp4`。

### 15.2 製品情報フィールド（命名規約）
- product_code, machine_number, month_sequence（backend/DB）／ productCode（KMP/TS）。

### 15.3 主要テーブル（参照）
- `video_recordings`, `video_metadata`, `video_bookmarks`, `thinklet_inspection_segments`, `thinklet_stream_metrics`（0303 参照）。

### 15.4 用語
- THINKLET（ウェアラブル）、WHIP/WHEP（WebRTC ingest/playback）、ABR（適応ビットレート）、ILM（ライフサイクル管理）。
