# ImageFlowCanvas データベース設計書

## **文書管理情報**

| 項目       | 内容                               |
| ---------- | ---------------------------------- |
| 文書名     | ImageFlowCanvas データベース設計書 |
| バージョン | 1.0                                |
| 作成日     | 2025年7月12日                      |
| 更新日     | 2025年7月12日                      |


---

## **1. データベース設計**

### **1.1. データストレージ戦略**

ImageFlowCanvasでは、アプリケーション特性に応じて異なるストレージを使い分けます：

| データ種別           | ストレージ               | 理由                                                       |
| -------------------- | ------------------------ | ---------------------------------------------------------- |
| 画像データ           | MinIO (オブジェクト)     | 大容量、S3互換、高可用性                                   |
| メタデータ（サーバー） | PostgreSQL (RDB)         | ACID特性、関係性、複雑なクエリ対応                         |
| ローカルデータ（Tauri） | SQLite (組み込みDB)       | オフライン対応、軽量、ファイルベース                       |
| リアルタイム通信     | Kafka + Redis            | 高スループット、低遅延、一時データ                         |

### **1.1.1. ストレージ選択の詳細理由**

**MinIO (画像・成果物)**:
- S3互換APIによる移植性確保
- 大容量画像ファイルの効率的保存
- バージョニング・レプリケーション対応
- REST API経由の直接アクセス

**PostgreSQL (サーバーメタデータ)**:
- トランザクション保証による一貫性確保
- 複雑な検索・集計クエリ対応
- JSON型による柔軟なスキーマ対応
- 高性能インデックス・パーティショニング

**SQLite (Tauriローカル)**:
- オフライン完全対応
- アプリ組み込み型の軽量DB
- ファイルベースの簡単配布
- 同期による最新データ取得

**Kafka + Redis (リアルタイム)**:
- 非同期メッセージング
- 進捗通知・ステータス更新
- 一時的なセッション管理
- WebSocket配信のバッファリング

### **1.2. データモデル設計**

### **1.2. データモデル設計**

#### **1.2.1. サーバーサイド（PostgreSQL）スキーマ**

**パイプライン管理**
```sql
-- パイプライン定義テーブル
CREATE TABLE pipelines (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    definition JSONB NOT NULL,  -- DAG定義
    version INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    created_by UUID REFERENCES users(id)
);

-- パイプライン実行履歴テーブル
CREATE TABLE pipeline_executions (
    id UUID PRIMARY KEY,
    pipeline_id UUID REFERENCES pipelines(id),
    status VARCHAR(50) NOT NULL,  -- pending, running, completed, failed
    input_data JSONB,
    output_data JSONB,
    error_message TEXT,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    created_by UUID REFERENCES users(id)
);
```

**コンポーネント管理**
```sql
-- 処理コンポーネントテーブル
CREATE TABLE components (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    docker_image VARCHAR(500) NOT NULL,
    version VARCHAR(50) NOT NULL,
    input_schema JSONB,    -- 入力パラメータスキーマ
    output_schema JSONB,   -- 出力データスキーマ
    resource_requirements JSONB,  -- CPU/GPU/メモリ要件
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- コンポーネント実行ログテーブル
CREATE TABLE component_executions (
    id UUID PRIMARY KEY,
    execution_id UUID REFERENCES pipeline_executions(id),
    component_id UUID REFERENCES components(id),
    status VARCHAR(50) NOT NULL,
    input_data JSONB,
    output_data JSONB,
    execution_time_ms INTEGER,
    resource_usage JSONB,
    started_at TIMESTAMP,
    completed_at TIMESTAMP
);
```

**ファイル管理**
```sql
-- ファイルメタデータテーブル
CREATE TABLE files (
    id UUID PRIMARY KEY,
    original_name VARCHAR(500),
    mime_type VARCHAR(100),
    file_size BIGINT,
    storage_path VARCHAR(1000) NOT NULL,  -- MinIOパス
    checksum VARCHAR(64),
    metadata JSONB,  -- EXIF等
    created_at TIMESTAMP DEFAULT NOW(),
    created_by UUID REFERENCES users(id)
);
```

#### **1.2.2. Tauriアプリ（SQLite）スキーマ**

**基本テーブル構造**
```sql
-- ユーザー認証テーブル
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    email TEXT UNIQUE,
    password_hash TEXT NOT NULL,
    full_name TEXT,
    role TEXT DEFAULT 'inspector',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 検査対象テーブル
CREATE TABLE inspection_targets (
    id TEXT PRIMARY KEY,
    product_id TEXT NOT NULL,
    batch_id TEXT NOT NULL,
    qr_code TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 検査セッションテーブル
CREATE TABLE inspection_sessions (
    id TEXT PRIMARY KEY,
    target_id TEXT NOT NULL,
    user_id INTEGER,
    status TEXT DEFAULT 'pending',
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    FOREIGN KEY (target_id) REFERENCES inspection_targets(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

**検査機能専用テーブル**
```sql
-- 検査画像テーブル
CREATE TABLE inspection_images (
    id TEXT PRIMARY KEY,
    session_id TEXT NOT NULL,
    file_path TEXT NOT NULL,
    image_type TEXT DEFAULT 'capture',
    file_size INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES inspection_sessions(id)
);

-- AI検査結果テーブル
CREATE TABLE ai_inspection_results (
    id TEXT PRIMARY KEY,
    session_id TEXT NOT NULL,
    pipeline_version TEXT,
    overall_result TEXT NOT NULL,
    confidence REAL NOT NULL,
    processing_time REAL NOT NULL,
    detailed_results TEXT, -- JSON形式の詳細結果
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES inspection_sessions(id)
);

-- 人による検証結果テーブル
CREATE TABLE human_verification_results (
    id TEXT PRIMARY KEY,
    session_id TEXT NOT NULL,
    user_id INTEGER NOT NULL,
    final_result TEXT NOT NULL,
    notes TEXT,
    verification_time REAL NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES inspection_sessions(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- システム設定テーブル
CREATE TABLE system_config (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### **1.2.3. 検査マスタ管理（PostgreSQL拡張）**

```sql
-- 検査対象マスタテーブル（サーバー管理）
CREATE TABLE inspection_targets_master (
    id UUID PRIMARY KEY,
    product_code VARCHAR(100) NOT NULL UNIQUE,
    product_name VARCHAR(255) NOT NULL,
    version VARCHAR(50) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    created_by UUID REFERENCES users(id)
);

-- 検査項目マスタテーブル
CREATE TABLE inspection_items_master (
    id UUID PRIMARY KEY,
    target_id UUID REFERENCES inspection_targets_master(id),
    item_code VARCHAR(100) NOT NULL,
    item_name VARCHAR(255) NOT NULL,
    inspection_type VARCHAR(50) NOT NULL,  -- VISUAL, DIMENSION, FUNCTION, TEXT
    ai_enabled BOOLEAN DEFAULT false,
    pipeline_id UUID REFERENCES pipelines(id),  -- WebUIで定義されたパイプラインを使用
    criteria JSONB NOT NULL,  -- 判定基準
    order_sequence INTEGER NOT NULL,
    required BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(target_id, item_code)
);

-- Tauri同期キューテーブル
CREATE TABLE tauri_sync_queue (
    id SERIAL PRIMARY KEY,
    device_id VARCHAR(255) NOT NULL,
    device_type VARCHAR(50) NOT NULL,     -- mobile, desktop, tablet
    app_version VARCHAR(50) NOT NULL,     -- Tauriアプリのバージョン
    entity_type VARCHAR(100) NOT NULL,    -- inspection_execution, inspection_result, etc.
    entity_id UUID NOT NULL,
    operation VARCHAR(20) NOT NULL,       -- INSERT, UPDATE, DELETE
    data JSONB NOT NULL,
    priority INTEGER DEFAULT 0,
    retry_count INTEGER DEFAULT 0,
    last_retry_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    processed_at TIMESTAMP
);
```

### **1.3. データアクセスパターン**

#### **1.3.1. 読み取りパターン**

**パイプライン関連**
- パイプライン一覧表示：ページング対応（LIMIT/OFFSET）
- 実行履歴検索：日付範囲、ステータス絞り込み（インデックス活用）
- リアルタイム進捗：WebSocket + Kafka + Redis（メモリベース）
- コンポーネント検索：名前・カテゴリ・バージョン別フィルタリング

**検査機能関連**
- **QRコード検索**: `inspection_targets.qr_code` → 検査対象 → 関連検査項目リスト
- **検査履歴表示**: 検査者別、期間別、製品別フィルタリング
- **品質ダッシュボード**: 統計データの集計表示（日次・週次・月次）
- **マスタデータ同期**: Tauriアプリへの差分配信

**パフォーマンス最適化**
- **レディングレプリカ**: 読み取り専用クエリの分散
- **キャッシング**: Redis活用による頻繁アクセスデータのキャッシュ
- **パーティショニング**: 大量履歴データの月別パーティション
- **インデックス活用**: 複合インデックスによるクエリ最適化

#### **1.3.2. 書き込みパターン**

**パイプライン実行フロー**
- パイプライン実行：トランザクション処理（BEGIN → INSERT → COMMIT）
- 進捗更新：Kafka → PostgreSQL（非同期書き込み）
- ファイル保存：MinIO + メタデータ分離（2フェーズコミット）

**検査データ処理**
- **検査結果保存**: 画像保存 → AI実行 → 結果記録（アトミック処理）
- **Tauri同期**: オフラインデータの一括処理（バッチインサート）
- **アラート生成**: 検査結果に基づく自動通知（トリガー処理）

**データ整合性保証**
- **トランザクション境界**: 関連データの一括処理
- **外部キー制約**: 参照整合性の自動チェック
- **楽観的ロック**: バージョン番号による競合制御
- **デッドロック回避**: 適切なロック順序・タイムアウト設定

#### **1.3.3. Tauri同期専用アクセスパターン**

**同期キュー処理**
```sql
-- 未処理同期アイテムの取得
SELECT * FROM tauri_sync_queue 
WHERE processed_at IS NULL 
ORDER BY priority DESC, created_at ASC 
LIMIT 100;

-- バッチ処理完了の更新
UPDATE tauri_sync_queue 
SET processed_at = NOW() 
WHERE id IN (:processed_ids);
```

**差分同期戦略**
- **増分同期**: `last_sync_timestamp`以降の変更データのみ配信
- **競合解決**: タイムスタンプ比較による最新データ優先
- **データ整合性**: チェックサム検証による破損検出
- **リトライ機構**: 失敗時の指数バックオフリトライ

#### **1.3.4. パフォーマンス最適化インデックス設計**

**基本パフォーマンスインデックス**
```sql
-- パイプライン関連
CREATE INDEX idx_pipelines_name ON pipelines(name);
CREATE INDEX idx_pipeline_executions_status_created ON pipeline_executions(status, created_at);
CREATE INDEX idx_component_executions_execution_time ON component_executions(execution_id, started_at);

-- ファイル管理
CREATE INDEX idx_files_storage_path ON files(storage_path);
CREATE INDEX idx_files_created_user ON files(created_by, created_at);

-- 検査機能専用インデックス
CREATE INDEX idx_inspection_targets_product_code ON inspection_targets_master(product_code);
CREATE INDEX idx_inspection_items_target_sequence ON inspection_items_master(target_id, order_sequence);
CREATE INDEX idx_inspection_items_pipeline ON inspection_items_master(pipeline_id);

-- Tauri同期最適化
CREATE INDEX idx_tauri_sync_queue_device_priority ON tauri_sync_queue(device_id, device_type, priority, created_at);
CREATE INDEX idx_tauri_sync_queue_unprocessed ON tauri_sync_queue(processed_at) WHERE processed_at IS NULL;
```

**検査統計専用インデックス**
```sql
-- 検査統計・分析用複合インデックス
CREATE INDEX idx_ai_results_confidence_time ON ai_inspection_results(confidence, created_at);
CREATE INDEX idx_human_results_final_date ON human_verification_results(final_result, created_at);
CREATE INDEX idx_inspection_sessions_status_completed ON inspection_sessions(status, completed_at);
```

### **1.4. データ移行・バックアップ戦略**

#### **1.4.1. サーバーデータバックアップ**
- **PostgreSQL**: pg_dump による論理バックアップ（日次）
- **MinIO**: レプリケーション + スナップショット（リアルタイム）
- **アーカイブ**: 長期保存用の圧縮・暗号化バックアップ

#### **1.4.2. Tauriデータ同期戦略**
- **初期同期**: 新規デバイスへの全マスタデータ配信
- **差分同期**: 変更分のみの効率的な更新配信
- **オフライン復旧**: ネットワーク復旧時の自動データ同期
- **データ検証**: 同期データの整合性チェック・修復機能