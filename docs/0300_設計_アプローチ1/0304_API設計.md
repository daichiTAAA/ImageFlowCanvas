# ImageFlowCanvas APIè¨­è¨ˆæ›¸

## **æ–‡æ›¸ç®¡ç†æƒ…å ±**

| é …ç›®       | å†…å®¹                      |
| ---------- | ------------------------- |
| æ–‡æ›¸å     | ImageFlowCanvas APIè¨­è¨ˆæ›¸ |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 1.0                       |
| ä½œæˆæ—¥     | 2025å¹´7æœˆ12æ—¥             |
| æ›´æ–°æ—¥     | 2025å¹´7æœˆ12æ—¥             |


---

## **5. APIè¨­è¨ˆ**

### **5.0. ãƒ—ãƒ­ãƒˆã‚³ãƒ«è¨­è¨ˆ**

#### **5.0.1. è©³ç´°ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**

```mermaid
sequenceDiagram
    participant Client as ğŸ–¥ï¸ å¤–éƒ¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant Gateway as ğŸšª API Gateway
    participant API as ğŸ”§ Backend API
    participant Kafka as ğŸ“¨ Kafka
    participant MinIO as ğŸ’¾ MinIO
    participant gRPCServices as âš¡ gRPCå¸¸é§ã‚µãƒ¼ãƒ“ã‚¹
    participant WebUI as ğŸŒ Web UI

    Note over Client, WebUI: 1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”»åƒé€ä¿¡
    Client->>Gateway: gRPC ImageStream<br/>ProcessImageRequest({<br/>  image_chunk: bytes,<br/>  pipeline_id: "resize-ai-detect",<br/>  priority: HIGH<br/>})
    Gateway->>API: HTTP/JSONå¤‰æ›
    API->>MinIO: ç”»åƒä¿å­˜ (S3 API)
    MinIO-->>API: file_idè¿”å´
    
    Note over Client, WebUI: 2. ç›´æ¥gRPCå‡¦ç†å®Ÿè¡Œ
    API->>gRPCServices: ç›´æ¥gRPCå‘¼ã³å‡ºã—<br/>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
    gRPCServices->>MinIO: ç”»åƒå–å¾— (S3 API)
    gRPCServices->>gRPCServices: ç”»åƒå‡¦ç†å®Ÿè¡Œ
    gRPCServices->>MinIO: çµæœä¿å­˜ (S3 API)
    
    Note over Client, WebUI: 3. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—é€šçŸ¥
    gRPCServices->>Kafka: é€²æ—é€ä¿¡ (Producer)<br/>Topic: processing-progress<br/>{<br/>  "execution_id": "exec-123",<br/>  "status": "completed",<br/>  "step": "resize"<br/>}
    
    Note over Client, WebUI: 4. UIæ›´æ–°
    Kafka->>API: Consumerå—ä¿¡
    API->>WebUI: WebSocketé€ä¿¡<br/>{<br/>  "type": "progress_update",<br/>  "data": {...}<br/>}
    
    Note over Client, WebUI: 5. çµæœé…ä¿¡
    gRPCServices->>API: å‡¦ç†å®Œäº†é€šçŸ¥
    API->>Client: gRPC Response<br/>ProcessingResult({<br/>  status: SUCCESS,<br/>  output_file_id: "result-789"<br/>})
```

#### **5.0.2. gRPCãƒ—ãƒ­ãƒˆã‚³ãƒ«é€šä¿¡ãƒ•ãƒ­ãƒ¼**

```mermaid
sequenceDiagram
    participant Client as ğŸ–¥ï¸ å¤–éƒ¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant Gateway as ğŸšª API Gateway  
    participant API as ğŸ”§ Backend API
    participant Kafka as ğŸ“¨ Kafka
    participant MinIO as ğŸ’¾ MinIO
    participant gRPCServices as âš¡ gRPCå¸¸é§ã‚µãƒ¼ãƒ“ã‚¹
    participant WebUI as ğŸŒ Web UI

    Note over Client, WebUI: 1. gRPCãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”»åƒé€ä¿¡
    Client->>Gateway: gRPC ProcessImageStream<br/>{<br/>  image_chunk: bytes,<br/>  pipeline_id: "resize-ai-detect",<br/>  priority: HIGH,<br/>  client_id: "client-001"<br/>}
    Gateway->>API: HTTP/2 ãƒ—ãƒ­ã‚­ã‚·è»¢é€
    API->>MinIO: S3 API ç”»åƒä¿å­˜
    MinIO-->>API: file_idè¿”å´
    
    Note over Client, WebUI: 2. ç›´æ¥gRPCå‡¦ç†å®Ÿè¡Œ
    API->>gRPCServices: ç›´æ¥gRPCå‘¼ã³å‡ºã—<br/>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
    gRPCServices->>MinIO: S3 API ãƒ‡ãƒ¼ã‚¿å–å¾—
    gRPCServices->>gRPCServices: gRPCå†…éƒ¨é€šä¿¡<br/>ãƒªã‚µã‚¤ã‚ºâ†’AIâ†’å¾Œå‡¦ç†
    gRPCServices->>MinIO: S3 API çµæœä¿å­˜
    
    Note over Client, WebUI: 3. WebSocketãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
    gRPCServices->>Kafka: Produceré€²æ—é€ä¿¡
    Kafka->>API: Consumeré€²æ—å—ä¿¡
    API->>WebUI: WebSocket Pushé€šçŸ¥
    
    Note over Client, WebUI: 4. gRPCãƒ¬ã‚¹ãƒãƒ³ã‚¹å®Œäº†
    API->>Client: gRPC Response<br/>ProcessingResult
```

#### **5.0.3. ãƒ—ãƒ­ãƒˆã‚³ãƒ«æœ€é©åŒ–ã®é¸æŠåŸºæº–**

| ğŸ¯ ç”¨é€”ãƒ»ã‚·ãƒŠãƒªã‚ª         | ğŸš€ æ¨å¥¨ãƒ—ãƒ­ãƒˆã‚³ãƒ« | âš¡ æ€§èƒ½ç‰¹æ€§                                                            | ğŸ“ é¸æŠç†ç”±                            |
| :----------------------- | :--------------- | :-------------------------------------------------------------------- | :------------------------------------ |
| **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”»åƒå‡¦ç†** | gRPC             | â€¢ ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· (50-100ms)<br/>â€¢ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ<br/>â€¢ ãƒã‚¤ãƒŠãƒªåŠ¹ç‡ | ãƒ©ã‚¤ãƒ–é…ä¿¡ã€ç›£è¦–ã‚«ãƒ¡ãƒ©ã€AR/VRç”¨é€”     |
| **ãƒãƒƒãƒç”»åƒå‡¦ç†**       | REST API         | â€¢ é«˜ä¿¡é ¼æ€§<br/>â€¢ ã‚·ãƒ³ãƒ—ãƒ«çµ±åˆ<br/>â€¢ HTTPæ¨™æº–                          | ä¸€æ‹¬å‡¦ç†ã€æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ é€£æº            |
| **ã‚·ã‚¹ãƒ†ãƒ é–“é€£æº**       | Kafka            | â€¢ é«˜ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ<br/>â€¢ é †åºä¿è¨¼<br/>â€¢ è€éšœå®³æ€§                        | ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã®éåŒæœŸé€šä¿¡        |
| **UIæ›´æ–°é€šçŸ¥**           | WebSocket        | â€¢ åŒæ–¹å‘é€šä¿¡<br/>â€¢ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§<br/>â€¢ ä½ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰              | é€²æ—è¡¨ç¤ºã€ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰          |
| **ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–**         | S3 API           | â€¢ RESTful<br/>â€¢ æ¨™æº–äº’æ›<br/>â€¢ é«˜å¯ç”¨æ€§                               | MinIOã¨ã®é€£æºã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ |
| **Podé–“é€šä¿¡**            | gRPC             | â€¢ å‹å®‰å…¨<br/>â€¢ é«˜æ€§èƒ½<br/>â€¢ ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥å¯¾å¿œ                      | ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹å†…éƒ¨é€šä¿¡              |

#### **5.0.4. ç”»åƒé€ä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®è©³ç´°ä»•æ§˜**

##### **ğŸ“¨ KafkaçµŒç”±ã®ç”»åƒé€ä¿¡ä»•æ§˜**

```json
// Kafka Message Schema (JSONå½¢å¼)
{
  "client_id": "string",           // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè­˜åˆ¥å­
  "correlation_id": "string",      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆè¿½è·¡ID
  "image_data": "string",          // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ç”»åƒãƒ‡ãƒ¼ã‚¿
  "image_format": "jpeg|png|tiff", // ç”»åƒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  "image_size_bytes": 1048576,     // ç”»åƒã‚µã‚¤ã‚ºï¼ˆãƒã‚¤ãƒˆï¼‰
  "pipeline_config": {
    "pipeline_id": "string",
    "parameters": {},
    "priority": "high|normal|low"
  },
  "timestamp": "2025-07-12T10:30:00Z"
}
```

##### **ğŸš€ gRPCç”»åƒé€ä¿¡ä»•æ§˜**

```protobuf
// image_processing.proto
syntax = "proto3";

service ImageProcessingService {
  // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç”»åƒå‡¦ç†
  rpc ProcessImageStream(stream ImageChunk) returns (stream ProcessingResult);
  
  // å˜ç™ºç”»åƒå‡¦ç†
  rpc ProcessSingleImage(ImageRequest) returns (ProcessingResponse);
}

message ImageChunk {
  string correlation_id = 1;
  bytes image_data = 2;
  int32 chunk_index = 3;
  int32 total_chunks = 4;
  bool is_final_chunk = 5;
  ImageMetadata metadata = 6;
}

message ImageMetadata {
  string format = 1;
  int32 width = 2;
  int32 height = 3;
  string client_id = 4;
  PipelineConfig pipeline_config = 5;
}

message PipelineConfig {
  string pipeline_id = 1;
  map<string, string> parameters = 2;
  Priority priority = 3;
}

enum Priority {
  LOW = 0;
  NORMAL = 1;
  HIGH = 2;
}
```

### **5.1. API ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**

#### **5.1.1. RESTful APIè¨­è¨ˆ**

**ãƒ™ãƒ¼ã‚¹URL**: `https://api.imageflowcanvas.com/v1`

**å…±é€šä»•æ§˜**:
- ãƒ—ãƒ­ãƒˆã‚³ãƒ«ï¼šHTTPS
- èªè¨¼ï¼šBearer Token (JWT)
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ï¼š`application/json`
- ã‚¨ãƒ©ãƒ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼šRFC 7807æº–æ‹ 

#### **5.1.2. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§**

| ã‚«ãƒ†ã‚´ãƒª       | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ            | ãƒ¡ã‚½ãƒƒãƒ‰ | ç”¨é€”                 |
| -------------- | ------------------------- | -------- | -------------------- |
| èªè¨¼           | `/auth/login`             | POST     | ãƒ­ã‚°ã‚¤ãƒ³             |
| èªè¨¼           | `/auth/logout`            | POST     | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ           |
| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³   | `/pipelines`              | GET      | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ä¸€è¦§     |
| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³   | `/pipelines`              | POST     | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ä½œæˆ     |
| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³   | `/pipelines/{id}`         | GET      | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è©³ç´°     |
| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³   | `/pipelines/{id}`         | PUT      | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ›´æ–°     |
| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³   | `/pipelines/{id}`         | DELETE   | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å‰Šé™¤     |
| å®Ÿè¡Œ           | `/executions`             | POST     | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ     |
| å®Ÿè¡Œ           | `/executions/{id}`        | GET      | å®Ÿè¡ŒçŠ¶æ³å–å¾—         |
| å®Ÿè¡Œ           | `/executions/{id}/cancel` | POST     | å®Ÿè¡Œã‚­ãƒ£ãƒ³ã‚»ãƒ«       |
| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | `/components`             | GET      | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¸€è¦§   |
| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | `/components/{id}`        | GET      | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°   |
| ãƒ•ã‚¡ã‚¤ãƒ«       | `/files`                  | POST     | ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ |
| ãƒ•ã‚¡ã‚¤ãƒ«       | `/files/{id}`             | GET      | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ |

### **5.2. APIè©³ç´°ä»•æ§˜**

#### **5.2.1. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡ŒAPI**

```yaml
# POST /v1/executions
requestBody:
  content:
    multipart/form-data:
      schema:
        type: object
        properties:
          pipeline_id:
            type: string
            format: uuid
            description: å®Ÿè¡Œã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ID
          input_files:
            type: array
            items:
              type: string
              format: binary
            description: å…¥åŠ›ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
          parameters:
            type: object
            description: å®Ÿè¡Œæ™‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
            example:
              resize_width: 800
              ai_model: "yolo11"
              output_format: "jpeg"
          priority:
            type: string
            enum: [low, normal, high]
            default: normal

responses:
  '202':
    description: å®Ÿè¡Œè¦æ±‚å—ä»˜
    content:
      application/json:
        schema:
          type: object
          properties:
            execution_id:
              type: string
              format: uuid
            status:
              type: string
              example: "pending"
            estimated_completion:
              type: string
              format: date-time
```

#### **5.2.2. å®Ÿè¡ŒçŠ¶æ³å–å¾—API**

```yaml
# GET /v1/executions/{execution_id}
responses:
  '200':
    description: å®Ÿè¡ŒçŠ¶æ³
    content:
      application/json:
        schema:
          type: object
          properties:
            execution_id:
              type: string
              format: uuid
            pipeline_id:
              type: string
              format: uuid
            status:
              type: string
              enum: [pending, running, completed, failed, cancelled]
            progress:
              type: object
              properties:
                current_step:
                  type: string
                total_steps:
                  type: integer
                completed_steps:
                  type: integer
                percentage:
                  type: number
                  format: float
            steps:
              type: array
              items:
                type: object
                properties:
                  component_name:
                    type: string
                  status:
                    type: string
                  started_at:
                    type: string
                    format: date-time
                  completed_at:
                    type: string
                    format: date-time
            output_files:
              type: array
              items:
                type: object
                properties:
                  file_id:
                    type: string
                    format: uuid
                  filename:
                    type: string
                  download_url:
                    type: string
```

### **5.3. gRPC APIè¨­è¨ˆ**

#### **5.3.1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”»åƒå‡¦ç†**

```protobuf
syntax = "proto3";

package imageflow.v1;

service ImageProcessingService {
  // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç”»åƒå‡¦ç†
  rpc ProcessImageStream(stream ImageChunk) returns (stream ProcessingResult);
  
  // é€²æ—ç›£è¦–
  rpc WatchExecution(WatchRequest) returns (stream ExecutionUpdate);
}

message ImageChunk {
  string correlation_id = 1;
  bytes data = 2;
  int32 chunk_index = 3;
  int32 total_chunks = 4;
  bool is_final = 5;
  ImageMetadata metadata = 6;
}

message ImageMetadata {
  string format = 1;          // jpeg, png, tiff
  int32 width = 2;
  int32 height = 3;
  int64 file_size = 4;
  PipelineConfig pipeline = 5;
}

message PipelineConfig {
  string pipeline_id = 1;
  map<string, string> parameters = 2;
  Priority priority = 3;
}

enum Priority {
  PRIORITY_LOW = 0;
  PRIORITY_NORMAL = 1;
  PRIORITY_HIGH = 2;
}

message ProcessingResult {
  string execution_id = 1;
  Status status = 2;
  repeated OutputFile output_files = 3;
  string error_message = 4;
}

enum Status {
  STATUS_PENDING = 0;
  STATUS_RUNNING = 1;
  STATUS_COMPLETED = 2;
  STATUS_FAILED = 3;
}

message OutputFile {
  string file_id = 1;
  string filename = 2;
  string download_url = 3;
  int64 file_size = 4;
}
```

### **5.4. WebSocket APIè¨­è¨ˆ**

#### **5.4.1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—é€šçŸ¥**

```typescript
// WebSocketæ¥ç¶šï¼šwss://api.imageflowcanvas.com/v1/ws

// èªè¨¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
interface AuthMessage {
  type: 'auth';
  token: string;
}

// å®Ÿè¡Œç›£è¦–é–‹å§‹
interface WatchMessage {
  type: 'watch';
  execution_id: string;
}

// é€²æ—é€šçŸ¥
interface ProgressMessage {
  type: 'progress';
  execution_id: string;
  data: {
    status: 'pending' | 'running' | 'completed' | 'failed';
    current_step: string;
    progress_percentage: number;
    step_details: {
      component_name: string;
      status: string;
      started_at?: string;
      completed_at?: string;
      resource_usage?: {
        cpu_usage: number;
        memory_usage: number;
        gpu_usage?: number;
      };
    }[];
  };
}

// ã‚¨ãƒ©ãƒ¼é€šçŸ¥
interface ErrorMessage {
  type: 'error';
  execution_id: string;
  error: {
    code: string;
    message: string;
    details?: any;
  };
}
```

---

## **é–¢é€£æ–‡æ›¸**

- [æ¦‚è¦è¨­è¨ˆ](./0300_æ¦‚è¦è¨­è¨ˆ.md)
- [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](./0303_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ.md)
- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ](./0306_ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ.md)
