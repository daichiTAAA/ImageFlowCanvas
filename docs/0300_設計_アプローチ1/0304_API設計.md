_# ImageFlowCanvas APIè¨­è¨ˆæ›¸

_# æ–‡æ›¸ç®¡ç†æƒ…å ±

| é …ç›®       | å†…å®¹                      |
| ---------- | ------------------------- |
| æ–‡æ›¸å     | ImageFlowCanvas APIè¨­è¨ˆæ›¸ |
| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 1.3                       |
| ä½œæˆæ—¥     | 2025å¹´7æœˆ12æ—¥             |
| æ›´æ–°æ—¥     | 2025å¹´8æœˆ24æ—¥             |


---

# 1. ãƒ—ãƒ­ãƒˆã‚³ãƒ«è¨­è¨ˆ

## 1.1. ãƒãƒƒãƒå‡¦ç†ï¼ˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œï¼‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant Client as ğŸ–¥ï¸ å¤–éƒ¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant Gateway as ğŸšª API Gateway
    participant API as ğŸ”§ Backend API
    participant gRPCServices as âš¡ gRPCå¸¸é§ã‚µãƒ¼ãƒ“ã‚¹
    participant MinIO as ğŸ’¾ MinIO
    participant Kafka as ğŸ“¨ Kafka
    participant WebUI as ğŸŒ Web UI

    Note over Client, WebUI: 1. ãƒãƒƒãƒå‡¦ç†è¦æ±‚
    Client->>Gateway: REST API<br/>POST /executions<br/>multipart/form-data<br/>ï¼ˆç”»åƒãƒ•ã‚¡ã‚¤ãƒ« + pipeline_idï¼‰
    Gateway->>API: HTTP/1.1è»¢é€
    API->>MinIO: ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (S3 API)
    MinIO-->>API: file_idè¿”å´
    API-->>Client: execution_idå³åº§ã«è¿”å´
    
    Note over Client, WebUI: 2. ç›´æ¥gRPCå®Ÿè¡Œï¼ˆ40-100msï¼‰
    API->>gRPCServices: gRPCå‘¼ã³å‡ºã—<br/>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
    gRPCServices->>MinIO: ç”»åƒå–å¾— (S3 API)
    gRPCServices->>gRPCServices: ç”»åƒå‡¦ç†å®Ÿè¡Œ<br/>ï¼ˆãƒªã‚µã‚¤ã‚ºâ†’AIæ¤œçŸ¥â†’ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
    gRPCServices->>MinIO: çµæœä¿å­˜ (S3 API)
    gRPCServices-->>API: å‡¦ç†å®Œäº†é€šçŸ¥ (40-100ms)
    
    Note over Client, WebUI: 3. é€²æ—é€šçŸ¥ï¼ˆç›£è¦–ç”¨ï¼‰
    gRPCServices->>Kafka: é€²æ—é€šçŸ¥<br/>Topic: pipeline-progress<br/>{<br/>  "execution_id": "exec-123",<br/>  "status": "completed",<br/>  "step_id": "resize-step-1"<br/>}
    
    Note over Client, WebUI: 4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ UIæ›´æ–°
    API->>WebUI: WebSocketé€ä¿¡<br/>{<br/>  "type": "execution_update",<br/>  "execution_id": "exec-123",<br/>  "status": "completed"<br/>}
    
    Note over Client, WebUI: 5. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ï¼ˆå¤±æ•—æ™‚ã®ã¿ï¼‰
    API-->>Kafka: Kafkaãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯<br/>ï¼ˆç›´æ¥gRPCå¤±æ•—æ™‚ã®ã¿ï¼‰<br/>Topic: image-processing-requests
```
    
## 1.2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ï¼ˆæ˜ åƒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 1.2.1. å˜ä¸€è·¯ã‚¤ãƒ³ã‚¸ã‚§ã‚¹ãƒˆï¼‹ã‚µãƒ¼ãƒåˆ†å²ï¼ˆWHEP/WebRTCï¼‰

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€ãƒ‡ãƒã‚¤ã‚¹ï¼ˆTHINKLETç­‰ï¼‰ã‹ã‚‰ã®æ˜ åƒ/éŸ³å£°ã¯ WHEP/WebRTC ã«ã‚ˆã‚‹ã€Œå˜ä¸€è·¯ã‚¤ãƒ³ã‚¸ã‚§ã‚¹ãƒˆã€ã§ Ingest Gateway ã«é€ä¿¡ã—ã€ã‚µãƒ¼ãƒå´ã§AI/éŒ²ç”»/é…ä¿¡ã«åˆ†å²ã—ã¾ã™ã€‚ç«¯æœ«ã‚¢ãƒ—ãƒªã‚„Webã¯ã‚µãƒ¼ãƒã‹ã‚‰é…ä¿¡ãƒ»é€šçŸ¥ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant Dev as ãƒ‡ãƒã‚¤ã‚¹(THINKLET)
    participant Ingest as Ingest Gateway (WHEP/RTSP)
    participant API as API Gateway/Backend API
    participant AI as gRPC AI Worker
    participant DS as Data Storage
    participant Web as Web/ç«¯æœ«ã‚¢ãƒ—ãƒª

    Note over Dev,Ingest: 1) WHEP(WebRTC) å˜ä¸€è·¯ã‚¤ãƒ³ã‚¸ã‚§ã‚¹ãƒˆ
    Dev->>Ingest: WHEP: SDP Offer/ICE + RTP(Media)

    Note over Ingest,AI: 2) ã‚µãƒ¼ãƒåˆ†å²
    Ingest->>AI: gRPC Stream (Frame Extractor)
    Ingest->>DS: Remux/Segment (éŒ²ç”»/ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–)

    Note over API,Web: 3) åˆ¶å¾¡ãƒ»é€šçŸ¥
    Dev->>API: REST/gRPC (ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿)
    AI-->>API: æ¨è«–çµæœ/ã‚¤ãƒ™ãƒ³ãƒˆ
    API-->>Web: WebSocket/REST (çµæœé…ä¿¡/ç›£è¦–)
```

### 1.2.2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šã®ä½¿ã„åˆ†ã‘ï¼ˆWHEPä¸­å¿ƒï¼‰

| ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç¨®åˆ¥           | é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«                     | å½¹å‰²ãƒ»åˆ©ç‚¹                                      |
| :------------------------- | :--------------------------------- | :---------------------------------------------- |
| **ğŸ–¥ï¸ ãƒ‡ãƒã‚¤ã‚¹(THINKLETç­‰)** | WebRTC(WHEP), REST/gRPC(åˆ¶å¾¡/ãƒ¡ã‚¿) | å˜ä¸€è·¯ã‚¤ãƒ³ã‚¸ã‚§ã‚¹ãƒˆã€åˆ¶å¾¡/ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã€å†æ¥ç¶šåˆ¶å¾¡ |
| **ğŸ–¥ï¸ ç«¯æœ«ã‚¢ãƒ—ãƒª**           | REST/gRPC, WebSocket               | çµæœå–å¾—ã€è¨­å®š/åˆ¶å¾¡ã€ç›£è¦–é€šçŸ¥                   |
| **ğŸŒ Webãƒ–ãƒ©ã‚¦ã‚¶**          | WebSocket, REST                    | ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ã€ç®¡ç†æ“ä½œ  |

---

### 1.2.3. ç«¯æœ«ã‚¢ãƒ—ãƒªï¼ˆãƒãƒ³ãƒ‡ã‚£ãƒ¼ã‚¿ãƒ¼ãƒŸãƒŠãƒ«/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼‰â†’ gRPC ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

ç«¯æœ«ã‚¢ãƒ—ãƒªï¼ˆKotlin Multiplatform: ãƒãƒ³ãƒ‡ã‚£ãƒ¼ã‚¿ãƒ¼ãƒŸãƒŠãƒ«/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼‰ã¯ã€WebRTCã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¹ãƒˆã§ã¯ãªãã€gRPCåŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ã‚µãƒ¼ãƒãƒ¼ã¸ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆã¾ãŸã¯åœ§ç¸®ç”»åƒãƒãƒ£ãƒ³ã‚¯ï¼‰ã‚’é€ä¿¡ã—ã€ä½é…å»¶ãªAIçµæœã‚’å—ä¿¡ã—ã¾ã™ã€‚åˆ¶å¾¡ãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯gRPC/RESTã€é€šçŸ¥ã¯WebSocketã§é…ä¿¡ã—ã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant Term as ç«¯æœ«ã‚¢ãƒ—ãƒªï¼ˆãƒãƒ³ãƒ‡ã‚£ãƒ¼ã‚¿ãƒ¼ãƒŸãƒŠãƒ«/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼‰
    participant API as API Gateway/Backend API (gRPC/REST)
    participant AI as gRPC AI Worker
    participant DS as Data Storage (MinIO)
    participant Web as Web/ç›£è¦–UI

    Note over Term,API: 1) gRPC åŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°é–‹å§‹ï¼ˆèªè¨¼æ¸ˆã¿ãƒãƒ£ãƒãƒ«ï¼‰
    Term->>API: gRPC: OpenStream(frames | encoded images, metadata)

    Note over API,AI: 2) ã‚µãƒ¼ãƒå†…éƒ¨è»¢é€/åˆ†å²
    API->>AI: gRPC Stream (Frame pipeline)
    API->>DS: ï¼ˆä»»æ„ï¼‰é¸æŠãƒ•ãƒ¬ãƒ¼ãƒ ã®ä¿å­˜/ã‚µãƒ ãƒã‚¤ãƒ«

    Note over AI,Term: 3) æ¨è«–â†’çµæœã‚¹ãƒˆãƒªãƒ¼ãƒ è¿”å´
    AI-->>API: gRPC: InferenceResult (detections, scores, overlays)
    API-->>Term: gRPC: InferenceResult (ä½é…å»¶è¿”å´)

    Note over API,Web: 4) ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°é€šçŸ¥/åˆ¶å¾¡
    AI-->>API: çŠ¶æ…‹/çµ±è¨ˆã‚¤ãƒ™ãƒ³ãƒˆ
    API-->>Web: WebSocket: stats/eventsï¼ˆfps, latency, confidenceï¼‰
```

ç«¯æœ«ã‚¢ãƒ—ãƒª gRPC ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã®I/Oä»•æ§˜ï¼ˆä»£è¡¨ï¼‰

- å…¥åŠ›ï¼ˆTermâ†’APIï¼‰
  - ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: `FrameChunk { content_type, bytes | zero-copy ref, ts, product_info?, session_id }`
  - åˆ¶å¾¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: `Control { start/stop, qos, crop/roi, rate_hint }`
- å‡ºåŠ›ï¼ˆAPIâ†’Termï¼‰
  - ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: `InferenceResult { detections[], score, overlay?, processing_ms }`
  - ã‚¨ãƒ©ãƒ¼/çŠ¶æ…‹: `Status { code, message, retry_after? }`

è£œè¶³
- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãŒå¿…è¦ãªå ´åˆã¯ã€ç«¯æœ«å´ã¯é™æ­¢ç”»/å¿…è¦ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’RESTã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã¾ãŸã¯APIãŒé¸æŠãƒ•ãƒ¬ãƒ¼ãƒ ã‚’MinIOã¸ä¿å­˜ã—ã¾ã™ã€‚
- å¸¯åŸŸãƒ»é›»åŠ›çŠ¶æ³ã«å¿œã˜ãŸQoSã¯ã€`Control` ã¨ã‚µãƒ¼ãƒå´ã®ãƒãƒªã‚·ãƒ¼ã§åŒæ–¹å‘åˆ¶å¾¡ã—ã¾ã™ã€‚

## 1.3. ãƒ—ãƒ­ãƒˆã‚³ãƒ«æœ€é©åŒ–ã®é¸æŠåŸºæº–

| ğŸ¯ ç”¨é€”ãƒ»ã‚·ãƒŠãƒªã‚ª     | ğŸ–¥ï¸ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç¨®åˆ¥           | ğŸš€ æ¨å¥¨ãƒ—ãƒ­ãƒˆã‚³ãƒ«    | âš¡ æ€§èƒ½ç‰¹æ€§                                                       | ğŸ“ é¸æŠç†ç”±                               |
| :------------------- | :--------------------------- | :------------------ | :--------------------------------------------------------------- | :--------------------------------------- |
| ãƒãƒƒãƒç”»åƒå‡¦ç†       | Kotlin Multiplatform/Webå…±é€š | REST API + ç›´æ¥gRPC | â€¢ è¶…é«˜é€Ÿå‡¦ç† (40-100ms)<br/>â€¢ ãƒ•ã‚¡ã‚¤ãƒ«æ°¸ç¶šåŒ–<br/>â€¢ é«˜ä¿¡é ¼æ€§      | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã€çµæœä¿å­˜ãŒå¿…è¦ãªç”¨é€”   |
| ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ˜ åƒå‡¦ç† | ğŸ–¥ï¸ Kotlin Multiplatformã‚¢ãƒ—ãƒª | gRPC Streaming      | â€¢ æ¥µä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· (<30ms)<br/>â€¢ ãƒã‚¤ãƒ†ã‚£ãƒ–æ€§èƒ½<br/>â€¢ ãƒã‚¤ãƒŠãƒªåŠ¹ç‡ | ãƒ©ã‚¤ãƒ–é…ä¿¡ã€ç›£è¦–ã‚«ãƒ¡ãƒ©ã€æ¤œæŸ»ã‚·ã‚¹ãƒ†ãƒ ç”¨é€” |
| ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ˜ åƒå‡¦ç† | ğŸŒ Webãƒ–ãƒ©ã‚¦ã‚¶                | WebSocket           | â€¢ ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§<br/>â€¢ ä¸­ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· (<100ms)<br/>â€¢ JSONå½¢å¼      | ãƒ–ãƒ©ã‚¦ã‚¶ãƒ™ãƒ¼ã‚¹ç›£è¦–ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰       |
| é€²æ—é€šçŸ¥ãƒ»ç›£è¦–       | Kotlin Multiplatform/Webå…±é€š | Kafka + WebSocket   | â€¢ éåŒæœŸé€šçŸ¥<br/>â€¢ é«˜ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ<br/>â€¢ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§           | ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°         |
| ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†   | ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨                 | Kafka Consumer      | â€¢ é«˜ä¿¡é ¼æ€§<br/>â€¢ é †åºä¿è¨¼<br/>â€¢ è€éšœå®³æ€§                         | ç›´æ¥gRPCå¤±æ•—æ™‚ã®ä»£æ›¿å‡¦ç†                 |
| UIæ›´æ–°é€šçŸ¥           | ğŸ–¥ï¸ Kotlin Multiplatformã‚¢ãƒ—ãƒª | gRPC Push/WebSocket | â€¢ åŒæ–¹å‘é€šä¿¡<br/>â€¢ å‹å®‰å…¨<br/>â€¢ ä½ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰                 | Kotlin Multiplatformã‚¢ãƒ—ãƒªå†…ã®é€²æ—è¡¨ç¤º   |
| UIæ›´æ–°é€šçŸ¥           | ğŸŒ Webãƒ–ãƒ©ã‚¦ã‚¶                | WebSocket           | â€¢ åŒæ–¹å‘é€šä¿¡<br/>â€¢ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§<br/>â€¢ ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–             | Webç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰                    |
| ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–         | ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨                 | S3 API              | â€¢ RESTful<br/>â€¢ æ¨™æº–äº’æ›<br/>â€¢ é«˜å¯ç”¨æ€§                          | MinIOã¨ã®é€£æºã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸    |
| ã‚µãƒ¼ãƒ“ã‚¹é–“å†…éƒ¨é€šä¿¡   | ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨                 | ç›´æ¥gRPC            | â€¢ å‹å®‰å…¨<br/>â€¢ è¶…é«˜æ€§èƒ½<br/>â€¢ Protocol Buffers                   | ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹å†…éƒ¨ã®é«˜é€Ÿé€šä¿¡           |

## 1.4. å‡¦ç†æ–¹å¼åˆ¥ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜

### 1.4.1. ğŸ“‹ ãƒãƒƒãƒå‡¦ç†ï¼ˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œï¼‰ä»•æ§˜

REST API multipart/form-dataã§ã®ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨ã€ç›´æ¥gRPCå®Ÿè¡Œã«ã‚ˆã‚‹40-100msé«˜é€Ÿå‡¦ç†ã‚’æä¾›ã€‚
å®Ÿè¡Œå®Œäº†å¾Œã€WebSocketã§é€²æ—é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã€‚

### 1.4.2. ğŸ¬ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ï¼ˆæ˜ åƒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰ä»•æ§˜

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç¨®åˆ¥ã«å¿œã˜ãŸæœ€é©åŒ–ã•ã‚ŒãŸã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å®Ÿè£…ï¼š

**ğŸ–¥ï¸ Kotlin Multiplatformã‚¢ãƒ—ãƒªå‘ã‘ - gRPCã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°**
- ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ãƒã‚¤ãƒ†ã‚£ãƒ–gRPC bidirectional streaming
- ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: <30msï¼ˆæœ€é«˜æ€§èƒ½ï¼‰
- ãƒ‡ãƒ¼ã‚¿å½¢å¼: Protocol Buffersï¼ˆãƒã‚¤ãƒŠãƒªåŠ¹ç‡ï¼‰
- æ¥ç¶šæ–¹å¼: ç›´æ¥API Gatewayæ¥ç¶š

**ğŸŒ Webãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘ - WebSocketã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°**
- ãƒ—ãƒ­ãƒˆã‚³ãƒ«: WebSocket binary/text messaging
- ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: <100msï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶ç´„å†…ï¼‰
- ãƒ‡ãƒ¼ã‚¿å½¢å¼: JSON + Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆäº’æ›æ€§é‡è¦–ï¼‰
- æ¥ç¶šæ–¹å¼: API GatewayçµŒç”±ã§ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«å¤‰æ›

### 1.4.3. ğŸ“¨ ç›£è¦–ãƒ»é€šçŸ¥ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜

Kafkaã«ã‚ˆã‚‹é€²æ—é€šçŸ¥ã¨WebSocketã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã§ã€
å®Ÿè¡ŒçŠ¶æ³ã®ç›£è¦–ã¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºã‚’è¡Œã„ã¾ã™ã€‚

# 2. API ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

## 2.1. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰APIã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 2.1.1. Backend APIè¨­è¨ˆæ€æƒ³

ImageFlowCanvasã®Backend APIã¯ã€**FastAPI + grpcio**ã«ã‚ˆã‚‹ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å®Ÿè£…ã‚’æ¡ç”¨ã—ã€è¤‡æ•°ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’çµ±åˆç®¡ç†ã™ã‚‹ã€Œå¸ä»¤å¡”ã€ã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚

#### 2.1.1.1. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹æˆ**

```mermaid
graph TB
    A[FastAPI Router] --> B[REST Endpoints]
    A --> C[WebSocket Handler]
    A --> D[gRPC Gateway]
    
    D --> E[Internal gRPC Services]
    E --> F[AI Detection Service]
    E --> G[Image Processing Service]
    E --> H[Stream Processing Service]
    
    B --> I[Database Layer]
    C --> J[Kafka Producer]
    D --> K[Protocol Translation]
```

#### 2.1.1.2. **ãƒ—ãƒ­ãƒˆã‚³ãƒ«é¸æŠæ–¹é‡**

| ç”¨é€”             | ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ç†ç”±                                   |
| ---------------- | ---------- | -------------------------------------- |
| ç®¡ç†ç”»é¢ãƒ»è¨­å®š   | REST API   | ã‚·ãƒ³ãƒ—ãƒ«ãªæ“ä½œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡         |
| ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ | WebSocket  | ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ã€åŒæ–¹å‘é€šä¿¡             |
| é«˜æ€§èƒ½AIå‡¦ç†     | gRPC       | å‹å®‰å…¨æ€§ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã€ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· |
| éåŒæœŸå‡¦ç†       | Kafka      | é«˜ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã€è€éšœå®³æ€§               |


### 2.1.2. ãƒ—ãƒ­ãƒˆã‚³ãƒ«çµ±åˆæˆ¦ç•¥

| ãƒ—ãƒ­ãƒˆã‚³ãƒ«         | æ‹…å½“é ˜åŸŸ             | å®Ÿè£…æŠ€è¡“          | ç‰¹å¾´                               |
| ------------------ | -------------------- | ----------------- | ---------------------------------- |
| **FastAPI**        | REST API + WebSocket | uvicorn + asyncio | è‡ªå‹•ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆã€éåŒæœŸå‡¦ç†   |
| **grpcio**         | gRPCã‚µãƒ¼ãƒãƒ¼         | grpcio + asyncio  | é«˜æ€§èƒ½ã€å‹å®‰å…¨æ€§ã€Protocol Buffers |
| **WebSocket**      | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥     | FastAPI WebSocket | åŒæ–¹å‘é€šä¿¡ã€ç–çµåˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£   |
| **Kafka Consumer** | é€²æ—é…ä¿¡             | aiokafka          | éåŒæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ« |

## 2.2. RESTful APIè¨­è¨ˆ

### 2.2.1. åŸºæœ¬ä»•æ§˜
- ãƒ™ãƒ¼ã‚¹URL: `https://api.imageflowcanvas.com/v1`
- ãƒ—ãƒ­ãƒˆã‚³ãƒ«ï¼šHTTPSå¿…é ˆ
- èªè¨¼ï¼šBearer Token (JWT)
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ï¼š`application/json`
- ã‚¨ãƒ©ãƒ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼šRFC 7807æº–æ‹ 

### 2.2.2. å®Ÿè£…æ¸ˆã¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

| ã‚«ãƒ†ã‚´ãƒª         | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                  | ãƒ¡ã‚½ãƒƒãƒ‰  | ç”¨é€”                 | å®Ÿè£…çŠ¶æ³ |
| ---------------- | ------------------------------- | --------- | -------------------- | -------- |
| èªè¨¼             | `/auth/login`                   | POST      | ãƒ­ã‚°ã‚¤ãƒ³             | âœ…        |
| èªè¨¼             | `/auth/logout`                  | POST      | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ           | âœ…        |
| ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯   | `/health`                       | GET       | ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª     | âœ…        |
| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³     | `/pipelines`                    | GET       | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ä¸€è¦§     | âœ…        |
| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³     | `/pipelines`                    | POST      | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ä½œæˆ     | âœ…        |
| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³     | `/pipelines/{id}`               | GET       | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è©³ç´°     | âœ…        |
| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³     | `/pipelines/{id}`               | PUT       | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ›´æ–°     | âœ…        |
| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³     | `/pipelines/{id}`               | DELETE    | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å‰Šé™¤     | âœ…        |
| å®Ÿè¡Œ             | `/executions`                   | POST      | ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ     | âœ…        |
| å®Ÿè¡Œ             | `/executions/{id}`              | GET       | å®Ÿè¡ŒçŠ¶æ³å–å¾—         | âœ…        |
| å®Ÿè¡Œ             | `/executions/{id}/cancel`       | POST      | å®Ÿè¡Œã‚­ãƒ£ãƒ³ã‚»ãƒ«       | âœ…        |
| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ   | `/components`                   | GET       | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¸€è¦§   | âœ…        |
| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ   | `/components/{id}`              | GET       | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°   | âœ…        |
| ãƒ•ã‚¡ã‚¤ãƒ«         | `/files`                        | POST      | ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ | âœ…        |
| ãƒ•ã‚¡ã‚¤ãƒ«         | `/files/{id}`                   | GET       | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ | âœ…        |
| æ¤œæŸ»ãƒã‚¹ã‚¿       | `/inspection-instructions`      | GET       | æ¤œæŸ»æŒ‡ç¤ºä¸€è¦§         | âœ…        |
| æ¤œæŸ»ãƒã‚¹ã‚¿       | `/inspection-instructions`      | POST      | æ¤œæŸ»æŒ‡ç¤ºä½œæˆ         | âœ…        |
| æ¤œæŸ»ãƒã‚¹ã‚¿       | `/inspection-instructions/{id}` | GET       | æ¤œæŸ»æŒ‡ç¤ºè©³ç´°         | âœ…        |
| æ¤œæŸ»å®Ÿè¡Œ         | `/inspection-executions`        | POST      | æ¤œæŸ»å®Ÿè¡Œ             | âœ…        |
| æ¤œæŸ»å®Ÿè¡Œ         | `/inspection-executions/{id}`   | GET       | æ¤œæŸ»çµæœå–å¾—         | âœ…        |
| gRPCã‚µãƒ¼ãƒ“ã‚¹     | `/grpc-services`                | GET       | gRPCã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³     | âœ…        |
| ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ  | `/camera-stream`                | WebSocket | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ˜ åƒ     | âœ…        |

### 2.2.3. WebSocketå°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- `/ws/execution/{execution_id}`: ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œé€²æ—é€šçŸ¥
- `/ws/inspection/{execution_id}`: æ¤œæŸ»å®Ÿè¡Œé€²æ—é€šçŸ¥  
- `/ws/system-status`: ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
- `/ws/camera-stream`: ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

# 3. APIè©³ç´°ä»•æ§˜

## 3.1. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡ŒAPIï¼ˆç›´æ¥gRPCå®Ÿè¡Œï¼‰

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `POST /v1/executions`

æ©Ÿèƒ½: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œ

ãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼: multipart/form-data
- pipeline_id (å¿…é ˆ): å®Ÿè¡Œã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®UUID
- input_files (å¿…é ˆ): å…¥åŠ›ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè¤‡æ•°å¯¾å¿œï¼‰
- parameters (ã‚ªãƒ—ã‚·ãƒ§ãƒ³): å®Ÿè¡Œæ™‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆJSONå½¢å¼ï¼‰
- priority (ã‚ªãƒ—ã‚·ãƒ§ãƒ³): å„ªå…ˆåº¦ï¼ˆlow/normal/highï¼‰

### 3.1.1. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡ŒAPIè©³ç´°ä»•æ§˜
```
POST /api/v1/executions
Content-Type: application/json

{
  "pipeline_id": "pipeline-67890",
  "input_files": ["file1.jpg", "file2.png"],
  "parameters": {
    "resize_width": 512,
    "ai_threshold": 0.8
  },
  "client_id": "client-123"
}

Response:
{
  "execution_id": "exec-12345",
  "status": "queued",
  "estimated_duration_ms": 5000,
  "websocket_url": "ws://api.example.com/ws/exec-12345"
}
```

### 3.1.2. æ¤œæŸ»æŒ‡ç¤ºç®¡ç†API

#### 3.1.2.1. æ¤œæŸ»æŒ‡ç¤ºä¸€è¦§å–å¾—API
```
GET /api/v1/inspection-instructions?page=1&per_page=20

Response:
{
  "instructions": [
    {
      "id": "instruction-12345",
      "name": "åŸºæ¿Aå‹å¼æ¤œæŸ»",
      "description": "åŸºæ¿Aå‹å¼ã®å¤–è¦³æ¤œæŸ»",
      "product_code": "PROD-001",
      "version": "1.0",
      "created_at": "2025-08-08T10:00:00Z"
    }
  ],
  "total_count": 1,
  "page": 1,
  "per_page": 20
}
```

#### 3.1.2.2. æ¤œæŸ»æŒ‡ç¤ºè©³ç´°å–å¾—API
```
GET /api/v1/inspection-instructions/{id}

Response:
{
  "id": "instruction-12345",
  "name": "åŸºæ¿Aå‹å¼æ¤œæŸ»",
  "description": "åŸºæ¿Aå‹å¼ã®å¤–è¦³æ¤œæŸ»",
  "product_code": "PROD-001",
  "version": "1.0",
  "metadata": {
    "qr_pattern": "PROD-001-{YYYYMMDD}-{SEQ}",
    "specifications": {...}
  },
  "inspection_items": [
    {
      "id": "item-001",
      "name": "è¡¨é¢å‚·ãƒã‚§ãƒƒã‚¯",
      "description": "åŸºæ¿è¡¨é¢ã®å‚·ã‚’æ¤œæŸ»"
    }
  ],
  "created_at": "2025-08-08T10:00:00Z"
}
```

### 3.1.3. æ¤œæŸ»å®Ÿè¡ŒAPI

#### 3.1.3.1. æ¤œæŸ»å®Ÿè¡Œé–‹å§‹API
```
POST /api/v1/inspection-executions
Content-Type: multipart/form-data

FormData:
- instruction_id: "instruction-12345"
- qr_code: "PROD-001-20250808-001" (optional)
- images: [File1.jpg, File2.jpg] (multiple files)

Response:
{
  "execution_id": "exec-12345",
  "instruction_id": "instruction-12345",
  "status": "pending",
  "estimated_duration_ms": 5000,
  "websocket_url": "ws://api.example.com/ws/inspection/exec-12345"
}
```

#### 3.1.3.2. æ¤œæŸ»çµæœå–å¾—API
```
GET /api/v1/inspection-executions/{execution_id}

Response:
{
  "execution_id": "exec-12345",
  "instruction_id": "instruction-12345",
  "status": "completed",
  "qr_code": "PROD-001-20250808-001",
  "execution_time_ms": 4250,
  "overall_result": "PASS",
  "confidence": 0.95,
  "ai_results": [
    {
      "item_id": "item-001",
      "result": "PASS",
      "confidence": 0.98,
      "detection_data": {...}
    }
  ],
  "human_verification": {
    "final_result": "PASS",
    "notes": "å¤–è¦³è‰¯å¥½",
    "verified_by": "user-123",
    "verified_at": "2025-08-08T10:05:00Z"
  },
  "created_at": "2025-08-08T10:00:00Z",
  "completed_at": "2025-08-08T10:05:00Z"
}
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
- 202: å®Ÿè¡Œè¦æ±‚å—ä»˜ï¼ˆ40-100mså¾Œã«å®Œäº†äºˆå®šï¼‰
- 400: ç„¡åŠ¹ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- 500: ç›´æ¥gRPCå®Ÿè¡Œå¤±æ•—ï¼ˆKafkaãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰

## 3.2. å®Ÿè¡ŒçŠ¶æ³å–å¾—APIï¼ˆè¶…é«˜é€Ÿå®Œäº†å¯¾å¿œï¼‰

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `GET /v1/executions/{execution_id}`

æ©Ÿèƒ½: ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã®çŠ¶æ³ã‚’å–å¾—

### 3.2.1. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çŠ¶æ³å–å¾—APIè©³ç´°ä»•æ§˜
```
GET /api/v1/executions/{execution_id}

Response:
{
  "execution_id": "exec-12345",
  "pipeline_id": "pipeline-67890",
  "status": "running",
  "progress_percentage": 75.5,
  "current_step": "ai_detection",
  "elapsed_time_ms": 3750,
  "estimated_remaining_ms": 1250,
  "results": {
    "output_files": ["processed_file1.jpg"],
    "metadata": {...}
  }
}
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹æƒ…å ±:
- execution_id: å®Ÿè¡ŒID
- status: å®Ÿè¡ŒçŠ¶æ³ï¼ˆpending/running/completed/failed/cancelledï¼‰
- execution_mode: å®Ÿè¡Œæ–¹å¼ï¼ˆdirect_grpc/kafka_fallbackï¼‰
- processing_time_ms: å®Ÿéš›ã®å‡¦ç†æ™‚é–“
- progress: é€²æ—æƒ…å ±
- steps: å„ã‚¹ãƒ†ãƒƒãƒ—ã®è©³ç´°çŠ¶æ³
- output_files: å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±

## 3.3. THINKLET ä¸€äººç§°æ˜ åƒ APIï¼ˆçµ±åˆæ˜ åƒç®¡ç†åŸºç›¤ï¼‰

THINKLETãƒ‡ãƒã‚¤ã‚¹ã®ä¸€äººç§°æ˜ åƒã‚’çµ±åˆç®¡ç†ã™ã‚‹APIç¾¤ã€‚

### 3.3.1. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§ï¼ˆ/api/v1/thinklet/*ï¼‰

| åŒºåˆ†       | ãƒ‘ã‚¹                                               | ãƒ¡ã‚½ãƒƒãƒ‰ | æ¦‚è¦                                        |
| ---------- | -------------------------------------------------- | -------- | ------------------------------------------- |
| ãƒ‡ãƒã‚¤ã‚¹   | `/api/v1/thinklet/devices/register`                | POST     | THINKLETãƒ‡ãƒã‚¤ã‚¹ã®ç™»éŒ²                      |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ | `/api/v1/thinklet/sessions`                        | POST     | ã‚¤ãƒ³ã‚¸ã‚§ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆWHEPç™ºè¡Œï¼‰      |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ | `/api/v1/thinklet/sessions/{session_id}/telemetry` | POST     | ãƒ†ãƒ¬ãƒ¡ãƒˆãƒª/ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆé€ä¿¡                 |
| åˆ¶å¾¡       | `/api/v1/thinklet/control`                         | POST     | éŒ²ç”»é–‹å§‹/åœæ­¢ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼åœæ­¢ãƒ»QoSåˆ‡æ›¿    |
| æ¤œæŸ»é€£æº   | `/api/v1/thinklet/inspections/start`               | POST     | æ¤œæŸ»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé–‹å§‹ï¼ˆè£½å“æƒ…å ±ç´ã¥ã‘ï¼‰      |
| ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ | `/api/v1/thinklet/segments/close`                  | POST     | æ¤œæŸ»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç¢ºå®šï¼ˆãƒ¡ã‚¿/ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç´ä»˜ï¼‰ |

æ³¨æ„:
- ãƒ¡ãƒ‡ã‚£ã‚¢è‡ªä½“ã®WHEPä¿¡å·äº¤æ›ã¨RTPã¯ Ingest/é…ä¿¡ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ï¼ˆä¾‹: MediaMTXï¼‰ãŒæ‹…å½“ã—ã€æœ¬APIã¯URL/ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã¨ã—ã¦å‹•ä½œã™ã‚‹ã€‚
- RBACã«ã‚ˆã‚Šã€è£…ç€è€…è‡ªèº«/å“è³ªç®¡ç†è€…/ç®¡ç†è€…ã®ã¿ãŒè©²å½“ãƒ‡ãƒ¼ã‚¿ã¸ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã€‚

### 3.3.2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆAPIï¼ˆWHEPç™ºè¡Œï¼‰

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `POST /api/v1/thinklet/sessions`

ç›®çš„: å˜ä¸€è·¯ã‚¤ãƒ³ã‚¸ã‚§ã‚¹ãƒˆã®é–‹å§‹ã«å…ˆç«‹ã¡ã€WHEP URLã¨èªå¯ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ‰•ã„å‡ºã™ã€‚æ¤œæŸ»æ–‡è„ˆã‚’åŒæ™‚ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåŒ–ã—ã¦ `ingest_sessions.metadata` ã«ä¿æŒï¼ˆ0302å‚ç…§ï¼‰ã€‚

ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä¾‹ï¼‰:
```json
POST /api/v1/thinklet/sessions
Content-Type: application/json

{
  "thinklet_device_id": "THINKLET-001",
  "worker_id": "worker_123",
  "product": {
    "product_id": "a3f1...",
    "work_order_id": "WO-20250824-001",
    "instruction_id": "INS-20250824-001"
  },
  "qos_preset": "high",       
  "view_angle": "horizontal_wide"
}
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆä¾‹ï¼‰:
```json
{
  "session_id": "b28f...",
  "whep_url": "https://ingest.example.local/whep/thinklet/THINKLET-001",
  "auth_token": "eyJhbGci...",
  "expires_at": "2025-08-24T10:00:00Z"
}
```

å‚™è€ƒ:
- `session_id` ã¯ `ingest_sessions.id` ã«ä¸€è‡´ã€‚`qos_preset` ã¯ 0302ã®æŠ½å‡ºãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡ã¨å¯¾å¿œã€‚

### 3.3.3. ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªAPIï¼ˆãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆï¼‰

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `POST /api/v1/thinklet/sessions/{session_id}/telemetry`

ç›®çš„: æ¥ç¶šçŠ¶æ…‹ãƒ»QoSãƒ»è£…ç€çŠ¶æ…‹ãƒ»è¦–é‡è§’ãªã©ã‚’æ™‚ç³»åˆ—ã§å—ä¿¡ã—ã€`thinklet_stream_metrics` ã«è“„ç©ã€‚

ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä¾‹ï¼‰:
```json
POST /api/v1/thinklet/sessions/b28f.../telemetry
Content-Type: application/json

{
  "fps": 15,
  "bitrate_kbps": 1200,
  "packet_loss": 0.2,
  "rtt_ms": 12,
  "wearing_state": "proper",
  "view_angle": "horizontal_wide",
  "qos_preset": "high"
}
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `202 Accepted`

### 3.3.4. åˆ¶å¾¡APIï¼ˆãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚¾ãƒ¼ãƒ³ï¼‰

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `POST /api/v1/thinklet/control`

ç›®çš„: THINKLETã‹ã‚‰ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼å…¥é€€å®¤åˆ¶å¾¡ã‚’å—ã‘ã€ã‚µãƒ¼ãƒå´ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆIngest/Recorder/é…ä¿¡ï¼‰ã‚’å¼·åˆ¶åœæ­¢/å¾©å¸°ã™ã‚‹ã€‚

ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä¾‹ã€å…¥å®¤ï¼‰:
```json
{
  "action": "privacy_suspend",
  "session_id": "b28f...",
  "device_id": "THINKLET-001",
  "zone_id": "WC-A1",
  "beacon_id": "beac-123",
  "rssi": -63,
  "timestamp": "2025-08-24T01:23:45Z"
}
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä¾‹ã€é€€å‡ºï¼‰:
```json
{
  "action": "privacy_resume",
  "session_id": "b28f...",
  "device_id": "THINKLET-001",
  "zone_id": "WC-A1",
  "timestamp": "2025-08-24T01:35:12Z",
  "confirmation": "user_button|exit_qr"
}
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹: `202 Accepted`

æ¤œè¨¼:
- èªå¯: ãƒ‡ãƒã‚¤ã‚¹è‡ªèº«/ç®¡ç†è€…ã€‚RBACå¿…é ˆã€‚
- ç›£æŸ»: ã™ã¹ã¦ã®åˆ¶å¾¡è¦æ±‚ã¯ `privacy_zone_events` ã«è¨˜éŒ²ã€‚

### 3.3.5. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚¾ãƒ¼ãƒ³/ãƒ“ãƒ¼ã‚³ãƒ³ç®¡ç†APIï¼ˆç®¡ç†è€…å‘ã‘ï¼‰

| åŒºåˆ†   | ãƒ‘ã‚¹                                 | ãƒ¡ã‚½ãƒƒãƒ‰ | æ¦‚è¦                         |
| ------ | ------------------------------------ | -------- | ---------------------------- |
| ç™»éŒ²   | `/api/v1/privacy-zones/beacons`      | POST     | ãƒ“ãƒ¼ã‚³ãƒ³ç™»éŒ²                 |
| ä¸€è¦§   | `/api/v1/privacy-zones/beacons`      | GET      | ãƒ“ãƒ¼ã‚³ãƒ³ä¸€è¦§ãƒ»æ¤œç´¢           |
| è©³ç´°   | `/api/v1/privacy-zones/beacons/{id}` | GET      | ãƒ“ãƒ¼ã‚³ãƒ³è©³ç´°                 |
| æ›´æ–°   | `/api/v1/privacy-zones/beacons/{id}` | PUT      | è­˜åˆ¥å­/äº¤æ›äºˆå®šæ—¥ã®æ›´æ–°ç­‰    |
| å¥å…¨æ€§ | `/api/v1/privacy-zones/health`       | GET      | last_seen/vbattã®å¥å…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆ |

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ç®¡ç†è€…ãƒ­ãƒ¼ãƒ«ã®ã¿ã€‚å…¨æ“ä½œã¯ç›£æŸ»è¨˜éŒ²ã€‚

## 3.4. VMS æ˜ åƒç®¡ç† APIï¼ˆ/api/v1/vms/*ï¼‰

ã‚½ãƒ¼ã‚¹éä¾å­˜ã®æ˜ åƒç®¡ç†APIã€‚THINKLET/å›ºå®šã‚«ãƒ¡ãƒ©/ç«¯æœ«ã‚¢ãƒ—ãƒªã®æ˜ åƒã‚’ä¸€è²«ã—ãŸIFã§æ¤œç´¢ãƒ»å–å¾—ãƒ»å†ç”Ÿã™ã‚‹ã€‚

### 3.4.1. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

| åŒºåˆ†       | ãƒ‘ã‚¹                                         | ãƒ¡ã‚½ãƒƒãƒ‰ | æ¦‚è¦                              |
| ---------- | -------------------------------------------- | -------- | --------------------------------- |
| æ¤œç´¢       | `/api/v1/vms/search`                         | GET      | ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ¤œç´¢                    |
| è©³ç´°       | `/api/v1/vms/segments/{segment_id}`          | GET      | ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè©³ç´°å–å¾—                |
| å†ç”Ÿ       | `/api/v1/vms/segments/{segment_id}/playback` | GET      | ç½²åURL or Viewerãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ     |
| ãƒ©ã‚¤ãƒ–è¦–è´ | `/api/v1/vms/live/{source}/{id}/whep`        | GET      | ãƒ©ã‚¤ãƒ–è¦–è´ç”¨WHEP URL/ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ |

source ä¾‹: `thinklet | cctv | terminal`ã€‚`id` ã¯ã‚½ãƒ¼ã‚¹ã”ã¨ã®è­˜åˆ¥å­ï¼ˆãƒ‡ãƒã‚¤ã‚¹IDç­‰ï¼‰ã€‚

### 3.4.2. æ¤œç´¢API

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `GET /api/v1/vms/search`

ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆä»£è¡¨ï¼‰:
- `source`ï¼ˆä»»æ„ã€default=allï¼‰
- `device_id` / `thinklet_id`ï¼ˆä»»æ„ï¼‰
- `worker_id`ï¼ˆä»»æ„ï¼‰
- `product_id` / `work_order_id` / `instruction_id`ï¼ˆä»»æ„ï¼‰
- `from` / `to`ï¼ˆISO8601ï¼‰
- `view_angle`ï¼ˆenum: horizontal_wide|vertical_wide|standardï¼‰
- `quality_result`ï¼ˆenum: PASS|FAIL|WARNING ç­‰ï¼‰
- `limit`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ200ã€æœ€å¤§1000ï¼‰

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆä¾‹ï¼‰:
```json
{
  "items": [
    {
      "segment_id": "c912...",
      "source": "thinklet",
      "device_id": "THINKLET-001",
      "worker_id": "worker_123",
      "product_id": "a3f1...",
      "recording_start_time": "2025-08-24T01:23:45Z",
      "recording_end_time": "2025-08-24T01:35:12Z",
      "duration_seconds": 687,
      "quality_status": "PASS",
      "object_key": "vms/thinklet/THINKLET-001/2025/08/24/01/...mp4"
    }
  ],
  "total": 1
}
```

å®Ÿè£…ãƒ¡ãƒ¢:
- THINKLETã®ãƒ‡ãƒ¼ã‚¿ã¯ `thinklet_inspection_segments` ã‚’ä¸»ã«èµ°æŸ»ï¼ˆDB 1.7.2ï¼‰ã€‚
- ä»–ã‚½ãƒ¼ã‚¹ã¯å°†æ¥ã® `cctv_segments` ç­‰ã¨çµ±åˆãƒ“ãƒ¥ãƒ¼ã§æä¾›ï¼ˆä¾‹: `vms_segments`ï¼‰ã€‚

### 3.4.3. å†ç”ŸAPIï¼ˆç½²åURL/Viewerãƒˆãƒ¼ã‚¯ãƒ³ï¼‰

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `GET /api/v1/vms/segments/{segment_id}/playback`

ç›®çš„: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å†ç”Ÿã‚’å®‰å…¨ã«æä¾›ã€‚MinIO ç½²åä»˜ãURLã¾ãŸã¯é…ä¿¡ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ï¼ˆWHEPï¼‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™ã€‚

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆä¾‹ã€ç½²åURLæ–¹å¼ï¼‰:
```json
{
  "playback": {
    "type": "signed_url",
    "url": "https://minio.example.local/vms/thinklet/...mp4?X-Amz-Expires=1800"
  }
}
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆä¾‹ã€WHEPè¦–è´æ–¹å¼ï¼‰:
```json
{
  "playback": {
    "type": "whep",
    "url": "https://distrib.example.local/whep/view/THINKLET-001",
    "viewer_token": "eyJhbGci...",
    "expires_at": "2025-08-24T10:00:00Z"
  }
}
```

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:
- æœŸé™ä»˜ãç™ºè¡Œã€‚RBACã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã€‚æ“ä½œã¯ `traceability_records` ã«ç›£æŸ»è¨˜éŒ²ã€‚
- æ—¢å®šã¯ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼å‡¦ç†æ¸ˆã¿æ´¾ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™ã€‚åŸæœ¬å†ç”Ÿã¯æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¾Œã®æœŸé™ä»˜ããƒˆãƒ¼ã‚¯ãƒ³ã®ã¿è¨±å¯ã€‚

# 4. gRPC APIè¨­è¨ˆ

## 4.1. å®Ÿè£…æ¸ˆã¿gRPCã‚µãƒ¼ãƒ“ã‚¹

### 4.1.1. ã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆ

ImageFlowCanvasã§ã¯ã€ä»¥ä¸‹ã®gRPCã‚µãƒ¼ãƒ“ã‚¹ãŒå®Ÿè£…ãƒ»ç¨¼åƒã—ã¦ã„ã¾ã™ï¼š

| ã‚µãƒ¼ãƒ“ã‚¹å              | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                 | æ©Ÿèƒ½                 | Protocol Buffers      |
| ----------------------- | ------------------------------ | -------------------- | --------------------- |
| **ResizeService**       | `resize-grpc-app:50051`        | ç”»åƒãƒªã‚µã‚¤ã‚ºå‡¦ç†     | `resize.proto`        |
| **AIDetectionService**  | `ai-detection-grpc-app:50052`  | AIç‰©ä½“æ¤œå‡ºãƒ»åˆ†é¡     | `ai_detection.proto`  |
| **FilterService**       | `filter-grpc-app:50053`        | ç”»åƒãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†     | `filter.proto`        |
| **CameraStreamService** | `camera-stream-grpc-app:50054` | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ˜ åƒå‡¦ç† | `camera_stream.proto` |

### 4.1.2. å…±é€šãƒ—ãƒ­ãƒˆã‚³ãƒ«å®šç¾©ï¼ˆcommon.protoï¼‰

```protobuf
syntax = "proto3";
package imageflow.v1;

// å…±é€šç”»åƒãƒ‡ãƒ¼ã‚¿æ§‹é€ 
message ImageData {
  string bucket = 1;
  string object_key = 2;
  string content_type = 3;
  int64 size_bytes = 4;
  int32 width = 5;
  int32 height = 6;
  google.protobuf.Timestamp created_at = 7;
}

// ç›´æ¥ç”»åƒãƒã‚¤ãƒˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ç”¨ï¼‰
message ImageBytes {
  bytes data = 1;
  string format = 2;  // "JPEG", "PNG"
  int32 width = 3;
  int32 height = 4;
}

// å‡¦ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
enum ProcessingStatus {
  PROCESSING_STATUS_UNSPECIFIED = 0;
  PROCESSING_STATUS_PENDING = 1;
  PROCESSING_STATUS_RUNNING = 2;
  PROCESSING_STATUS_COMPLETED = 3;
  PROCESSING_STATUS_FAILED = 4;
}

// å‡¦ç†çµæœå…±é€šæ§‹é€ 
message ProcessingResult {
  ProcessingStatus status = 1;
  string message = 2;
  ImageData output_image = 3;
  bytes output_data = 7;  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ç”¨
  map<string, string> metadata = 4;
  google.protobuf.Timestamp processed_at = 5;
  double processing_time_seconds = 6;
}
```

### 4.1.3. æ¤œæŸ»ãƒã‚¹ã‚¿ç®¡ç†Service

```protobuf
service InspectionMasterService {
  // æ¤œæŸ»æŒ‡ç¤ºã®ç®¡ç†
  rpc CreateinspectionInstruction(CreateinspectionInstructionRequest) returns (inspectionInstruction);
  rpc GetinspectionInstruction(GetinspectionInstructionRequest) returns (inspectionInstruction);
  rpc ListinspectionInstructions(ListinspectionInstructionsRequest) returns (ListinspectionInstructionsResponse);
  rpc UpdateinspectionInstruction(UpdateinspectionInstructionRequest) returns (inspectionInstruction);
  rpc DeleteinspectionInstruction(DeleteinspectionInstructionRequest) returns (google.protobuf.Empty);

  // æ¤œæŸ»é …ç›®ã®ç®¡ç†
  rpc CreateInspectionItem(CreateInspectionItemRequest) returns (InspectionItem);
  rpc GetInspectionItem(GetInspectionItemRequest) returns (InspectionItem);
  rpc ListInspectionItems(ListInspectionItemsRequest) returns (ListInspectionItemsResponse);
}

message inspectionInstruction {
  string id = 1;
  string name = 2;
  string description = 3;
  string product_code = 4;
  string version = 5;
  map<string, string> metadata = 6;
  google.protobuf.Timestamp created_at = 7;
}

message CreateinspectionInstructionRequest {
  string name = 1;
  string description = 2;
  string product_code = 3;
  map<string, string> metadata = 4;
}
```

### 4.1.4. æ¤œæŸ»å®Ÿè¡ŒService

```protobuf
service InspectionExecutionService {
  // æ¤œæŸ»å®Ÿè¡Œ
  rpc ExecuteInspection(ExecuteInspectionRequest) returns (ExecuteInspectionResponse);
  rpc GetInspectionExecution(GetInspectionExecutionRequest) returns (InspectionExecution);
  rpc ListInspectionExecutions(ListInspectionExecutionsRequest) returns (ListInspectionExecutionsResponse);
  
  // æ¤œæŸ»çµæœã®ç®¡ç†
  rpc SaveInspectionResult(SaveInspectionResultRequest) returns (InspectionResult);
  rpc GetInspectionResult(GetInspectionResultRequest) returns (InspectionResult);
}

message ExecuteInspectionRequest {
  string instruction_id = 1;
  repeated ImageData input_images = 2;
  string qr_code = 3;  // Optional QR code data
  map<string, string> parameters = 4;
}

message ExecuteInspectionResponse {
  string execution_id = 1;
  ProcessingStatus status = 2;
  int64 estimated_duration_ms = 3;
}
```

### 4.1.5. çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡ŒService

```protobuf
service PipelineService {
  rpc ExecutePipeline(ExecutePipelineRequest) returns (ExecutePipelineResponse);
  rpc StreamProgress(ProgressRequest) returns (stream ProgressUpdate);
  rpc CancelExecution(CancelRequest) returns (CancelResponse);
}

message ExecutePipelineRequest {
  string pipeline_id = 1;
  repeated string input_file_ids = 2;
  map<string, string> parameters = 3;
  string client_id = 4;
}

message ExecutePipelineResponse {
  string execution_id = 1;
  ProcessingStatus status = 2;
  int64 estimated_duration_ms = 3;
}

message ProgressUpdate {
  string execution_id = 1;
  string current_step = 2;
  float progress_percentage = 3;
  ProcessingStatus status = 4;
  google.protobuf.Timestamp timestamp = 5;
}
```

## 4.2. å€‹åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ä»•æ§˜

### 4.2.1. ResizeService (resize.proto)

**æ©Ÿèƒ½**: ç”»åƒãƒªã‚µã‚¤ã‚ºãƒ»å½¢å¼å¤‰æ›
**å‡¦ç†æ™‚é–“**: 10-20ms
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: resize-grpc-app:50051

```protobuf
service ResizeService {
  rpc Resize(ResizeRequest) returns (ResizeResponse);
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

message ResizeRequest {
  ImageData input_image = 1;
  int32 instruction_width = 2;
  int32 instruction_height = 3;
  string resize_mode = 4;  // "fit", "fill", "stretch"
  bool maintain_aspect_ratio = 5;
}

message ResizeResponse {
  ProcessingResult result = 1;
}
```

### 4.2.2. AIDetectionService (ai_detection.proto)

**æ©Ÿèƒ½**: AIç‰©ä½“æ¤œå‡ºãƒ»åˆ†é¡
**å‡¦ç†æ™‚é–“**: 20-50ms (GPUä½¿ç”¨æ™‚)
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: ai-detection-grpc-app:50052

```protobuf
service AIDetectionService {
  rpc Detect(DetectionRequest) returns (DetectionResponse);
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

message DetectionRequest {
  ImageData input_image = 1;
  string model_name = 2;      // "yolo11", "resnet50"
  float confidence_threshold = 3;
  repeated string instruction_classes = 4;
}

message DetectionResponse {
  ProcessingResult result = 1;
  repeated Detection detections = 2;
}

message Detection {
  string class_name = 1;
  float confidence = 2;
  BoundingBox bbox = 3;
}

message BoundingBox {
  float x = 1;
  float y = 2;
  float width = 3;
  float height = 4;
}
```

### 4.2.3. FilterService (filter.proto)

**æ©Ÿèƒ½**: ç”»åƒãƒ•ã‚£ãƒ«ã‚¿ãƒ»å‰å¾Œå‡¦ç†
**å‡¦ç†æ™‚é–“**: 5-15ms
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: filter-grpc-app:50053

```protobuf
service FilterService {
  rpc ApplyFilter(FilterRequest) returns (FilterResponse);
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

message FilterRequest {
  ImageData input_image = 1;
  string filter_type = 2;    // "blur", "sharpen", "edge"
  map<string, string> parameters = 3;
}

message FilterResponse {
  ProcessingResult result = 1;
}
```

### 4.2.4. CameraStreamProcessor (camera_stream.proto)

**æ©Ÿèƒ½**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ˜ åƒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†
**ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·**: <50ms
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- Docker Compose: `camera-stream-grpc:9090`
- Kubernetes: `camera-stream-grpc-service.image-processing.svc.cluster.local:9090`
- Nomad/ã‚ªãƒ³ãƒ—ãƒ¬ä¾‹: `192.168.5.15:9094`ï¼ˆä¾‹ï¼‰
**èªè¨¼**: gRPC Metadata `authorization: Bearer <JWT>`
**æš—å·åŒ–**: é‹ç”¨æ™‚ã¯TLSæ¨å¥¨ï¼ˆLB/Ingressçµ‚ç«¯ or ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ï¼‰

```protobuf
service CameraStreamProcessor {
  rpc ProcessVideoStream(stream VideoFrame) returns (stream ProcessedFrame);
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

message VideoFrame {
  bytes frame_data = 1;                 // JPEG/PNG encoded frame
  int64 timestamp_ms = 2;               // Unix epoch millis
  VideoMetadata metadata = 3;           // Source and processing parameters
}

message ProcessedFrame {
  bytes processed_data = 1;             // Optional processed image
  string source_id = 2;                 // Echo of VideoMetadata.source_id
  int64 processing_time_ms = 3;         // Server-side processing time
  repeated Detection detections = 4;    // AI detection results
  StreamProcessingStatus status = 5;    // SUCCESS/PARTIAL/FAILED/SKIPPED
  string error_message = 6;             // Error detail on failure
  google.protobuf.Timestamp processed_at = 7;
}

message VideoMetadata {
  string source_id = 1;                 // Unique camera/source ID
  int32 width = 2;                      // Frame width
  int32 height = 3;                     // Frame height
  string pipeline_id = 4;               // Processing pipeline identifier
  map<string, string> processing_params = 5; // e.g., model_name, qos hints
}
```

## 4.3. ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šç®¡ç†

### 4.3.1. å†…éƒ¨gRPCã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§

| ã‚µãƒ¼ãƒ“ã‚¹å            | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¾‹ï¼ˆCompose/K8sï¼‰                                                | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | ãƒªãƒˆãƒ©ã‚¤å›æ•° | ä¸»è¦æ©Ÿèƒ½             |
| --------------------- | ------------------------------------------------------------------------------ | ------------ | ------------ | -------------------- |
| resize-service        | resize-grpc:9090 / resize-grpc-service.image-processing.svc:9090               | 30ç§’         | 3å›          | ç”»åƒãƒªã‚µã‚¤ã‚ºãƒ»æ­£è¦åŒ– |
| ai-detection-service  | ai-detection-grpc:9090 / ai-detection-grpc-service.image-processing.svc:9090   | 60ç§’         | 2å›          | AIç‰©ä½“æ¤œçŸ¥ãƒ»åˆ†æ     |
| filter-service        | filter-grpc:9090 / filter-grpc-service.image-processing.svc:9090               | 20ç§’         | 3å›          | ç”»åƒãƒ•ã‚£ãƒ«ã‚¿ãƒ»è£œæ­£   |
| camera-stream-service | camera-stream-grpc:9090 / camera-stream-grpc-service.image-processing.svc:9090 | 10ç§’         | 1å›          | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ˜ åƒå‡¦ç† |

### 4.3.2. æ¥ç¶šç®¡ç†æ–¹é‡

| è¨­å®šé …ç›®           | æ–¹é‡                 | ç†ç”±                     |
| ------------------ | -------------------- | ------------------------ |
| ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ« | å„ã‚µãƒ¼ãƒ“ã‚¹æœ€å¤§10æ¥ç¶š | è² è·åˆ†æ•£ã¨ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡   |
| ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯     | 30ç§’é–“éš”             | éšœå®³ã®æ—©æœŸæ¤œå‡º           |
| å›å¾©å‡¦ç†           | æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•       | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ã¸ã®å¯¾å¿œ |
| è² è·åˆ†æ•£           | ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³       | å‡ç­‰ãªå‡¦ç†åˆ†æ•£           |

### 4.3.3. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ»å†—é•·æ€§
- **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é–“éš”**: 10ç§’
- **ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼**: å¤±æ•—é–¾å€¤5å›ã€å¾©æ—§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ30ç§’
- **Kafkaãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: ç›´æ¥gRPCå¤±æ•—æ™‚ã®ä»£æ›¿å‡¦ç†
- **ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°**: ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ã®è² è·åˆ†æ•£

# 5. WebSocket APIè¨­è¨ˆ

## 5.1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—é€šçŸ¥

### 5.1.1. æ¥ç¶šãƒ»èªè¨¼
```javascript
// æ¥ç¶šä¾‹
const ws = new WebSocket('ws://api.example.com/ws');

// èªè¨¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
ws.send(JSON.stringify({
  type: 'auth',
  token: 'jwt-token-here',
  client_id: 'client-123'
}));

// èªè¨¼å¿œç­”
{
  type: 'auth_response',
  status: 'success',
  client_id: 'client-123'
}
```

### 5.1.2. é€²æ—é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```javascript
// ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®é€²æ—é€šçŸ¥
{
  type: 'execution_progress',
  data: {
    execution_id: 'exec-12345',
    pipeline_id: 'pipeline-67890',
    current_step: 'ai_detection',
    progress_percentage: 75.5,
    elapsed_time_ms: 3750,
    estimated_remaining_ms: 1250
  }
}

// å®Ÿè¡Œå®Œäº†é€šçŸ¥
{
  type: 'execution_completed',
  data: {
    execution_id: 'exec-12345',
    status: 'success',
    total_time_ms: 5000,
    output_files: ['processed_file1.jpg', 'processed_file2.png']
  }
}

// ã‚¨ãƒ©ãƒ¼é€šçŸ¥
{
  type: 'execution_error',
  data: {
    execution_id: 'exec-12345',
    error_code: 'AI_PROCESSING_FAILED',
    error_message: 'AI service timeout',
    failed_step: 'ai_detection'
  }
}
```

```javascript
// WebSocketæ¥ç¶šã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
ws://localhost:8080/ws/execution/{execution_id}

// é€²æ—é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼
{
  "type": "progress",
  "execution_id": "exec-uuid-123",
  "step": "ai_detection",
  "progress": 65.5,
  "status": "processing",
  "timestamp": "2025-07-21T10:30:01.085Z",
  "data": {
    "current_component": "AI Detection Service",
    "elapsed_time_ms": 1750,
    "estimated_remaining_ms": 850
  }
}

// å®Œäº†é€šçŸ¥
{
  "type": "completed",
  "execution_id": "exec-uuid-123",
  "total_time_ms": 87,
  "output_files": [
    {
      "file_id": "output-123",
      "filename": "result.jpg",
      "download_url": "/api/v1/files/output-123/download"
    }
  ]
}

// ã‚¨ãƒ©ãƒ¼é€šçŸ¥
{
  "type": "error",
  "execution_id": "exec-uuid-123",
  "error": {
    "code": "AI_SERVICE_UNAVAILABLE",
    "message": "AI Detection Service temporarily unavailable",
    "retry_after": 30
  }
}
```

# 6. è£½å“æƒ…å ±ç®¡ç†APIè¨­è¨ˆ

## 6.1. è£½å“æƒ…å ±å–å¾—API

### 6.1.1. QRã‚³ãƒ¼ãƒ‰æƒ…å ±å–å¾—API

**QRã‚³ãƒ¼ãƒ‰ãƒ‡ã‚³ãƒ¼ãƒ‰ãƒ»è£½å“æƒ…å ±å–å¾—**
```http
POST /api/v1/products/qr-decode
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:
```json
{
  "qr_code_data": "PROD|WO123456|INST789|TYPE-ABC|MACH001|20250808|001",
  "device_id": "device-001",
  "scanned_by": "user-123",
  "scan_location": {
    "latitude": 35.6762,
    "longitude": 139.6503
  }
}
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:
```json
{
  "success": true,
  "product_info": {
    "id": "prod-uuid-12345",
    "work_order_id": "WO123456",
    "instruction_id": "INST789",
    "product_code": "TYPE-ABC",
    "machine_number": "MACH001",
    "production_date": "2025-08-08",
    "monthly_sequence": 1,
    "specification": {
      "model": "ABC-100",
      "size": "100x200mm",
      "weight": "1.5kg"
    },
    "status": "active"
  },
  "scan_history_id": "scan-uuid-67890",
  "response_time_ms": 150
}
```

**QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´**
```http
GET /api/v1/products/qr-scan-history
GET /api/v1/products/qr-scan-history/{history_id}
```

### 6.1.2. è£½å“æƒ…å ±æ¤œç´¢API

**è£½å“ãƒã‚¹ã‚¿æ¤œç´¢**
```http
GET /api/v1/products/search
POST /api/v1/products/search
```

æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¾‹:
```json
{
  "query": {
    "work_order_id": "WO123*",
    "product_code": "TYPE-ABC",
    "machine_number": "MACH001",
    "production_date_from": "2025-08-01",
    "production_date_to": "2025-08-31",
    "monthly_sequence_min": 1,
    "monthly_sequence_max": 100
  },
  "sort": {
    "field": "production_date",
    "direction": "desc"
  },
  "pagination": {
    "page": 1,
    "limit": 20
  }
}
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:
```json
{
  "success": true,
  "results": [
    {
      "id": "prod-uuid-12345",
      "work_order_id": "WO123456",
      "instruction_id": "INST789",
      "product_code": "TYPE-ABC",
      "machine_number": "MACH001",
      "production_date": "2025-08-08",
      "monthly_sequence": 1,
      "status": "active",
      "created_at": "2025-08-08T09:00:00Z"
    }
  ],
  "pagination": {
    "total": 150,
    "page": 1,
    "limit": 20,
    "total_pages": 8
  },
  "search_history_id": "search-uuid-111",
  "response_time_ms": 200
}
```

**ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ**
```http
GET /api/v1/products/autocomplete/{field}?q={query}
```

### 6.1.3. è£½å“æƒ…å ±ç®¡ç†API

**è£½å“ãƒã‚¹ã‚¿CRUD**
```http
POST /api/v1/products
GET /api/v1/products/{product_id}
PUT /api/v1/products/{product_id}
DELETE /api/v1/products/{product_id}
GET /api/v1/products
```

**è£½å“æƒ…å ±ä¸€æ‹¬ç™»éŒ²**
```http
POST /api/v1/products/bulk-import
```

## 6.2. æ¤œæŸ»çµæœç´ã¥ã‘API

### 6.2.1. æ¤œæŸ»çµæœè¨˜éŒ²API

**è£½å“æƒ…å ±ç´ã¥ã‘æ¤œæŸ»çµæœè¨˜éŒ²**
```http
POST /api/v1/inspection/results
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:
```json
{
  "product_id": "prod-uuid-12345",
  "inspection_session_id": "session-uuid-67890",
  "inspection_type": "visual_inspection",
  "result_status": "OK",
  "ai_confidence": 0.95,
  "human_verified": true,
  "human_result": "OK",
  "defect_details": {
    "defects": [],
    "quality_score": 95
  },
  "inspector_id": "user-123",
  "image_files": [
    {
      "file_path": "/inspection/images/IMG_001.jpg",
      "file_size": 2048576,
      "image_type": "capture"
    }
  ],
  "pipeline_execution_id": "pipeline-exec-456",
  "processing_time_ms": 1200,
  "metadata": {
    "camera_settings": {
      "resolution": "1920x1080",
      "iso": 100
    }
  }
}
```

**æ¤œæŸ»çµæœæ¤œç´¢ï¼ˆè£½å“æƒ…å ±ãƒ™ãƒ¼ã‚¹ï¼‰**
```http
GET /api/v1/inspection/results/by-product/{product_id}
POST /api/v1/inspection/results/search
```

## 6.3. æ˜ åƒç´ã¥ã‘API

### 6.3.1. æ˜ åƒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²API

**è£½å“æƒ…å ±ç´ã¥ã‘æ˜ åƒè¨˜éŒ²**
```http
POST /api/v1/videos/metadata
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:
```json
{
  "product_id": "prod-uuid-12345",
  "video_file_path": "/videos/thinklet/VIDEO_001.mp4",
  "video_file_size": 104857600,
  "recording_start_time": "2025-08-08T10:00:00Z",
  "recording_end_time": "2025-08-08T10:05:00Z",
  "duration_seconds": 300,
  "frame_rate": 30,
  "resolution": "1920x1080",
  "device_id": "thinklet-001",
  "device_type": "THINKLET",
  "recording_quality": "HIGH",
  "audio_enabled": true,
  "gps_location": {
    "latitude": 35.6762,
    "longitude": 139.6503,
    "altitude": 10.5
  },
  "work_process": "final_inspection",
  "operator_id": "user-123",
  "metadata": {
    "battery_level": 85,
    "storage_remaining": "2.5GB"
  }
}
```

**æ˜ åƒæ¤œç´¢ï¼ˆè£½å“æƒ…å ±ãƒ™ãƒ¼ã‚¹ï¼‰**
```http
GET /api/v1/videos/by-product/{product_id}
POST /api/v1/videos/search
```

## 6.4. ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£API

### 6.4.1. ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£è¨˜éŒ²API

**è£½å“ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£è¨˜éŒ²**
```http
POST /api/v1/traceability/records
```

**è£½å“ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£æ¤œç´¢**
```http
GET /api/v1/traceability/products/{product_id}
POST /api/v1/traceability/search
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:
```json
{
  "success": true,
  "traceability": {
    "product_info": {
      "id": "prod-uuid-12345",
      "work_order_id": "WO123456",
      "instruction_id": "INST789",
      "product_code": "TYPE-ABC",
      "machine_number": "MACH001",
      "production_date": "2025-08-08",
      "monthly_sequence": 1
    },
    "events": [
      {
        "event_type": "QR_SCAN",
        "event_timestamp": "2025-08-08T09:00:00Z",
        "user_id": "user-123",
        "device_id": "mobile-001",
        "event_data": {
          "scan_result": "success",
          "location": "Line-A Station-1"
        }
      },
      {
        "event_type": "INSPECTION",
        "event_timestamp": "2025-08-08T09:30:00Z",
        "user_id": "user-456",
        "device_id": "mobile-002",
        "event_data": {
          "inspection_type": "visual_inspection",
          "result": "OK",
          "confidence": 0.95
        }
      },
      {
        "event_type": "RECORDING",
        "event_timestamp": "2025-08-08T10:00:00Z",
        "user_id": "user-789",
        "device_id": "thinklet-001",
        "event_data": {
          "video_duration": 300,
          "work_process": "final_inspection"
        }
      }
    ]
  }
}
```

# 7. æ¤œæŸ»æ©Ÿèƒ½APIè¨­è¨ˆ

# 8. æ¤œæŸ»æ©Ÿèƒ½APIè¨­è¨ˆ

## 8.1. Kotlin Multiplatformæ¤œæŸ»ã‚¢ãƒ—ãƒªAPI

### 8.1.1. æ¤œæŸ»ãƒã‚¹ã‚¿ç®¡ç†APIï¼ˆè£½å“æƒ…å ±çµ±åˆï¼‰

**æ¤œæŸ»æŒ‡ç¤ºãƒã‚¹ã‚¿**
```http
GET /api/v1/inspection/instructions
POST /api/v1/inspection/instructions
GET /api/v1/inspection/instructions/{instruction_id}
PUT /api/v1/inspection/instructions/{instruction_id}
DELETE /api/v1/inspection/instructions/{instruction_id}
```

**æ¤œæŸ»é …ç›®ãƒã‚¹ã‚¿ï¼ˆè£½å“ã‚¿ã‚¤ãƒ—åˆ¥ï¼‰**
```http
GET /api/v1/inspection/instructions/{instruction_id}/items
GET /api/v1/inspection/items/by-product-code/{product_code}
POST /api/v1/inspection/instructions/{instruction_id}/items
GET /api/v1/inspection/items/{item_id}
PUT /api/v1/inspection/items/{item_id}
DELETE /api/v1/inspection/items/{item_id}
```

### 8.1.2. æ¤œæŸ»å®Ÿè¡ŒAPIï¼ˆè£½å“æƒ…å ±ç´ã¥ã‘å¯¾å¿œï¼‰

**æ¤œæŸ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆè£½å“æƒ…å ±å¿…é ˆï¼‰**
```http
POST /api/v1/inspection/sessions
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆè£½å“æƒ…å ±ç´ã¥ã‘ï¼‰:
```json
{
  "product_id": "prod-uuid-12345",
  "qr_scan_history_id": "scan-uuid-67890",
  "inspector_id": "user-123",
  "device_id": "mobile-001",
  "session_metadata": {
    "work_station": "Line-A Station-1",
    "shift": "morning",
    "batch_number": "BATCH-001"
  }
}
```

```http
GET /api/v1/inspection/sessions/{session_id}
PUT /api/v1/inspection/sessions/{session_id}
POST /api/v1/inspection/sessions/{session_id}/complete
```

**AIæ¤œæŸ»å®Ÿè¡Œï¼ˆè£½å“æƒ…å ±è‡ªå‹•ç´ã¥ã‘ï¼‰**
```http
POST /api/v1/inspection/sessions/{session_id}/ai-inspection
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:
```json
{
  "session_id": "session-12345",
  "item_id": "item-67890",
  "image_file_path": "/path/to/captured/image.jpg",
  "pipeline_id": "pipeline-ai-detect-v1.2",
  "parameters": {
    "confidence_threshold": 0.8,
    "model_name": "yolo11"
  },
  "auto_link_product": true
}
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ï¼ˆè£½å“æƒ…å ±å«ã‚€ï¼‰:
```json
{
  "ai_result": {
    "overall_result": "NG",
    "confidence": 0.92,
    "detections": [
      {
        "class_name": "defect",
        "confidence": 0.92,
        "bbox": {"x": 150, "y": 200, "width": 50, "height": 30}
      }
    ]
  },
  "processing_time_ms": 1250,
  "pipeline_version": "v1.2",
  "product_info": {
    "work_order_id": "WO123456",
    "instruction_id": "INST789",
    "product_code": "TYPE-ABC",
    "machine_number": "MACH001",
    "monthly_sequence": 1
  },
  "inspection_result_id": "inspection-result-uuid-999",
  "created_at": "2025-07-27T10:30:00Z"
}
```

**äººã«ã‚ˆã‚‹æ¤œè¨¼APIï¼ˆè£½å“æƒ…å ±è‡ªå‹•ç¶™æ‰¿ï¼‰**
```http
POST /api/v1/inspection/sessions/{session_id}/human-verification
```

### 8.1.3. æ¤œæŸ»ãƒ‡ãƒ¼ã‚¿åŒæœŸAPIï¼ˆè£½å“æƒ…å ±çµ±åˆï¼‰

**ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸ**
```http
POST /api/v1/inspection/sync/upload
GET /api/v1/inspection/sync/download
```

**å·®åˆ†åŒæœŸ**
```http
GET /api/v1/inspection/sync/changes?since={timestamp}
POST /api/v1/inspection/sync/apply-changes
```

## 8.2. çµ±è¨ˆãƒ»ãƒ¬ãƒãƒ¼ãƒˆAPI

### 8.2.1. æ¤œæŸ»çµ±è¨ˆAPI

**åŸºæœ¬çµ±è¨ˆæƒ…å ±**
```http
GET /api/v1/inspection/statistics?start_date={date}&end_date={date}
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:
```json
{
  "summary": {
    "total_inspections": 1250,
    "ok_count": 1180,
    "ng_count": 70,
    "ok_rate": 94.4
  },
  "daily_trends": [
    {
      "date": "2025-07-27",
      "total": 85,
      "ok": 80,
      "ng": 5
    }
  ],
  "defect_analysis": {
    "scratch": 35,
    "contamination": 20,
    "deformation": 15
  }
}
```

### 8.2.2. å“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨API

**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å“è³ªæŒ‡æ¨™**
```http
GET /api/v1/inspection/quality/realtime
WebSocket: /ws/quality-metrics
```

**æ¤œæŸ»å‚¾å‘åˆ†æ**
```http
GET /api/v1/inspection/quality/trends
GET /api/v1/inspection/quality/alerts
```

## 8.3. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±åˆAPI

### 8.3.1. æ¤œæŸ»ç”¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç†

**æ¤œæŸ»é …ç›®ã¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®é–¢é€£ä»˜ã‘**
```http
GET /api/v1/inspection/items/{item_id}/pipeline
PUT /api/v1/inspection/items/{item_id}/pipeline
```

**ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œçµæœã®æ¤œæŸ»çµæœã¸ã®å¤‰æ›**
```http
POST /api/v1/inspection/pipeline-results/convert
```

### 8.3.2. Kotlin Multiplatformã‚¢ãƒ—ãƒªå°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

**ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²ãƒ»èªè¨¼**
```http
POST /api/v1/kmp/devices/register
POST /api/v1/kmp/auth/login
```

**ã‚¢ãƒ—ãƒªè¨­å®šåŒæœŸ**
```http
GET /api/v1/kmp/config
PUT /api/v1/kmp/config
```

## 8.4. WebSocket APIè¨­è¨ˆ

### 8.4.1. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—é€šçŸ¥

WebSocketæ¥ç¶šã«ã‚ˆã‚Šã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã®é€²æ—ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€šçŸ¥ã—ã¾ã™ã€‚

**æ¥ç¶šã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**
```
ws://localhost:8080/ws/execution/{execution_id}
ws://localhost:8080/ws/system-status
ws://localhost:8080/ws/camera-stream
ws://localhost:8080/ws/quality-metrics
```

**é€²æ—é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼**
```javascript
// ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œé€²æ—
{
  "type": "progress",
  "execution_id": "exec-uuid-123",
  "step": "ai_detection",
  "progress": 65.5,
  "status": "processing",
  "timestamp": "2025-07-27T10:30:01.085Z",
  "data": {
    "current_component": "AI Detection Service",
    "elapsed_time_ms": 1750,
    "estimated_remaining_ms": 850
  }
}

// å®Œäº†é€šçŸ¥
{
  "type": "completed",
  "execution_id": "exec-uuid-123",
  "total_time_ms": 87,
  "output_files": [
    {
      "file_id": "output-123",
      "filename": "result.jpg",
      "download_url": "/api/v1/files/output-123/download"
    }
  ]
}

// ã‚¨ãƒ©ãƒ¼é€šçŸ¥
{
  "type": "error",
  "execution_id": "exec-uuid-123",
  "error": {
    "code": "AI_SERVICE_UNAVAILABLE",
    "message": "AI Detection Service temporarily unavailable",
    "retry_after": 30
  }
}
```

### 8.4.2. æ¤œæŸ»å“è³ªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥

```javascript
// å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
{
  "type": "quality_update",
  "timestamp": "2025-07-27T10:30:00Z",
  "metrics": {
    "hourly_ok_rate": 95.2,
    "current_ng_count": 3,
    "active_inspectors": 12
  }
}

// å“è³ªã‚¢ãƒ©ãƒ¼ãƒˆ
{
  "type": "quality_alert",
  "severity": "high",
  "message": "NG rate exceeded threshold (>5%)",
  "data": {
    "current_ng_rate": 7.2,
    "threshold": 5.0,
    "time_window": "last_hour"
  }
}
```

### 8.4.3. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ˜ åƒé…ä¿¡

ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ˜ åƒå‡¦ç†ã®çµæœã‚’WebSocketã§é…ä¿¡ã—ã¾ã™ã€‚
- æ˜ åƒãƒ•ãƒ¬ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®é…ä¿¡
- AIæ¤œå‡ºçµæœã®é€ä¿¡
- å‡¦ç†çµ±è¨ˆæƒ…å ±ã®é€šçŸ¥
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°åˆ¶å¾¡æ©Ÿèƒ½

---

## 8.5. Ingest/Upload/Resume APIï¼ˆå˜ä¸€è·¯ã‚¤ãƒ³ã‚¸ã‚§ã‚¹ãƒˆå¯¾å¿œï¼‰

æœ¬ç¯€ã§ã¯ã€ãƒ‡ãƒã‚¤ã‚¹å´ã®ã€Œæ˜ åƒ=WebRTC/WHEPå˜ä¸€è·¯ã€ã€ãŠã‚ˆã³éŒ²ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®å†é–‹ãƒ»æœªé€ä¿¡ç®¡ç†ãƒ»å¸¯åŸŸãƒ’ãƒ³ãƒˆã«é–¢ã™ã‚‹APIã‚’å®šç¾©ã—ã¾ã™ã€‚ãƒ‡ãƒã‚¤ã‚¹â†’ã‚µãƒ¼ãƒã®gRPCã¯åˆ¶å¾¡ãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ»è»½é‡ã‚¤ãƒ™ãƒ³ãƒˆã«é™å®šã•ã‚Œã¾ã™ã€‚

### 8.5.1. Ingest ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

```http
POST /api/v1/ingest/sessions/start
Authorization: Bearer <JWT>
Content-Type: application/json

{
  "device_id": "dev-123",
  "protocol": "whep",             // whep | rtsp
  "stream_tags": ["line-A", "fpv"],
  "product_info": { "order_no": "O-001", "model": "X", "serial": "S-001" }
}

200 OK
{
  "session_id": "sess-abc",
  "whep_endpoint": "https://gw.example.com/whep/sess-abc",
  "ice_servers": [{"urls": ["stun:stun.l.google.com:19302"]}],
  "qos_preset": "high"             // high | normal | low
}
```

```http
POST /api/v1/ingest/sessions/{session_id}/stop
Authorization: Bearer <JWT>

204 No Content
```

### 8.5.2. éŒ²ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†é–‹ï¼ˆResumeï¼‰

ãƒãƒ«ãƒãƒ‘ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’æ¡ç”¨ã—ã€ETagã§ãƒãƒ£ãƒ³ã‚¯æ•´åˆæ€§ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚ä¸­æ–­å†é–‹æ™‚ã¯æœªå®Œäº†ãƒãƒ£ãƒ³ã‚¯ã ã‘ã‚’é€ä¿¡ã—ã¾ã™ã€‚

```http
POST /api/v1/upload/segments
Authorization: Bearer <JWT>
Content-Type: application/json

{
  "device_id": "dev-123",
  "segment_id": "seg-001",
  "size_bytes": 734003200,
  "priority": "high"               // high | normal | low
}

200 OK
{
  "upload_id": "up-xyz",
  "part_size": 5242880
}
```

```http
PUT /api/v1/upload/segments/{segment_id}/parts/{part_number}
Authorization: Bearer <JWT>
Content-Type: application/octet-stream
Content-Range: bytes <start>-<end>/<total>
If-Match: <previous-etag-or-empty>

<binary body>

200 OK
ETag: "part-etag-abc"
```

```http
POST /api/v1/upload/segments/{segment_id}/complete
Authorization: Bearer <JWT>
Content-Type: application/json

{
  "upload_id": "up-xyz",
  "parts": [
    {"part_number": 1, "etag": "part-etag-1"},
    {"part_number": 2, "etag": "part-etag-2"}
  ]
}

201 Created
{
  "object_url": "s3://archive/2025/08/seg-001.mp4",
  "checksum": "sha256:..."
}
```

### 8.5.3. æœªé€ä¿¡ã‚­ãƒ¥ãƒ¼ç…§ä¼š

```http
GET /api/v1/devices/{device_id}/unsent-queue
Authorization: Bearer <JWT>

200 OK
{
  "device_id": "dev-123",
  "queue": [
    {"segment_id": "seg-001", "state": "LOCAL", "size": 734003200, "protected": false},
    {"segment_id": "seg-002", "state": "FAILED", "retries": 3, "last_error": "etag-mismatch"}
  ]
}
```

### 8.5.4. å¸¯åŸŸãƒ’ãƒ³ãƒˆå–å¾—

```http
GET /api/v1/devices/{device_id}/bandwidth-hint?network=wifi
Authorization: Bearer <JWT>

200 OK
{
  "network": "wifi",               // wifi | lte | ethernet
  "max_parallel_uploads": 6,
  "recommended_part_size": 5242880,
  "qos_preset": "high"
}
```

### 8.5.5. ãƒªãƒˆãƒ©ã‚¤/ãƒãƒƒã‚¯ã‚ªãƒ•æ–¹é‡
- æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•: 0.5â†’1â†’2â†’4ç§’ã€æœ€å¤§5å›ã€‚
- ETagä¸ä¸€è‡´æ™‚ã¯è©²å½“ãƒ‘ãƒ¼ãƒˆå†é€ã€é€£ç¶šä¸ä¸€è‡´3å›ã§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†æ¤œè¨¼APIã¸ã€‚
- å„ªå…ˆåº¦: highâ†’normalâ†’low ã§ã‚­ãƒ¥ãƒ¼å‡¦ç†é †ã‚’æ±ºå®šã€‚

## 8.6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä»•æ§˜

### 8.6.1. æ¨™æº–ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆRFC 7807æº–æ‹ ï¼‰

```json
{
  "type": "https://api.imageflowcanvas.com/errors/validation-error",
  "title": "å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™",
  "status": 400,
  "detail": "confidence_thresholdã¯0.0-1.0ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„",
  "instance": "/api/v1/inspection/sessions/session-123/ai-inspection",
  "validation_errors": [
    {
      "field": "confidence_threshold",
      "message": "å€¤ã¯0.0ä»¥ä¸Š1.0ä»¥ä¸‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™",
      "value": 1.5
    }
  ]
}
```

### 8.6.2. æ¤œæŸ»æ©Ÿèƒ½ç‰¹æœ‰ã®ã‚¨ãƒ©ãƒ¼

```json
{
  "type": "https://api.imageflowcanvas.com/errors/inspection-error",
  "title": "æ¤œæŸ»å®Ÿè¡Œã‚¨ãƒ©ãƒ¼",
  "status": 422,
  "detail": "æŒ‡å®šã•ã‚ŒãŸãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒæ¤œæŸ»é …ç›®ã¨äº’æ›æ€§ãŒã‚ã‚Šã¾ã›ã‚“",
  "inspection_context": {
    "session_id": "session-123",
    "item_id": "item-456",
    "pipeline_id": "pipeline-789"
  }
}
```

# 9. Kotlin Multiplatformã‹ã‚‰Backend APIã¸ã®gRPCé€šä¿¡

## 9.1. Kotlin Multiplatform gRPC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­è¨ˆ

Kotlin Multiplatformã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰Backend APIã¸ã®é€šä¿¡ã¯ã€åŠ¹ç‡æ€§ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã‚’é‡è¦–ã—ãŸgRPCãƒ™ãƒ¼ã‚¹ã®è¨­è¨ˆã‚’æ¡ç”¨ã—ã¾ã™ã€‚

### 9.1.1. é€šä¿¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
sequenceDiagram
    participant KmpApp as ğŸ–¥ï¸ Kotlin Multiplatformã‚¢ãƒ—ãƒª
    participant KmpBackend as ğŸ”§ KMP Backend (Kotlin/Native)
    participant BackendAPI as ğŸ”§ Backend API (FastAPI)
    participant gRPCServices as âš¡ gRPCå¸¸é§ã‚µãƒ¼ãƒ“ã‚¹
    participant PostgreSQL as ğŸ—ƒï¸ PostgreSQL
    participant SQLite as ğŸ’¾ SQLite

    Note over KmpApp, SQLite: 1. åˆæœŸåŒ–ãƒ»èªè¨¼
    KmpApp->>KmpBackend: call("init_grpc_client")
    KmpBackend->>BackendAPI: gRPC: AuthService.Authenticate
    BackendAPI-->>KmpBackend: JWT Token
    KmpBackend-->>KmpApp: èªè¨¼æ¸ˆã¿çŠ¶æ…‹

    Note over KmpApp, SQLite: 2. ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿åŒæœŸ
    KmpApp->>KmpBackend: call("sync_master_data")
    KmpBackend->>BackendAPI: gRPC: SyncService.GetMasterData
    BackendAPI->>PostgreSQL: ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
    PostgreSQL-->>BackendAPI: ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿
    BackendAPI-->>KmpBackend: gRPC Stream
    KmpBackend->>SQLite: ãƒ­ãƒ¼ã‚«ãƒ«åŒæœŸ
    KmpBackend-->>KmpApp: åŒæœŸå®Œäº†é€šçŸ¥

    Note over KmpApp, SQLite: 3. æ¤œæŸ»å®Ÿè¡Œ
    KmpApp->>KmpBackend: call("execute_inspection")
    KmpBackend->>BackendAPI: gRPC: InspectionService.Execute
    BackendAPI->>gRPCServices: ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œå§”è­²
    gRPCServices-->>BackendAPI: å®Ÿè¡Œçµæœ
    BackendAPI-->>KmpBackend: gRPCçµæœã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
    KmpBackend->>SQLite: çµæœä¿å­˜
    KmpBackend-->>KmpApp: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—æ›´æ–°
```

### 9.1.2. gRPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­è¨ˆæ–¹é‡

#### 9.1.2.1. **ä¾å­˜é–¢ä¿‚ã¨æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**

Kotlin Multiplatformã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã®æŠ€è¡“è¦ç´ ã‚’ä½¿ç”¨ã—ã¦gRPCé€šä¿¡ã‚’å®Ÿç¾ã—ã¾ã™ï¼š

| æŠ€è¡“è¦ç´               | ç”¨é€”                             | é¸å®šç†ç”±                          |
| --------------------- | -------------------------------- | --------------------------------- |
| gRPC Kotlin Stub      | ã‚³ãƒ«ãƒ¼ãƒãƒ³ãƒ™ãƒ¼ã‚¹gRPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ | Kotlin/Nativeã§ã®éåŒæœŸå‡¦ç†ã«æœ€é© |
| Protocol Buffers      | ãƒ‡ãƒ¼ã‚¿ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³       | å‹å®‰å…¨æ€§ã¨ãƒã‚¤ãƒŠãƒªåŠ¹ç‡            |
| OkHttp                | HTTP/2é€šä¿¡åŸºç›¤                   | ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œ        |
| Kotlinx Coroutines    | éåŒæœŸå‡¦ç†                       | ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ çµ±ä¸€API           |
| Kotlinx Serialization | JSONå¤‰æ›                         | è»½é‡ã‹ã¤é«˜æ€§èƒ½                    |

#### 9.1.2.2. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³**

```mermaid
graph TB
    A[Compose UI Layer] --> B[Business Logic Layer]
    B --> C[gRPC Client Layer]
    C --> D[Channel Management]
    C --> E[Authentication Service]
    C --> F[Sync Service]
    C --> G[Inspection Service]
    D --> H[Backend API Gateway]
    E --> H
    F --> H
    G --> H
```

#### 9.1.2.3. **é€šä¿¡ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ**

**èªè¨¼ãƒ•ãƒ­ãƒ¼**:
1. ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«gRPCãƒãƒ£ãƒãƒ«åˆæœŸåŒ–
2. ãƒ‡ãƒã‚¤ã‚¹èªè¨¼æƒ…å ±ã§JWTãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
3. ä»¥é™ã®é€šä¿¡ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡

**ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ•ãƒ­ãƒ¼**:
1. ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å·®åˆ†å–å¾—è¦æ±‚
2. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã«ã‚ˆã‚‹å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿å—ä¿¡
3. ãƒ­ãƒ¼ã‚«ãƒ«SQLiteã¸ã®æ®µéšçš„æ›´æ–°

**æ¤œæŸ»å®Ÿè¡Œãƒ•ãƒ­ãƒ¼**:
1. æ¤œæŸ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
2. gRPCã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å®Ÿè¡Œ
3. é€²æ—æ›´æ–°ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    
### 9.1.3. UIçµ±åˆè¨­è¨ˆï¼ˆCompose Multiplatformï¼‰

#### 9.1.3.1. **çŠ¶æ…‹ç®¡ç†ãƒ‘ã‚¿ãƒ¼ãƒ³**

Kotlin Multiplatformã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹gRPCé€šä¿¡ã®çŠ¶æ…‹ç®¡ç†ã¯ã€ä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¡ç”¨ã—ã¾ã™ï¼š

```mermaid
graph LR
    A[UI State] --> B[ViewModel]
    B --> C[Repository Layer]
    C --> D[gRPC Client]
    D --> E[Backend API]
    
    E --> D
    D --> C
    C --> B
    B --> A
```

#### 9.1.3.2. **éåŒæœŸå‡¦ç†è¨­è¨ˆ**

| å‡¦ç†ç¨®åˆ¥   | ãƒ‘ã‚¿ãƒ¼ãƒ³              | çŠ¶æ…‹ç®¡ç†              | ã‚¨ãƒ©ãƒ¼å‡¦ç†       |
| ---------- | --------------------- | --------------------- | ---------------- |
| èªè¨¼å‡¦ç†   | Single Shot           | Loading/Success/Error | ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ã |
| ãƒ‡ãƒ¼ã‚¿åŒæœŸ | Streaming             | Progress/Complete     | éƒ¨åˆ†æˆåŠŸå¯¾å¿œ     |
| æ¤œæŸ»å®Ÿè¡Œ   | Bi-directional Stream | Real-time Progress    | ä¸­æ–­ãƒ»å†é–‹å¯¾å¿œ   |
| è¨­å®šæ›´æ–°   | Request-Response      | Optimistic Update     | ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œ |

#### 9.1.3.3. **ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†**

**æ¥ç¶šç®¡ç†**:
- ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚: gRPCãƒãƒ£ãƒãƒ«åˆæœŸåŒ–
- ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°: æ¥ç¶šçŠ¶æ…‹ç¢ºèªãƒ»å¾©æ—§
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç§»è¡Œ: æ¥ç¶šä¿æŒï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰/ åˆ‡æ–­ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼‰
- ã‚¢ãƒ—ãƒªçµ‚äº†æ™‚: ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³

**ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†**:
- ãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ãªã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
- å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²å—ä¿¡
- è‡ªå‹•ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¯¾å¿œ

# 10. Backend APIã§ã®å®šç¾©æ¸ˆã¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè¡Œ

## 10.1. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³è¨­è¨ˆ

Backend APIã¯ã€äº‹å‰ã«å®šç¾©ã•ã‚ŒãŸãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’åŠ¹ç‡çš„ã«å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

### 10.1.1. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    A[ğŸ“‹ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œè¦æ±‚] --> B[ğŸ” ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®šç¾©å–å¾—]
    B --> C[âœ… å®Ÿè¡Œå‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³]
    C --> D{ğŸ¤” å®Ÿè¡Œæ–¹å¼é¸æŠ}
    
    D -->|é«˜é€Ÿå‡¦ç†| E[âš¡ ç›´æ¥gRPCå®Ÿè¡Œ]
    D -->|è² è·åˆ†æ•£| F[ğŸ“¨ Kafka Queue]
    
    E --> G[ğŸ”§ gRPCã‚µãƒ¼ãƒ“ã‚¹å‘¼å‡º]
    F --> H[âš–ï¸ Worker Pool]
    H --> G
    
    G --> I[ğŸ“Š å®Ÿè¡Œçµæœåé›†]
    I --> J[ğŸ’¾ çµæœä¿å­˜]
    J --> K[ğŸ“¡ é€šçŸ¥é…ä¿¡]
    K --> L[âœ… å®Ÿè¡Œå®Œäº†]
    
    style A fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    style B fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    style C fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#000
    style D fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style E fill:#e1f5fe,stroke:#0277bd,stroke-width:3px,color:#000
    style F fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style G fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    style H fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    style I fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#000
    style J fill:#f1f8e9,stroke:#689f38,stroke-width:2px,color:#000
    style K fill:#e0f2f1,stroke:#00695c,stroke-width:2px,color:#000
    style L fill:#e8f5e8,stroke:#4caf50,stroke-width:3px,color:#000
```

### 10.1.2. ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®šç¾©ç®¡ç†

**ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®šç¾©ã‚¹ã‚­ãƒ¼ãƒ**:
```json
{
  "pipeline_id": "quality-inspection-v1",
  "name": "å“è³ªæ¤œæŸ»ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³",
  "version": "1.0.0",
  "description": "AI ã«ã‚ˆã‚‹æ¬ é™¥æ¤œå‡ºã¨å“è³ªè©•ä¾¡",
  "execution_mode": "direct_grpc", 
  "steps": [
    {
      "step_id": "resize",
      "service": "ResizeService",
      "method": "Resize",
      "input_schema": {
        "width": "integer",
        "height": "integer", 
        "maintain_aspect_ratio": "boolean"
      },
      "timeout_ms": 5000,
      "retry_count": 3
    },
    {
      "step_id": "ai_detection",
      "service": "AIDetectionService", 
      "method": "DetectDefects",
      "depends_on": ["resize"],
      "input_schema": {
        "model_name": "string",
        "confidence_threshold": "float"
      },
      "timeout_ms": 30000,
      "retry_count": 2
    },
    {
      "step_id": "quality_filter",
      "service": "FilterService",
      "method": "ApplyQualityFilter", 
      "depends_on": ["ai_detection"],
      "input_schema": {
        "filter_type": "enum",
        "parameters": "object"
      },
      "timeout_ms": 10000,
      "retry_count": 3
    }
  ],
  "error_handling": {
    "strategy": "fail_fast",
    "rollback_enabled": true,
    "notification_on_failure": true
  }
}
```

### 10.1.3. å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³è¨­è¨ˆ

#### 10.1.3.1. **å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰é¸æŠ**

| å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰  | ç”¨é€”             | ç‰¹å¾´                     | é©ç”¨æ¡ä»¶                   |
| ----------- | ---------------- | ------------------------ | -------------------------- |
| DIRECT_GRPC | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç† | ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ï¼ˆ<100msï¼‰   | å°å®¹é‡ãƒ‡ãƒ¼ã‚¿ã€å³åº§çµæœå¿…è¦ |
| KAFKA_QUEUE | ãƒãƒƒãƒå‡¦ç†       | é«˜ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã€è€éšœå®³æ€§ | å¤§å®¹é‡ãƒ‡ãƒ¼ã‚¿ã€éåŒæœŸå‡¦ç†å¯ |
| HYBRID      | è¤‡åˆå‡¦ç†         | æœ€é©åŒ–ã•ã‚ŒãŸçµ„ã¿åˆã‚ã›   | è¤‡é›‘ãªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³         |

#### 10.1.3.2. **ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒƒãƒ—è¨­è¨ˆ**

```mermaid
graph LR
    A[Input Validation] --> B[Pre-processing]
    B --> C[AI Processing]
    C --> D[Post-processing]
    D --> E[Output Generation]
    
    F[Error Handling] --> A
    F --> B  
    F --> C
    F --> D
    F --> E
```

#### 10.1.3.3. **å®Ÿè¡Œåˆ¶å¾¡ãƒ•ãƒ­ãƒ¼**

| ãƒ•ã‚§ãƒ¼ã‚º | å‡¦ç†å†…å®¹                     | å¤±æ•—æ™‚å¯¾å¿œ                   |
| -------- | ---------------------------- | ---------------------------- |
| åˆæœŸåŒ–   | ãƒªã‚½ãƒ¼ã‚¹ç¢ºä¿ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼ | å³åº§çµ‚äº†ã€ã‚¨ãƒ©ãƒ¼é€šçŸ¥         |
| å‰å‡¦ç†   | ç”»åƒæ­£è¦åŒ–ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ› | ãƒªãƒˆãƒ©ã‚¤3å›ã€ä»£æ›¿å‡¦ç†        |
| AIå‡¦ç†   | æ¨è«–å®Ÿè¡Œã€çµæœç”Ÿæˆ           | ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°ã€åˆ¥ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ |
| å¾Œå‡¦ç†   | çµæœæ•´å½¢ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä»˜ä¸     | éƒ¨åˆ†çµæœä¿å­˜                 |
| å‡ºåŠ›     | ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã€é€šçŸ¥é…ä¿¡       | å†é…ä¿¡æ©Ÿèƒ½                   |
   
# 11. å®šç¾©æ¸ˆã¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã®å¸¸é§gRPCã‚µãƒ¼ãƒ“ã‚¹ã®ä½¿ç”¨

## 11.1. å¸¸é§gRPCã‚µãƒ¼ãƒ“ã‚¹ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

å®šç¾©æ¸ˆã¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ã€é«˜æ€§èƒ½å‡¦ç†ã®ãŸã‚ã«å¸¸é§gRPCã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ¼ãƒ«ã‚’æ´»ç”¨ã—ã¾ã™ã€‚

### 11.1.1. ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ¼ãƒ«ç®¡ç†

```mermaid
graph TB
    subgraph "ğŸ—ï¸ Service Pool Manager"
        SPM[Service Pool Manager]
        HC[Health Checker]
        LB[Load Balancer]
        RM[Resource Monitor]
    end
    
    subgraph "âš¡ Resident gRPC Services"
        RS1[ResizeService #1<br/>Status: Active<br/>Load: 20%]
        RS2[ResizeService #2<br/>Status: Active<br/>Load: 45%]
        AI1[AIDetectionService #1<br/>Status: Active<br/>Load: 80%]
        AI2[AIDetectionService #2<br/>Status: Active<br/>Load: 60%]
        FS1[FilterService #1<br/>Status: Active<br/>Load: 15%]
    end
    
    subgraph "ğŸ“‹ Pipeline Executor"
        PE[Pipeline Executor]
        SD[Service Discovery]
        RC[Retry Controller]
    end
    
    SPM --> RS1 & RS2 & AI1 & AI2 & FS1
    HC --> RS1 & RS2 & AI1 & AI2 & FS1
    LB --> RS1 & RS2 & AI1 & AI2 & FS1
    RM --> RS1 & RS2 & AI1 & AI2 & FS1
    
    PE --> SD
    SD --> LB
    RC --> LB
    
    style SPM fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#000
    style HC fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    style LB fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#000
    style RM fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    style RS1 fill:#e8f5e8,stroke:#4caf50,stroke-width:2px,color:#000
    style RS2 fill:#e8f5e8,stroke:#4caf50,stroke-width:2px,color:#000
    style AI1 fill:#ffebee,stroke:#e53935,stroke-width:2px,color:#000
    style AI2 fill:#fff4e8,stroke:#ff9800,stroke-width:2px,color:#000
    style FS1 fill:#e8f5e8,stroke:#4caf50,stroke-width:2px,color:#000
    style PE fill:#e1f5fe,stroke:#0277bd,stroke-width:2px,color:#000
    style SD fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    style RC fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
```

### 11.1.2. ã‚µãƒ¼ãƒ“ã‚¹ç™ºè¦‹ãƒ»è² è·åˆ†æ•£è¨­è¨ˆ

#### 11.1.2.1. **ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç®¡ç†**

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹  | èª¬æ˜           | æ–°è¦æ¥ç¶š         | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯       |
| ----------- | -------------- | ---------------- | -------------------- |
| ACTIVE      | æ­£å¸¸ç¨¼åƒä¸­     | å—ã‘å…¥ã‚Œ         | 30ç§’é–“éš”             |
| BUSY        | è² è·é«˜çŠ¶æ…‹     | åˆ¶é™ä»˜ãå—ã‘å…¥ã‚Œ | 15ç§’é–“éš”             |
| UNAVAILABLE | å¿œç­”ä¸å¯       | æ‹’å¦             | 60ç§’é–“éš”ï¼ˆå¾©æ—§æ¤œå‡ºï¼‰ |
| MAINTENANCE | ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­ | æ‹’å¦             | åœæ­¢                 |

#### 11.1.2.2. **è² è·åˆ†æ•£ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **

| ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ       | ç”¨é€”             | é¸æŠåŸºæº–                    |
| ----------------- | ---------------- | --------------------------- |
| Least Connections | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç† | æ¥ç¶šæ•°æœ€å°ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹    |
| Round Robin       | ãƒãƒƒãƒå‡¦ç†       | é †æ¬¡ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³          |
| Response Time     | é«˜æ€§èƒ½è¦æ±‚       | å¿œç­”æ™‚é–“æœ€çŸ­ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹  |
| CPU Usage         | CPUé›†ç´„å‡¦ç†      | CPUä½¿ç”¨ç‡æœ€ä½ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ |

#### 11.1.2.3. **ã‚µãƒ¼ãƒ“ã‚¹ç™ºè¦‹ãƒ•ãƒ­ãƒ¼**

```mermaid
graph TD
    A[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¦æ±‚] --> B[ã‚µãƒ¼ãƒ“ã‚¹åè§£æ±º]
    B --> C[åˆ©ç”¨å¯èƒ½ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å–å¾—]
    C --> D[è² è·åˆ†æ•£ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é©ç”¨]
    D --> E[æœ€é©ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹é¸æŠ]
    E --> F[æ¥ç¶šç¢ºç«‹]
    F --> G[ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ›´æ–°]
```
         
### 11.1.3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ãƒ»æœ€é©åŒ–è¨­è¨ˆ

#### 11.1.3.1. **ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†é …ç›®**

| ã‚«ãƒ†ã‚´ãƒª     | ç›£è¦–é …ç›®                          | åé›†é–“éš”     | æ´»ç”¨ç›®çš„                   |
| ------------ | --------------------------------- | ------------ | -------------------------- |
| ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ | å®Ÿè¡Œæ™‚é–“ã€æˆåŠŸç‡ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ    | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  | æ€§èƒ½åˆ†æã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®š |
| ã‚µãƒ¼ãƒ“ã‚¹     | CPUä½¿ç”¨ç‡ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ã€å¿œç­”æ™‚é–“ | 30ç§’         | ãƒªã‚½ãƒ¼ã‚¹æœ€é©åŒ–             |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã€å¸¯åŸŸä½¿ç”¨ç‡ã€ã‚¨ãƒ©ãƒ¼ç‡  | 10ç§’         | é€šä¿¡å“è³ªç®¡ç†               |
| ãƒ“ã‚¸ãƒã‚¹     | å‡¦ç†ç²¾åº¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦          | 1æ™‚é–“        | ã‚·ã‚¹ãƒ†ãƒ æ”¹å–„æŒ‡æ¨™           |

#### 11.1.3.2. **æœ€é©åŒ–æˆ¦ç•¥**

```mermaid
graph TB
    A[ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†] --> B[ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ]
    B --> C[ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç‰¹å®š]
    C --> D[æœ€é©åŒ–æ–¹é‡æ±ºå®š]
    D --> E[è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°]
    D --> F[ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°èª¿æ•´]
    D --> G[ãƒªã‚½ãƒ¼ã‚¹å†é…åˆ†]
    E --> H[åŠ¹æœæ¸¬å®š]
    F --> H
    G --> H
    H --> A
```

#### 11.1.3.3. **è‡ªå‹•æœ€é©åŒ–ãƒ«ãƒ¼ãƒ«**

| æ¡ä»¶               | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³                 | åŠ¹æœ           |
| ------------------ | -------------------------- | -------------- |
| CPUä½¿ç”¨ç‡ > 80%    | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¿½åŠ            | è² è·åˆ†æ•£       |
| å¿œç­”æ™‚é–“ > 500ms   | é«˜é€Ÿã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸åˆ‡ã‚Šæ›¿ãˆ | ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ”¹å–„ |
| ã‚¨ãƒ©ãƒ¼ç‡ > 5%      | ä»£æ›¿ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨           | å¯ç”¨æ€§å‘ä¸Š     |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ > 90% | ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ   | ãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–   |
       

---

# 12. éŒ²ç”»APIè¨­è¨ˆï¼ˆã‚¦ã‚§ã‚¢ãƒ©ãƒ–ãƒ«ä¸€äººç§°æ˜ åƒï¼‰

## 12.1. éŒ²ç”»åˆ¶å¾¡ REST API

ãƒ™ãƒ¼ã‚¹URL: `https://api.imageflowcanvas.com/v1`

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§:
- `POST /devices/{device_id}/recordings/start`
    - body: `{ "mode": "normal|event", "quality": "high|balanced|low", "labels": ["..."], "execution_id": "optional" }`
    - 202/409/401/403
- `POST /devices/{device_id}/recordings/stop`
    - body: `{ "execution_id": "optional" }`
    - 202/404/409
- `POST /devices/{device_id}/recordings/pause`
- `POST /devices/{device_id}/recordings/resume`
- `GET  /devices/{device_id}/recordings?from={iso}&to={iso}&status={local|synced|server}`
- `GET  /recordings/{recording_id}` ãƒ¡ã‚¿+ç½²åURLè¿”å´

ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ‡ãƒ«: RFC7807æº–æ‹ ï¼ˆtype/title/status/detail/instanceï¼‰ã€‚ä»£è¡¨ã‚³ãƒ¼ãƒ‰: `DEVICE_UNAUTHORIZED`, `RECORDING_IN_PROGRESS`, `EXECUTION_NOT_FOUND`ã€‚

èªå¯/RBAC:
- ãƒ‡ãƒã‚¤ã‚¹ã¯ãƒ‡ãƒã‚¤ã‚¹è¨¼æ˜/JWTå¿…é ˆã€‚æ“ä½œã¯ device:recordings:* ã‚¹ã‚³ãƒ¼ãƒ—ã€‚
- ç®¡ç†è€…/ç›£ç£è€…ã¯é–²è¦§ç³»ï¼ˆlist/getï¼‰ã«é™å®šå¯èƒ½ã€‚

## 12.2. éŒ²ç”»åˆ¶å¾¡ gRPC APIï¼ˆRecordingControlServiceï¼‰

ã‚µãƒ¼ãƒ“ã‚¹æ¦‚è¦:
```
service RecordingControlService {
    rpc Start(StartRequest) returns (StartResponse);
    rpc Stop(StopRequest) returns (StopResponse);
    rpc Pause(PauseRequest) returns (PauseResponse);
    rpc Resume(ResumeRequest) returns (ResumeResponse);
    rpc List(ListRequest) returns (ListResponse);
    rpc Get(GetRequest) returns (GetResponse);
}
```
å…±é€šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: device_id, execution_id(optional), labels(map<string,string>)ã€‚ã‚¨ãƒ©ãƒ¼ã¯ gRPC status + details ã«RFC7807ç›¸å½“ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã€‚

## 12.3. WebRTC/WHEP ã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã¨ã‚µãƒ¼ãƒãƒ¼éŒ²ç”»

- WHEPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `POST /rtc/whep`ï¼ˆSDP Offerå—é ˜â†’Answerè¿”å´ï¼‰
- STUN/TURNè¨­å®šå–å¾—: `GET /api/v1/rtc/config`ï¼ˆICEã‚µãƒ¼ãƒä¸€è¦§ã¨è³‡æ ¼æƒ…å ±ã‚’è¿”å´ï¼‰
- ã‚µãƒ¼ãƒãƒ¼éŒ²ç”»: å—ä¿¡RTPã‚’remuxã—ã¦ãƒ­ãƒ¼ãƒ«ãƒªãƒ³ã‚°éŒ²ç”»ï¼ˆå†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ç„¡ã—ï¼‰ã€‚ä¿å­˜å…ˆã¯MinIOã® recordings ãƒã‚±ãƒƒãƒˆã€‚
- ã‚»ãƒƒã‚·ãƒ§ãƒ³å†é–‹: æ–­æ™‚ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå†Offerã€‚Serverã¯å‰å›execution_idã‚’ã‚­ãƒ¼ã«é€£ç¶šè¨˜éŒ²ã‚’è©¦è¡Œã€‚

## 12.4. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆS3äº’æ›ãƒ»ãƒ—ãƒ¬ã‚µã‚¤ãƒ³ãƒ‰ï¼‰

ãƒ•ãƒ­ãƒ¼:
1) `POST /api/v1/recordings/uploads/presign` â†’ `url`, `fields`, `part_urls[]` ã‚’è¿”å´
2) ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ãƒãƒ«ãƒãƒ‘ãƒ¼ãƒˆPUTï¼ˆETagåé›†ï¼‰
3) `POST /api/v1/recordings/uploads/complete`ï¼ˆpartç•ªå·ã¨ETagåˆ—æŒ™ï¼‰

è¦ä»¶:
- URLæœ‰åŠ¹æœŸé™ã¯çŸ­å‘½ï¼ˆæ¨å¥¨: 10åˆ†ï¼‰ã€‚ã‚¹ã‚³ãƒ¼ãƒ—ã¯å½“è©²ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¿ã«é™å®šã€‚
- é€”ä¸­ä¸­æ–­æ™‚ã¯ETagã«ã‚ˆã‚Šå†é–‹å¯èƒ½ã€‚

## 12.5. éŒ²ç”»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ ã‚¹ã‚­ãƒ¼ãƒ

JSON sidecarï¼ˆæ‹¡å¼µå¯èƒ½ãªå¥‘ç´„ã€`schema_version`ã§ç®¡ç†ï¼‰:
```json
{
    "schema_version": "1.0",
    "recording_id": "uuid",
    "device_id": "thinklet-xxxxx",
    "execution_id": "optional-uuid",
    "start_ts": "2025-08-08T01:23:45.678Z",
    "end_ts": "2025-08-08T01:24:45.678Z",
    "duration_ms": 60000,
    "fps": 30,
    "resolution": "1920x1080",
    "video_codec": "h264",
    "audio_codec": "aac",
    "bitrate_kbps": 6000,
    "location": { "lat": 35.0, "lon": 139.0 },
    "pose": { "roll": 0.0, "pitch": 0.0, "yaw": 0.0 },
    "battery_pct": 72,
    "temperature_c": 44.2,
    "storage_url": "s3://recordings/.../segment_...mp4",
    "checksum": "etag-or-md5",
    "labels": ["lineA", "process1"],
    "tags": { "shift": "day" },
    "notes": "optional"
}
```

æ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: device_id, execution_id, start_ts, labels, tagsã€‚

## 12.6. ã‚¤ãƒ™ãƒ³ãƒˆ/é€šçŸ¥ï¼ˆKafka Topicsï¼‰

Topicsã¨ä¾‹:
- `recording.started`
```json
{ "recording_id": "...", "device_id": "...", "execution_id": "...", "ts": "..." }
```
- `recording.stopped`
```json
{ "recording_id": "...", "device_id": "...", "duration_ms": 60000, "ts": "..." }
```
- `recording.segment.stored`
```json
{ "recording_id": "...", "device_id": "...", "object_key": "...", "etag": "...", "ts": "..." }
```
- `recording.synced`
```json
{ "recording_id": "...", "device_id": "...", "parts": 8, "bytes": 73400320, "ts": "..." }
```
- `recording.error`
```json
{ "recording_id": "...", "device_id": "...", "code": "STORAGE_LOW|OVERHEAT|NETWORK", "message": "...", "ts": "..." }
```

## 12.7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£/ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«
- èªè¨¼: ãƒ‡ãƒã‚¤ã‚¹ã¯ç›¸äº’TLSã¾ãŸã¯JWTã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯OAuth2/JWTã€‚
- èªå¯: RBACã§recordingsã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡ã€‚
- ä¿å­˜: 365æ—¥ã€‚ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«é•åæ¤œçŸ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€‚
- æš—å·åŒ–: SSE-S3ï¼ˆæ—¢å®šï¼‰/ SSE-Cï¼ˆæ©Ÿå¯†ï¼‰ã€‚è»¢é€ã¯TLS 1.2+ã€‚

---

# 13. éŒ²ç”»æ˜ åƒç®¡ç†API

## 13.1. æ˜ åƒæ¤œç´¢API

### 13.1.1. VideoAnalysisService - æ˜ åƒæ¤œç´¢

**gRPC Service Definition**:
```protobuf
service VideoAnalysisService {
  // éŒ²ç”»æ˜ åƒæ¤œç´¢
  rpc SearchVideos(VideoSearchRequest) returns (VideoSearchResponse);
  rpc GetSearchSuggestions(SuggestionRequest) returns (SuggestionResponse);
  rpc SaveSearchQuery(SaveSearchRequest) returns (SaveSearchResponse);
  rpc GetSearchHistory(SearchHistoryRequest) returns (SearchHistoryResponse);
  
  // æ˜ åƒå†ç”Ÿãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  rpc GetVideoMetadata(VideoMetadataRequest) returns (VideoMetadataResponse);
  rpc GetVideoStream(VideoStreamRequest) returns (stream VideoChunk);
  rpc GetVideoBookmarks(BookmarkRequest) returns (BookmarkResponse);
  rpc CreateBookmark(CreateBookmarkRequest) returns (CreateBookmarkResponse);
  
  // åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆ
  rpc GenerateAnalyticsReport(AnalyticsRequest) returns (AnalyticsResponse);
  rpc GetDashboardData(DashboardRequest) returns (DashboardResponse);
  rpc ScheduleReport(ScheduleReportRequest) returns (ScheduleReportResponse);
}

message VideoSearchRequest {
  // è£½å“æƒ…å ±æ¤œç´¢
  optional string work_order_id = 1;      // æŒ‡å›³ç•ªå·
  optional string instruction_id = 2;     // æŒ‡ç¤ºç•ªå·
  optional string product_code = 3;       // å‹å¼ã‚³ãƒ¼ãƒ‰
  optional string machine_number = 4;     // æ©Ÿç•ª
  optional int32 month_sequence = 5;      // æœˆé€£ç•ª
  
  // æ™‚é–“ç¯„å›²æ¤œç´¢
  optional int64 start_timestamp = 10;    // é–‹å§‹æ™‚åˆ»ï¼ˆUnix timestampï¼‰
  optional int64 end_timestamp = 11;      // çµ‚äº†æ™‚åˆ»ï¼ˆUnix timestampï¼‰
  
  // å±æ€§æ¤œç´¢
  repeated string recorded_by = 20;       // éŒ²ç”»è€…IDä¸€è¦§
  repeated string inspection_result = 21; // æ¤œæŸ»çµæœï¼ˆOK/NG/PENDINGï¼‰
  repeated string defect_types = 22;      // ä¸è‰¯ç¨®åˆ¥
  repeated string locations = 23;         // æ’®å½±å ´æ‰€
  repeated string process_steps = 24;     // å·¥ç¨‹
  
  // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
  optional string keywords = 30;          // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
  repeated string tags = 31;              // ã‚¿ã‚°æ¤œç´¢
  optional string fulltext_query = 32;    // å…¨æ–‡æ¤œç´¢ã‚¯ã‚¨ãƒª
  
  // ãƒšãƒ¼ã‚¸ãƒ³ã‚°ãƒ»ã‚½ãƒ¼ãƒˆ
  optional int32 page = 40;               // ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆ1ã‹ã‚‰é–‹å§‹ï¼‰
  optional int32 page_size = 41;          // ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ20ï¼‰
  optional string sort_by = 42;           // ã‚½ãƒ¼ãƒˆé …ç›®
  optional bool sort_desc = 43;           // é™é †ãƒ•ãƒ©ã‚°
  
  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
  optional bool include_archived = 50;    // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿æ˜ åƒã‚’å«ã‚ã‚‹
  optional bool favorites_only = 51;      // ãŠæ°—ã«å…¥ã‚Šæ¤œç´¢ã®ã¿
}

message VideoSearchResponse {
  repeated VideoSummary videos = 1;       // æ¤œç´¢çµæœ
  int32 total_count = 2;                  // ç·ä»¶æ•°
  int32 current_page = 3;                 // ç¾åœ¨ãƒšãƒ¼ã‚¸
  int32 total_pages = 4;                  // ç·ãƒšãƒ¼ã‚¸æ•°
  int32 execution_time_ms = 5;            // æ¤œç´¢å®Ÿè¡Œæ™‚é–“
  SearchStats stats = 6;                  // æ¤œç´¢çµ±è¨ˆ
}

message VideoSummary {
  string video_id = 1;                    // æ˜ åƒID
  string file_id = 2;                     // ãƒ•ã‚¡ã‚¤ãƒ«ID
  ProductInfo product_info = 3;           // è£½å“æƒ…å ±
  RecordingInfo recording_info = 4;       // éŒ²ç”»æƒ…å ±
  InspectionInfo inspection_info = 5;     // æ¤œæŸ»æƒ…å ±
  string thumbnail_url = 6;               // ã‚µãƒ ãƒã‚¤ãƒ«URL
  int64 created_at = 7;                   // ä½œæˆæ—¥æ™‚
}
```

### 13.1.2. REST APIï¼ˆWebUIç”¨ï¼‰

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
```
GET /api/v1/videos/search
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
```json
{
  "product_info": {
    "work_order_id": "WO123456",
    "product_code": "TYPE-ABC-001"
  },
  "time_range": {
    "start": "2025-08-01T00:00:00Z",
    "end": "2025-08-31T23:59:59Z"
  },
  "filters": {
    "recorded_by": ["user-789"],
    "inspection_result": ["NG"],
    "locations": ["LINE-A", "LINE-B"]
  },
  "search_text": {
    "keywords": "å¤–è¦³ä¸è‰¯",
    "tags": ["é‡è¦", "è¦ç¢ºèª"]
  },
  "pagination": {
    "page": 1,
    "page_size": 20,
    "sort_by": "recorded_date",
    "sort_desc": true
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "videos": [
    {
      "video_id": "video-001",
      "file_id": "file-001",
      "product_info": {
        "work_order_id": "WO123456",
        "instruction_id": "INS789",
        "product_code": "TYPE-ABC-001",
        "machine_number": "MC001",
        "month_sequence": 15
      },
      "recording_info": {
        "recorded_by": "user-789",
        "recorded_date": "2025-08-08T10:00:00Z",
        "duration_seconds": 324,
        "file_size_bytes": 52428800,
        "resolution": "1920x1080",
        "frame_rate": 30
      },
      "inspection_info": {
        "result": "NG",
        "defect_types": ["å¤–è¦³ä¸è‰¯", "å¯¸æ³•ä¸è‰¯"],
        "confidence_scores": [0.92, 0.87]
      },
      "thumbnail_url": "/api/v1/videos/video-001/thumbnail",
      "created_at": "2025-08-08T10:00:00Z"
    }
  ],
  "pagination": {
    "total_count": 245,
    "current_page": 1,
    "total_pages": 13,
    "execution_time_ms": 156
  },
  "stats": {
    "ok_count": 189,
    "ng_count": 56,
    "average_duration": 298
  }
}
```

## 13.2. æ˜ åƒå†ç”ŸAPI

### 13.2.1. æ˜ åƒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

**gRPC Streaming**:
```protobuf
message VideoStreamRequest {
  string video_id = 1;                    // æ˜ åƒID
  optional int32 start_seconds = 2;       // é–‹å§‹ç§’æ•°
  optional int32 end_seconds = 3;         // çµ‚äº†ç§’æ•°
  optional string quality = 4;            // å“è³ªï¼ˆ4K/1080p/720p/480pï¼‰
  optional bool include_ai_overlay = 5;   // AIè§£æçµæœé‡ç•³
}

message VideoChunk {
  bytes data = 1;                         // æ˜ åƒãƒ‡ãƒ¼ã‚¿ãƒãƒ£ãƒ³ã‚¯
  int32 sequence = 2;                     // ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·
  int32 timestamp_ms = 3;                 // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆãƒŸãƒªç§’ï¼‰
  AIOverlay ai_overlay = 4;               // AIè§£æçµæœï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
}

message AIOverlay {
  repeated DetectionResult detections = 1; // æ¤œå‡ºçµæœä¸€è¦§
  float confidence_score = 2;             // ä¿¡é ¼åº¦
  string detection_type = 3;              // æ¤œå‡ºç¨®åˆ¥
}
```

**REST APIï¼ˆHTTP Adaptive Streamingï¼‰**:
```
GET /api/v1/videos/{video_id}/stream
GET /api/v1/videos/{video_id}/stream.m3u8        # HLS
GET /api/v1/videos/{video_id}/stream.mpd         # DASH
GET /api/v1/videos/{video_id}/thumbnail          # ã‚µãƒ ãƒã‚¤ãƒ«
GET /api/v1/videos/{video_id}/metadata           # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
```

### 13.2.2. ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ç®¡ç†

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
```
GET    /api/v1/videos/{video_id}/bookmarks       # ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä¸€è¦§
POST   /api/v1/videos/{video_id}/bookmarks       # ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä½œæˆ
PUT    /api/v1/videos/{video_id}/bookmarks/{id}  # ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æ›´æ–°
DELETE /api/v1/videos/{video_id}/bookmarks/{id}  # ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯å‰Šé™¤
```

**ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "timestamp_seconds": 124,
  "title": "å¤–è¦³ä¸è‰¯æ¤œå‡ºç®‡æ‰€",
  "description": "å·¦ä¸Šéƒ¨å“ã«å‚·ã‚ã‚Š",
  "bookmark_type": "DEFECT"
}
```

## 13.3. åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆAPI

### 13.3.1. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
```
GET /api/v1/analytics/dashboard
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "summary": {
    "total_recordings": 1240,
    "total_duration_hours": 186.5,
    "total_size_gb": 8.2,
    "defect_rate": 12.3,
    "period": "2025-08"
  },
  "recording_stats": {
    "daily_counts": [
      { "date": "2025-08-01", "count": 42, "duration_hours": 6.2 },
      { "date": "2025-08-02", "count": 38, "duration_hours": 5.8 }
    ],
    "user_distribution": [
      { "user_id": "user-789", "count": 156, "percentage": 12.6 },
      { "user_id": "user-456", "count": 134, "percentage": 10.8 }
    ]
  },
  "quality_stats": {
    "defect_trend": [
      { "date": "2025-08-01", "defect_rate": 11.2 },
      { "date": "2025-08-02", "defect_rate": 13.1 }
    ],
    "defect_types": [
      { "type": "å¤–è¦³ä¸è‰¯", "count": 89, "percentage": 38.5 },
      { "type": "å¯¸æ³•ä¸è‰¯", "count": 67, "percentage": 29.0 }
    ]
  },
  "efficiency_stats": {
    "average_work_time": 298,
    "procedure_compliance": 94.2,
    "improvement_opportunities": [
      {
        "area": "LINE-Aç…§æ˜",
        "impact": "ä¸è‰¯ç‡-3%",
        "priority": "HIGH"
      }
    ]
  }
}
```

### 13.3.2. ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
```
POST /api/v1/analytics/reports/generate
GET  /api/v1/analytics/reports
GET  /api/v1/analytics/reports/{report_id}
```

**ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "report_type": "MONTHLY",
  "instruction_date": "2025-08-31",
  "filters": {
    "locations": ["LINE-A", "LINE-B"],
    "product_codes": ["TYPE-ABC-001"]
  },
  "format": "PDF",
  "schedule": {
    "enabled": true,
    "frequency": "MONTHLY",
    "recipients": ["manager@company.com"]
  }
}
```

**ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "report_id": "report-001",
  "status": "GENERATING",
  "estimated_completion": "2025-08-08T12:05:00Z",
  "download_url": null
}
```

## 13.4. WebSocketé€šçŸ¥ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰

### 13.4.1. æ˜ åƒåˆ†æã‚¤ãƒ™ãƒ³ãƒˆ

**æ¥ç¶š**:
```
ws://api.example.com/ws/video-analysis
```

**èªè¨¼**:
```json
{
  "type": "auth",
  "token": "jwt_token_here"
}
```

**è³¼èª­**:
```json
{
  "type": "subscribe",
  "topics": ["search_results", "analysis_progress", "report_status"]
}
```

**é€šçŸ¥ä¾‹**:
```json
{
  "type": "search_completed",
  "search_id": "search-123",
  "result_count": 245,
  "execution_time_ms": 156,
  "timestamp": "2025-08-08T11:30:00Z"
}

{
  "type": "report_generated",
  "report_id": "report-001",
  "status": "COMPLETED",
  "download_url": "/api/v1/analytics/reports/report-001/download",
  "timestamp": "2025-08-08T12:05:00Z"
}

{
  "type": "analysis_alert",
  "alert_type": "DEFECT_RATE_HIGH",
  "location": "LINE-A",
  "current_rate": 18.5,
  "threshold": 15.0,
  "timestamp": "2025-08-08T14:30:00Z"
}
```

## 13.5. æ€§èƒ½è¦ä»¶ãƒ»åˆ¶ç´„

### 13.5.1. å¿œç­”æ™‚é–“ç›®æ¨™
- æ˜ åƒæ¤œç´¢: <500msï¼ˆé€šå¸¸æ¡ä»¶ï¼‰ã€<2ç§’ï¼ˆè¤‡é›‘æ¡ä»¶ï¼‰
- æ˜ åƒå†ç”Ÿé–‹å§‹: <3ç§’ï¼ˆåˆå›ï¼‰ã€<1ç§’ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ï¼‰
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èª­ã¿è¾¼ã¿: <1ç§’
- ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ: <30ç§’ï¼ˆæ¨™æº–ï¼‰ã€<5åˆ†ï¼ˆå¤§è¦æ¨¡ï¼‰

### 13.5.2. åŒæ™‚å‡¦ç†èƒ½åŠ›
- æ˜ åƒæ¤œç´¢: 500ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ç§’
- æ˜ åƒå†ç”Ÿ: 100åŒæ™‚ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼ˆ1080pï¼‰
- WebSocketæ¥ç¶š: 1,000åŒæ™‚æ¥ç¶š

### 13.5.3. ãƒ‡ãƒ¼ã‚¿åˆ¶ç´„
- æ¤œç´¢çµæœ: æœ€å¤§10,000ä»¶ï¼ˆãƒšãƒ¼ã‚¸ãƒ³ã‚°å¿…é ˆï¼‰
- ãƒ¬ãƒãƒ¼ãƒˆã‚µã‚¤ã‚º: æœ€å¤§100MB
- æ˜ åƒãƒ•ã‚¡ã‚¤ãƒ«: æœ€å¤§2GB/ãƒ•ã‚¡ã‚¤ãƒ«
---

# 14. æ¤œæŸ»ãƒã‚¹ã‚¿ â†â†’ è£½å“é€£æº

## 14.1. è£½å“ã«ç´ã¥ãæ¤œæŸ»é …ç›®å–å¾— API

- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `GET /v1/inspection/products/{product_id}/items`
- æ¦‚è¦: Webã§è¨­å®šã—ãŸæ¤œæŸ»é …ç›®ã‚’ã€æŒ‡å®šã®è£½å“ã«å¯¾å¿œã¥ã‘ã¦å–å¾—ã™ã‚‹ã€‚
- ç›®çš„: KMPã®ãƒãƒ³ãƒ‡ã‚£/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªãŒã€é¸æŠã—ãŸè£½å“ã«å¯¾ã—ã¦å®Ÿè¡Œã™ã¹ãæ¤œæŸ»é …ç›®ã¨é †åºã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ã€ãã®ã¾ã¾æ¤œæŸ»ãƒ•ãƒ­ãƒ¼ã«åæ˜ ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
- ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:
  - `product_id`: è£½å“IDï¼ˆUUID ã¾ãŸã¯ `work_order_instruction_machine_seq` ç”ŸæˆIDï¼‰
- ã‚¯ã‚¨ãƒª:
  - `page` (default: 1)
  - `page_size` (default: 50, max: 200)
- å¿œç­”: ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```
{
  "items": [
    {
      "id": "...",
      "instruction_id": "...",
      "name": "å¤–è¦³æ¤œæŸ»1",
      "description": "...",
      "type": "VISUAL_INSPECTION",
      "pipeline_id": "...",
      "pipeline_params": {"threshold": "0.5"},
      "execution_order": 1,
      "is_required": true,
      "criteria_id": "..."
    }
  ],
  "total_count": 3,
  "page": 1,
  "page_size": 50,
  "total_pages": 1
}
```
- ãƒãƒƒãƒ”ãƒ³ã‚°ä»•æ§˜ï¼ˆé‡è¦ï¼‰:
  - `ProductMaster.product_code` ã¨ `inspectionInstruction.product_code` ã‚’ä¸€è‡´ã‚­ãƒ¼ã¨ã—ã¦ç´ã¥ã‘ã‚‹ã€‚
  - ä¸€è‡´ã—ãªã„å ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ `ProductMaster.work_order_id` ã¨ `inspectionInstruction.product_code` ã®ä¸€è‡´ã‚‚è©¦è¡Œã™ã‚‹ã€‚
  - å¯¾å¿œã™ã‚‹ `inspectionInstruction` ãŒç„¡ã„å ´åˆã¯ `items=[]` ã‚’è¿”ã™ï¼ˆ404ã§ã¯ãªãç©ºé…åˆ—ï¼‰ã€‚

ã“ã®APIã«ã‚ˆã‚Šã€Web UIã§è¨­å®šã—ãŸã€Œæ¤œæŸ»é …ç›®ï¼ˆä¸¦ã³é †/å¿…é ˆ/ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼‰ã€ãŒãã®ã¾ã¾ç«¯æœ«ã‚¢ãƒ—ãƒªã«é…ä¿¡ã•ã‚Œã‚‹ã€‚

## 14.2. å‹å¼ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç† API

é‹ç”¨ä¸Šã€å‹å¼ã‚³ãƒ¼ãƒ‰å˜ä½ã®é …ç›®ç®¡ç†ã¯ç…©é›‘ãªãŸã‚ã€å‹å¼ã‚³ãƒ¼ãƒ‰ã‚’ã€Œå‹å¼ã‚°ãƒ«ãƒ¼ãƒ—ã€ã«ç´ä»˜ã‘ã€ã‚°ãƒ«ãƒ¼ãƒ—å˜ä½ã§æ¤œæŸ»é …ç›®ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

- ã‚°ãƒ«ãƒ¼ãƒ—CRUD
  - POST `/v1/inspection/type-groups` â€” ä½œæˆ
  - GET `/v1/inspection/type-groups` â€” ä¸€è¦§ï¼ˆãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼‰
  - PUT `/v1/inspection/type-groups/{group_id}` â€” æ›´æ–°
  - DELETE `/v1/inspection/type-groups/{group_id}` â€” å‰Šé™¤
- ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ï¼ˆå‹å¼ã‚³ãƒ¼ãƒ‰ã®è¿½åŠ /å‰Šé™¤ï¼‰
  - POST `/v1/inspection/type-groups/{group_id}/members` â€” è¿½åŠ ï¼ˆbody: { product_code })
  - GET `/v1/inspection/type-groups/{group_id}/members` â€” ä¸€è¦§
  - DELETE `/v1/inspection/type-groups/{group_id}/members/{product_code}` â€” å‰Šé™¤

ã‚°ãƒ«ãƒ¼ãƒ—ã¨æ¤œæŸ»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆinspectionInstructionï¼‰ã®é–¢ä¿‚:
- `inspectionInstruction.group_id` ã«ã‚ˆã‚Šã€ã‚°ãƒ«ãƒ¼ãƒ—å˜ä½ã§æ¤œæŸ»é …ç›®ï¼ˆInspectionItemï¼‰ã‚’å®šç¾©ã§ãã‚‹ã€‚
- ç«¯æœ«ã‚¢ãƒ—ãƒªã‹ã‚‰è£½å“ã«å¯¾ã™ã‚‹æ¤œæŸ»é …ç›®å–å¾—æ™‚ã¯ã€ä»¥ä¸‹ã®é †ã§ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ã€‚
  1) `product_code` ãŒæ‰€å±ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ¢ç´¢ï¼ˆåŸºæº–ã¯ ProductMaster.`product_code`ï¼‰â†’ `inspectionInstruction.group_id` ãŒä¸€è‡´ã™ã‚‹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å„ªå…ˆ
  2) ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: `inspectionInstruction.product_code` â‰¡ è£½å“`product_code`ï¼ˆï¼ProductMaster.`product_code`ï¼‰
  3) ã•ã‚‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: `inspectionInstruction.product_code` â‰¡ `product.work_order_id`

### 14.2.1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹

1) ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆï¼ˆPOST /v1/inspection/type-groupsï¼‰
```
Request
{
  "name": "GROUP-A",
  "description": "ãƒ¢ãƒ‡ãƒ«Aæ´¾ç”Ÿç¾¤ã®æ¤œæŸ»è¨­å®š"
}

Response
{
  "id": "5f4c...",
  "name": "GROUP-A",
  "description": "ãƒ¢ãƒ‡ãƒ«Aæ´¾ç”Ÿç¾¤ã®æ¤œæŸ»è¨­å®š",
  "created_at": 1723756800000,
  "updated_at": 1723756800000,
  "created_by": "..."
}
```

2) ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ï¼ˆPOST /v1/inspection/type-groups/{group_id}/membersï¼‰
```
Request
{ "product_code": "MODEL-A1" }

Response
{
  "id": "9a71...",
  "group_id": "5f4c...",
  "product_code": "MODEL-A1",
  "created_at": 1723756800000
}
```

3) ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ï¼ˆGET /v1/inspection/type-groups?page=1&page_size=50ï¼‰
```
{
  "items": [ { "id": "5f4c...", "name": "GROUP-A", "description": "...", "created_at": 1723756800000, "updated_at": 1723756800000 } ],
  "total_count": 1,
  "page": 1,
  "page_size": 50,
  "total_pages": 1
}
```

4) ã‚°ãƒ«ãƒ¼ãƒ—ã¨æ¤œæŸ»æŒ‡ç¤ºã®è¨­å®šä¾‹ï¼ˆinspectionInstructionï¼‰
```
{
  "name": "ã‚°ãƒ«ãƒ¼ãƒ—Aå‘ã‘æ¤œæŸ»æŒ‡ç¤º",
  "group_id": "5f4c...",
  "group_name": "GROUP-A",
  "version": "1.0",
  "metadata": {}
}
```

ã“ã®è¨­å®šã«ã‚ˆã‚Šã€GROUP-Aã«å±ã™ã‚‹ä»»æ„ã® `product_code`ï¼ˆä¾‹: MODEL-A, MODEL-A1, MODEL-A2ï¼‰ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€å½“è©²ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ç´ã¥ã‘ã‚‰ã‚ŒãŸæ¤œæŸ»é …ç›®ãŒç«¯æœ«ã‚¢ãƒ—ãƒªã«é…ä¿¡ã•ã‚Œã‚‹ã€‚

## 14.3. æ¤œæŸ»ãƒã‚¹ã‚¿ APIï¼ˆå‹å¼ã‚°ãƒ«ãƒ¼ãƒ— + å·¥ç¨‹ï¼‰

### 14.3.1. è¿½åŠ  API
- å·¥ç¨‹ãƒã‚¹ã‚¿
  - `POST /v1/inspection/processes` â€¦ è¿½åŠ 
  - `GET /v1/inspection/processes` â€¦ ä¸€è¦§ï¼ˆæ¤œç´¢: process_code, process_nameï¼‰
  - `GET /v1/inspection/processes/{process_code}` â€¦ å–å¾—
  - `PUT /v1/inspection/processes/{process_code}` â€¦ æ›´æ–°
  - `DELETE /v1/inspection/processes/{process_code}` â€¦ å‰Šé™¤

### 14.3.2. å¤‰æ›´ APIï¼ˆæ¤œæŸ»ãƒã‚¹ã‚¿ï¼‰
- æ—§: `POST /v1/inspection/instructions`ï¼ˆbody ã« `product_code` or `group_id`ï¼‰
- æ–°: `POST /v1/inspection/instructions`ï¼ˆbody ã«å¿…é ˆ `group_id`, `process_code`ï¼‰
  - ä¾‹:
  ```json
  {
    "name": "å¤–è¦³æ¤œæŸ» v1",
    "group_id": "<uuid-of-group>",
    "process_code": "PRC-10",
    "version": "1.0",
    "metadata": {}
  }
  ```

- å–å¾—/ä¸€è¦§
  - `GET /v1/inspection/instructions?group_id=...&process_code=...&page=...`
  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ `group_id`, `process_code` ã‚’å«ã‚€

### 14.3.3. ãƒãƒƒãƒ”ãƒ³ã‚° API
- è£½å“ï¼‹å·¥ç¨‹ã‹ã‚‰æ¤œæŸ»é …ç›®ã‚’å–å¾—
  - æ—§: `GET /v1/inspection/products/{product_id}/items`
  - æ–°: `GET /v1/inspection/products/{product_id}/processes/{process_code}/items`
  - å‡¦ç†: product_id â†’ product_code â†’ group_id è§£æ±º â†’ (group_id, process_code) ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç‰¹å®š â†’ items è¿”å´

### 14.3.4. å‹å¼ã‚°ãƒ«ãƒ¼ãƒ— API æ‹¡å¼µ
- `product_code_groups`
  - è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: `group_code`ï¼ˆæ¤œç´¢/å‚ç…§ã«ä½¿ç”¨ï¼‰
  - `GET /v1/inspection/type-groups?group_code=...` ã§æ¤œç´¢å¯èƒ½ã«

### 14.3.5. å¾Œæ–¹äº’æ›
- å½“é¢ `product_code` ç›´ç´ä»˜ã‘ã‚’å—ã‘ä»˜ã‘ã‚‹ãŒã€ä½œæˆ/æ›´æ–°ã§ã®ä½¿ç”¨ã¯éæ¨å¥¨ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã‚‚ `group_id`/`process_code` ã‚’å„ªå…ˆè¡¨ç¤ºï¼‰
